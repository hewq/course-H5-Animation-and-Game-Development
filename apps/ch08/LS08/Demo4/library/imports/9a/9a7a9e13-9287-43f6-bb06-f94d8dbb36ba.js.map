{"version":3,"sources":["../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/particle/assets/frameworks/cocos2d-html5/cocos2d/particle/CCParticleBatchNode.js"],"names":["cc","PARTICLE_DEFAULT_CAPACITY","ParticleBatchNode","Node","extend","textureAtlas","_blendFunc","_className","ctor","fileImage","capacity","prototype","call","src","BLEND_SRC","dst","BLEND_DST","isString","init","Texture2D","initWithTexture","_createRenderCmd","_renderType","game","RENDER_TYPE_CANVAS","CanvasRenderCmd","WebGLRenderCmd","texture","TextureAtlas","_children","length","_renderCmd","_initWithTexture","initWithFile","tex","textureCache","addImage","visit","parent","cmd","parentCmd","_visible","_propagateFlagsDown","renderer","pushRenderCommand","_dirtyFlag","addChild","child","zOrder","tag","Error","ParticleSystem","zIndex","getTexture","childBlendFunc","getBlendFunc","setBlendFunc","log","pos","_addChildHelper","atlasIndex","p","getAtlasIndex","getTotalParticles","insertChild","setBatchNode","pSystem","index","totalParticles","locTextureAtlas","totalQuads","setAtlasIndex","getCapacity","_increaseAtlasCapacityTo","fillWithEmptyQuadsFromIndex","moveQuadsFromIndex","increaseTotalQuadsWith","_updateAllAtlasIndexes","removeChild","cleanup","indexOf","removeQuadsAtIndex","reorderChild","getIndexes","_getCurrentIndex","oldIndex","newIndex","splice","oldAtlasIndex","newAtlasIndex","locChildren","i","pNode","updateWithNoTime","_setLocalZOrder","removeChildAtIndex","doCleanup","removeAllChildren","removeAllQuads","disableParticle","particleIndex","quad","quads","br","vertices","x","y","tr","tl","bl","_setDirty","setTexture","locBlendFunc","hasPremultipliedAlpha","SRC_ALPHA","ONE_MINUS_SRC_ALPHA","undefined","BlendFunc","quantity","resizeCapacity","_searchNewPositionInChildrenForZ","z","count","foundCurrentIdx","foundNewIdx","minusOne","aTag","_running","_performRecursive","_stateCallbackType","onEnter","onEnterTransitionDidFinish","_updateBlendFunc","getTextureAtlas","setTextureAtlas","_p","defineGetterSetter","create"],"mappings":"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","file":"CCParticleBatchNode.js","sourceRoot":"../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/particle","sourcesContent":["/**\n * Copyright (c) 2008-2010 Ricardo Quesada\n * Copyright (c) 2011-2012 cocos2d-x.org\n * Copyright (c) 2013-2014 Chukong Technologies Inc.\n * Copyright (C) 2009 Matt Oswald\n * Copyright (c) 2011 Marco Tillemans\n *\n * http://www.cocos2d-x.org\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in\n * all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n * THE SOFTWARE.\n *\n */\n\n/**\n * paticle default capacity\n * @constant\n * @type Number\n */\ncc.PARTICLE_DEFAULT_CAPACITY = 500;\n\n/**\n * <p>\n *    cc.ParticleBatchNode is like a batch node: if it contains children, it will draw them in 1 single OpenGL call  <br/>\n *    (often known as \"batch draw\").  </br>\n *\n *    A cc.ParticleBatchNode can reference one and only one texture (one image file, one texture atlas).<br/>\n *    Only the cc.ParticleSystems that are contained in that texture can be added to the cc.SpriteBatchNode.<br/>\n *    All cc.ParticleSystems added to a cc.SpriteBatchNode are drawn in one OpenGL ES draw call.<br/>\n *    If the cc.ParticleSystems are not added to a cc.ParticleBatchNode then an OpenGL ES draw call will be needed for each one, which is less efficient.</br>\n *\n *    Limitations:<br/>\n *    - At the moment only cc.ParticleSystem is supported<br/>\n *    - All systems need to be drawn with the same parameters, blend function, aliasing, texture<br/>\n *\n *    Most efficient usage<br/>\n *    - Initialize the ParticleBatchNode with the texture and enough capacity for all the particle systems<br/>\n *    - Initialize all particle systems and add them as child to the batch node<br/>\n * </p>\n * @class\n * @extends cc.ParticleSystem\n * @param {String|cc.Texture2D} fileImage\n * @param {Number} capacity\n *\n * @property {cc.Texture2D|HTMLImageElement|HTMLCanvasElement}  texture         - The used texture\n * @property {cc.TextureAtlas}                                  textureAtlas    - The texture atlas used for drawing the quads\n *\n * @example\n * 1.\n * //Create a cc.ParticleBatchNode with image path  and capacity\n * var particleBatchNode = new cc.ParticleBatchNode(\"res/grossini_dance.png\",30);\n *\n * 2.\n * //Create a cc.ParticleBatchNode with a texture and capacity\n * var texture = cc.TextureCache.getInstance().addImage(\"res/grossini_dance.png\");\n * var particleBatchNode = new cc.ParticleBatchNode(texture, 30);\n */\ncc.ParticleBatchNode = cc.Node.extend(/** @lends cc.ParticleBatchNode# */{\n    textureAtlas: null,\n    //the blend function used for drawing the quads\n    _blendFunc: null,\n    _className: \"ParticleBatchNode\",\n\n    /**\n     * initializes the particle system with the name of a file on disk (for a list of supported formats look at the cc.Texture2D class), a capacity of particles\n     * Constructor of cc.ParticleBatchNode\n     * @param {String|cc.Texture2D} fileImage\n     * @param {Number} capacity\n     * @example\n     * 1.\n     * //Create a cc.ParticleBatchNode with image path  and capacity\n     * var particleBatchNode = new cc.ParticleBatchNode(\"res/grossini_dance.png\",30);\n     *\n     * 2.\n     * //Create a cc.ParticleBatchNode with a texture and capacity\n     * var texture = cc.TextureCache.getInstance().addImage(\"res/grossini_dance.png\");\n     * var particleBatchNode = new cc.ParticleBatchNode(texture, 30);\n     */\n    ctor: function (fileImage, capacity) {\n        cc.Node.prototype.ctor.call(this);\n        this._blendFunc = {src: cc.BLEND_SRC, dst: cc.BLEND_DST};\n        if (cc.isString(fileImage)) {\n            this.init(fileImage, capacity);\n        } else if (fileImage instanceof cc.Texture2D) {\n            this.initWithTexture(fileImage, capacity);\n        }\n    },\n\n    _createRenderCmd: function () {\n        if (cc._renderType === cc.game.RENDER_TYPE_CANVAS)\n            return new cc.ParticleBatchNode.CanvasRenderCmd(this);\n        else\n            return new cc.ParticleBatchNode.WebGLRenderCmd(this);\n    },\n\n    /**\n     * initializes the particle system with cc.Texture2D, a capacity of particles\n     * @param {cc.Texture2D|HTMLImageElement|HTMLCanvasElement} texture\n     * @param {Number} capacity\n     * @return {Boolean}\n     */\n    initWithTexture: function (texture, capacity) {\n        this.textureAtlas = new cc.TextureAtlas();\n        this.textureAtlas.initWithTexture(texture, capacity);\n\n        // no lazy alloc in this node\n        this._children.length = 0;\n\n        this._renderCmd._initWithTexture();\n        return true;\n    },\n\n    /**\n     * initializes the particle system with the name of a file on disk (for a list of supported formats look at the cc.Texture2D class), a capacity of particles\n     * @param {String} fileImage\n     * @param {Number} capacity\n     * @return {Boolean}\n     */\n    initWithFile: function (fileImage, capacity) {\n        var tex = cc.textureCache.addImage(fileImage);\n        return this.initWithTexture(tex, capacity);\n    },\n\n    /**\n     * initializes the particle system with the name of a file on disk (for a list of supported formats look at the cc.Texture2D class), a capacity of particles\n     * @param {String} fileImage\n     * @param {Number} capacity\n     * @return {Boolean}\n     */\n    init: function (fileImage, capacity) {\n        var tex = cc.textureCache.addImage(fileImage);\n        return this.initWithTexture(tex, capacity);\n    },\n\n    visit: function (parent) {\n        var cmd = this._renderCmd, parentCmd = parent ? parent._renderCmd : null;\n\n        // quick return if not visible\n        if (!this._visible) {\n            cmd._propagateFlagsDown(parentCmd);\n            return;\n        }\n\n        cmd.visit(parentCmd);\n        cc.renderer.pushRenderCommand(cmd);\n        cmd._dirtyFlag = 0;\n    },\n\n    /**\n     * Add a child into the cc.ParticleBatchNode\n     * @param {cc.ParticleSystem} child\n     * @param {Number} zOrder\n     * @param {Number} tag\n     */\n    addChild: function (child, zOrder, tag) {\n        if (!child)\n            throw new Error(\"cc.ParticleBatchNode.addChild() : child should be non-null\");\n        if (!(child instanceof cc.ParticleSystem))\n            throw new Error(\"cc.ParticleBatchNode.addChild() : only supports cc.ParticleSystem as children\");\n        zOrder = (zOrder == null) ? child.zIndex : zOrder;\n        tag = (tag == null) ? child.tag : tag;\n\n        if (child.getTexture() !== this.textureAtlas.texture)\n            throw new Error(\"cc.ParticleSystem.addChild() : the child is not using the same texture id\");\n\n        // If this is the 1st children, then copy blending function\n        var childBlendFunc = child.getBlendFunc();\n        if (this._children.length === 0)\n            this.setBlendFunc(childBlendFunc);\n        else {\n            if ((childBlendFunc.src !== this._blendFunc.src) || (childBlendFunc.dst !== this._blendFunc.dst)) {\n                cc.log(\"cc.ParticleSystem.addChild() : Can't add a ParticleSystem that uses a different blending function\");\n                return;\n            }\n        }\n\n        //no lazy sorting, so don't call super addChild, call helper instead\n        var pos = this._addChildHelper(child, zOrder, tag);\n\n        //get new atlasIndex\n        var atlasIndex = 0;\n\n        if (pos !== 0) {\n            var p = this._children[pos - 1];\n            atlasIndex = p.getAtlasIndex() + p.getTotalParticles();\n        } else\n            atlasIndex = 0;\n\n        this.insertChild(child, atlasIndex);\n\n        // update quad info\n        child.setBatchNode(this);\n    },\n\n    /**\n     * Inserts a child into the cc.ParticleBatchNode\n     * @param {cc.ParticleSystem} pSystem\n     * @param {Number} index\n     */\n    insertChild: function (pSystem, index) {\n        var totalParticles = pSystem.getTotalParticles();\n        var locTextureAtlas = this.textureAtlas;\n        var totalQuads = locTextureAtlas.totalQuads;\n        pSystem.setAtlasIndex(index);\n        if (totalQuads + totalParticles > locTextureAtlas.getCapacity()) {\n            this._increaseAtlasCapacityTo(totalQuads + totalParticles);\n            // after a realloc empty quads of textureAtlas can be filled with gibberish (realloc doesn't perform calloc), insert empty quads to prevent it\n            locTextureAtlas.fillWithEmptyQuadsFromIndex(locTextureAtlas.getCapacity() - totalParticles, totalParticles);\n        }\n\n        // make room for quads, not necessary for last child\n        if (pSystem.getAtlasIndex() + totalParticles !== totalQuads)\n            locTextureAtlas.moveQuadsFromIndex(index, index + totalParticles);\n\n        // increase totalParticles here for new particles, update method of particlesystem will fill the quads\n        locTextureAtlas.increaseTotalQuadsWith(totalParticles);\n        this._updateAllAtlasIndexes();\n    },\n\n    /**\n     * @param {cc.ParticleSystem} child\n     * @param {Boolean} cleanup\n     */\n    removeChild: function (child, cleanup) {\n        // explicit nil handling\n        if (child == null)\n            return;\n\n        if (!(child instanceof cc.ParticleSystem))\n            throw new Error(\"cc.ParticleBatchNode.removeChild(): only supports cc.ParticleSystem as children\");\n        if (this._children.indexOf(child) === -1) {\n            cc.log(\"cc.ParticleBatchNode.removeChild(): doesn't contain the sprite. Can't remove it\");\n            return;\n        }\n\n        cc.Node.prototype.removeChild.call(this, child, cleanup);\n\n        var locTextureAtlas = this.textureAtlas;\n        // remove child helper\n        locTextureAtlas.removeQuadsAtIndex(child.getAtlasIndex(), child.getTotalParticles());\n\n        // after memmove of data, empty the quads at the end of array\n        locTextureAtlas.fillWithEmptyQuadsFromIndex(locTextureAtlas.totalQuads, child.getTotalParticles());\n\n        // paticle could be reused for self rendering\n        child.setBatchNode(null);\n\n        this._updateAllAtlasIndexes();\n    },\n\n    /**\n     * Reorder will be done in this function, no \"lazy\" reorder to particles\n     * @param {cc.ParticleSystem} child\n     * @param {Number} zOrder\n     */\n    reorderChild: function (child, zOrder) {\n        if (!child)\n            throw new Error(\"cc.ParticleBatchNode.reorderChild(): child should be non-null\");\n        if (!(child instanceof cc.ParticleSystem))\n            throw new Error(\"cc.ParticleBatchNode.reorderChild(): only supports cc.QuadParticleSystems as children\");\n        if (this._children.indexOf(child) === -1) {\n            cc.log(\"cc.ParticleBatchNode.reorderChild(): Child doesn't belong to batch\");\n            return;\n        }\n\n        // no reordering if only 1 child\n        if (this._children.length > 1) {\n            var getIndexes = this._getCurrentIndex(child, zOrder);\n\n            if (getIndexes.oldIndex !== getIndexes.newIndex) {\n                // reorder m_pChildren.array\n                this._children.splice(getIndexes.oldIndex, 1)\n                this._children.splice(getIndexes.newIndex, 0, child);\n\n                // save old altasIndex\n                var oldAtlasIndex = child.getAtlasIndex();\n\n                // update atlas index\n                this._updateAllAtlasIndexes();\n\n                // Find new AtlasIndex\n                var newAtlasIndex = 0;\n                var locChildren = this._children;\n                for (var i = 0; i < locChildren.length; i++) {\n                    var pNode = locChildren[i];\n                    if (pNode === child) {\n                        newAtlasIndex = child.getAtlasIndex();\n                        break;\n                    }\n                }\n\n                // reorder textureAtlas quads\n                this.textureAtlas.moveQuadsFromIndex(oldAtlasIndex, child.getTotalParticles(), newAtlasIndex);\n\n                child.updateWithNoTime();\n            }\n        }\n        child._setLocalZOrder(zOrder);\n    },\n\n    /**\n     * @param {Number} index\n     * @param {Boolean} doCleanup\n     */\n    removeChildAtIndex: function (index, doCleanup) {\n        this.removeChild(this._children[i], doCleanup);\n    },\n\n    /**\n     * @param {Boolean} [doCleanup=true]\n     */\n    removeAllChildren: function (doCleanup) {\n        var locChildren = this._children;\n        for (var i = 0; i < locChildren.length; i++) {\n            locChildren[i].setBatchNode(null);\n        }\n        cc.Node.prototype.removeAllChildren.call(this, doCleanup);\n        this.textureAtlas.removeAllQuads();\n    },\n\n    /**\n     * disables a particle by inserting a 0'd quad into the texture atlas\n     * @param {Number} particleIndex\n     */\n    disableParticle: function (particleIndex) {\n        var quad = this.textureAtlas.quads[particleIndex];\n        quad.br.vertices.x = quad.br.vertices.y = quad.tr.vertices.x = quad.tr.vertices.y =\n            quad.tl.vertices.x = quad.tl.vertices.y = quad.bl.vertices.x = quad.bl.vertices.y = 0.0;\n        this.textureAtlas._setDirty(true);\n    },\n\n    /**\n     * returns the used texture\n     * @return {cc.Texture2D}\n     */\n    getTexture: function () {\n        return this.textureAtlas.texture;\n    },\n\n    /**\n     * sets a new texture. it will be retained\n     * @param {cc.Texture2D} texture\n     */\n    setTexture: function (texture) {\n        this.textureAtlas.texture = texture;\n\n        // If the new texture has No premultiplied alpha, AND the blendFunc hasn't been changed, then update it\n        var locBlendFunc = this._blendFunc;\n        if (texture && !texture.hasPremultipliedAlpha() && ( locBlendFunc.src === cc.BLEND_SRC && locBlendFunc.dst === cc.BLEND_DST )) {\n            locBlendFunc.src = cc.SRC_ALPHA;\n            locBlendFunc.dst = cc.ONE_MINUS_SRC_ALPHA;\n        }\n    },\n\n    /**\n     * set the blending function used for the texture\n     * @param {Number|Object} src\n     * @param {Number} dst\n     */\n    setBlendFunc: function (src, dst) {\n        if (dst === undefined) {\n            this._blendFunc.src = src.src;\n            this._blendFunc.dst = src.dst;\n        } else {\n            this._blendFunc.src = src;\n            this._blendFunc.src = dst;\n        }\n    },\n\n    /**\n     * returns the blending function used for the texture\n     * @return {cc.BlendFunc}\n     */\n    getBlendFunc: function () {\n        return new cc.BlendFunc(this._blendFunc.src, this._blendFunc.dst);\n    },\n\n    _updateAllAtlasIndexes: function () {\n        var index = 0;\n        var locChildren = this._children;\n        for (var i = 0; i < locChildren.length; i++) {\n            var child = locChildren[i];\n            child.setAtlasIndex(index);\n            index += child.getTotalParticles();\n        }\n    },\n\n    _increaseAtlasCapacityTo: function (quantity) {\n        cc.log(\"cocos2d: cc.ParticleBatchNode: resizing TextureAtlas capacity from [\" + this.textureAtlas.getCapacity()\n            + \"] to [\" + quantity + \"].\");\n\n        if (!this.textureAtlas.resizeCapacity(quantity)) {\n            // serious problems\n            cc.log(\"cc.ParticleBatchNode._increaseAtlasCapacityTo() : WARNING: Not enough memory to resize the atlas\");\n        }\n    },\n\n    _searchNewPositionInChildrenForZ: function (z) {\n        var locChildren = this._children;\n        var count = locChildren.length;\n        for (var i = 0; i < count; i++) {\n            if (locChildren[i].zIndex > z)\n                return i;\n        }\n        return count;\n    },\n\n    _getCurrentIndex: function (child, z) {\n        var foundCurrentIdx = false;\n        var foundNewIdx = false;\n\n        var newIndex = 0;\n        var oldIndex = 0;\n\n        var minusOne = 0, locChildren = this._children;\n        var count = locChildren.length;\n        for (var i = 0; i < count; i++) {\n            var pNode = locChildren[i];\n            // new index\n            if (pNode.zIndex > z && !foundNewIdx) {\n                newIndex = i;\n                foundNewIdx = true;\n\n                if (foundCurrentIdx && foundNewIdx)\n                    break;\n            }\n            // current index\n            if (child === pNode) {\n                oldIndex = i;\n                foundCurrentIdx = true;\n                if (!foundNewIdx)\n                    minusOne = -1;\n                if (foundCurrentIdx && foundNewIdx)\n                    break;\n            }\n        }\n        if (!foundNewIdx)\n            newIndex = count;\n        newIndex += minusOne;\n        return {newIndex: newIndex, oldIndex: oldIndex};\n    },\n\n    //\n    // <p>\n    //     don't use lazy sorting, reordering the particle systems quads afterwards would be too complex                                    <br/>\n    //     XXX research whether lazy sorting + freeing current quads and calloc a new block with size of capacity would be faster           <br/>\n    //     XXX or possibly using vertexZ for reordering, that would be fastest                                                              <br/>\n    //     this helper is almost equivalent to CCNode's addChild, but doesn't make use of the lazy sorting                                  <br/>\n    // </p>\n    // @param {cc.ParticleSystem} child\n    // @param {Number} z\n    // @param {Number} aTag\n    // @return {Number}\n    // @private\n    //\n    _addChildHelper: function (child, z, aTag) {\n        if (!child)\n            throw new Error(\"cc.ParticleBatchNode._addChildHelper(): child should be non-null\");\n        if (child.parent) {\n            cc.log(\"cc.ParticleBatchNode._addChildHelper(): child already added. It can't be added again\");\n            return null;\n        }\n\n\n        if (!this._children)\n            this._children = [];\n\n        //don't use a lazy insert\n        var pos = this._searchNewPositionInChildrenForZ(z);\n\n        this._children.splice(pos, 0, child);\n        child.tag = aTag;\n        child._setLocalZOrder(z);\n        child.parent = this;\n        if (this._running) {\n            child._performRecursive(cc.Node._stateCallbackType.onEnter);\n            child._performRecursive(cc.Node._stateCallbackType.onEnterTransitionDidFinish);\n        }\n        return pos;\n    },\n\n    _updateBlendFunc: function () {\n        if (!this.textureAtlas.texture.hasPremultipliedAlpha()) {\n            this._blendFunc.src = cc.SRC_ALPHA;\n            this._blendFunc.dst = cc.ONE_MINUS_SRC_ALPHA;\n        }\n    },\n\n    /**\n     * return the texture atlas used for drawing the quads\n     * @return {cc.TextureAtlas}\n     */\n    getTextureAtlas: function () {\n        return this.textureAtlas;\n    },\n\n    /**\n     * set the texture atlas used for drawing the quads\n     * @param {cc.TextureAtlas} textureAtlas\n     */\n    setTextureAtlas: function (textureAtlas) {\n        this.textureAtlas = textureAtlas;\n    }\n});\n\nvar _p = cc.ParticleBatchNode.prototype;\n\n// Extended properties\n/** @expose */\n_p.texture;\ncc.defineGetterSetter(_p, \"texture\", _p.getTexture, _p.setTexture);\n\n\n/**\n * initializes the particle system with the name of a file on disk (for a list of supported formats look at the cc.Texture2D class), a capacity of particles\n * @deprecated since v3.0 please use new cc.ParticleBatchNode(filename, capacity) instead.\n * @param {String|cc.Texture2D} fileImage\n * @param {Number} capacity\n * @return {cc.ParticleBatchNode}\n */\ncc.ParticleBatchNode.create = function (fileImage, capacity) {\n    return new cc.ParticleBatchNode(fileImage, capacity);\n};\n"]}