{"version":3,"sources":["../../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/core/renderer/assets/frameworks/cocos2d-html5/cocos2d/core/renderer/RendererWebGL.js"],"names":["cc","rendererWebGL","_batchedInfo","texture","blendSrc","blendDst","glProgramState","_batchBroken","_indexBuffer","_vertexBuffer","_maxVertexSize","_batchingSize","_indexSize","_sizePerVertex","_vertexData","_vertexDataSize","_vertexDataF32","_vertexDataUI32","_indexData","_prevIndexSize","_pureQuad","_IS_IOS","updateBuffer","numVertex","gl","_renderContext","indexCount","Math","ceil","bindBuffer","ELEMENT_ARRAY_BUFFER","Uint16Array","currentQuad","i","len","bufferData","DYNAMIC_DRAW","byteLength","ArrayBuffer","Float32Array","Uint32Array","ARRAY_BUFFER","initQuadBuffer","createBuffer","VertexType","QUAD","TRIANGLE","CUSTOM","mat4Identity","childrenOrderDirty","assignedZ","assignedZStep","_transformNodePool","_renderCmds","_isCacheToBufferOn","_cacheToBufferCmds","_cacheInstanceIds","_currentID","_clearColor","color","init","disable","CULL_FACE","DEPTH_TEST","math","Matrix4","identity","BATCH_VERTEX_COUNT","sys","os","OS_IOS","getVertexSize","getRenderCmd","renderableObject","_createRenderCmd","_turnToCacheMode","renderTextureID","length","indexOf","push","_turnToNormalMode","_removeCache","instanceID","cmds","locIDs","arrayRemoveObject","_renderingToBuffer","renderTextureId","locCmds","ctx","rendering","resetFlag","transform","locPool","sort","_sortNodeByLevelAsc","cmd","updateStatus","transformDirty","n1","n2","_curLevel","pushDirtyNode","node","clearRenderCommands","clear","clearColor","r","g","b","a","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","setDepthTest","enable","clearDepth","depthFunc","LEQUAL","pushRenderCommand","uploadData","currentId","locCmdBuffer","cmdList","_increaseBatchingSize","increment","vertexType","indices","curr","_updateBatchedInfo","blendFunc","src","dst","_batchRendering","_breakBatch","_uploadBufferData","_node","_texture","_spriteFrame","_blendFunc","_glProgramState","uploadAll","apply","getGLProgram","_updateProjectionUniform","glBlendFunc","glBindTexture2DN","view","subarray","enableVertexAttribArray","VERTEX_ATTRIB_POSITION","VERTEX_ATTRIB_COLOR","VERTEX_ATTRIB_TEX_COORDS","vertexAttribPointer","FLOAT","UNSIGNED_BYTE","drawElements","TRIANGLES","UNSIGNED_SHORT","g_NumberOfDraws","context","needDraw"],"mappings":"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","file":"RendererWebGL.js","sourceRoot":"../../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/core/renderer","sourcesContent":["/****************************************************************************\n Copyright (c) 2013-2016 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\ncc.rendererWebGL = (function () {\n\n// Internal variables\n    // Batching general informations\nvar _batchedInfo = {\n        // The batched texture, all batching element should have the same texture\n        texture: null,\n        // The batched blend source, all batching element should have the same blend source\n        blendSrc: null,\n        // The batched blend destination, all batching element should have the same blend destination\n        blendDst: null,\n        // The batched gl program state, all batching element should have the same state\n        glProgramState: null\n    },\n\n    _batchBroken = false,\n    _indexBuffer = null,\n    _vertexBuffer = null,\n    // Total vertex size\n    _maxVertexSize = 0,\n    // Current batching vertex size\n    _batchingSize = 0,\n    // Current batching index size\n    _indexSize = 0,\n    // Float size per vertex\n    _sizePerVertex = 6,\n    // buffer data and views\n    _vertexData = null,\n    _vertexDataSize = 0,\n    _vertexDataF32 = null,\n    _vertexDataUI32 = null,\n    _indexData = null,\n    _prevIndexSize = 0,\n    _pureQuad = true,\n    _IS_IOS = false;\n\n\n// Inspired from @Heishe's gotta-batch-them-all branch\n// https://github.com/Talisca/cocos2d-html5/commit/de731f16414eb9bcaa20480006897ca6576d362c\nfunction updateBuffer (numVertex) {\n    var gl = cc._renderContext;\n    // Update index buffer size\n    if (_indexBuffer) {\n        var indexCount = Math.ceil(numVertex / 4) * 6;\n        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, _indexBuffer);\n        _indexData = new Uint16Array(indexCount);\n        var currentQuad = 0;\n        for (var i = 0, len = indexCount; i < len; i += 6) {\n            _indexData[i] = currentQuad + 0;\n            _indexData[i + 1] = currentQuad + 1;\n            _indexData[i + 2] = currentQuad + 2;\n            _indexData[i + 3] = currentQuad + 1;\n            _indexData[i + 4] = currentQuad + 2;\n            _indexData[i + 5] = currentQuad + 3;\n            currentQuad += 4;\n        }\n        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, _indexData, gl.DYNAMIC_DRAW);\n    }\n    // Update vertex buffer size\n    if (_vertexBuffer) {\n        _vertexDataSize = numVertex * _sizePerVertex;\n        var byteLength = _vertexDataSize * 4;\n        _vertexData = new ArrayBuffer(byteLength);\n        _vertexDataF32 = new Float32Array(_vertexData);\n        _vertexDataUI32 = new Uint32Array(_vertexData);\n        // Init buffer data\n        gl.bindBuffer(gl.ARRAY_BUFFER, _vertexBuffer);\n        gl.bufferData(gl.ARRAY_BUFFER, _vertexDataF32, gl.DYNAMIC_DRAW);\n    }\n    // Downsize by 200 to avoid vertex data overflow\n    _maxVertexSize = numVertex - 200;\n}\n\n// Inspired from @Heishe's gotta-batch-them-all branch\n// https://github.com/Talisca/cocos2d-html5/commit/de731f16414eb9bcaa20480006897ca6576d362c\nfunction initQuadBuffer (numVertex) {\n    var gl = cc._renderContext;\n    if (_indexBuffer === null) {\n        // TODO do user need to release the memory ?\n        _vertexBuffer = gl.createBuffer();\n        _indexBuffer = gl.createBuffer();\n    }\n    updateBuffer(numVertex);\n}\n\nvar VertexType = {\n    QUAD : 0,\n    TRIANGLE : 1,\n    CUSTOM: 2\n};\n\nreturn {\n    mat4Identity: null,\n\n    childrenOrderDirty: true,\n    assignedZ: 0,\n    assignedZStep: 1 / 100,\n\n    VertexType: VertexType,\n\n    _transformNodePool: [],                              //save nodes transform dirty\n    _renderCmds: [],                                     //save renderer commands\n\n    _isCacheToBufferOn: false,                          //a switch that whether cache the rendererCmd to cacheToCanvasCmds\n    _cacheToBufferCmds: {},                              // an array saves the renderer commands need for cache to other canvas\n    _cacheInstanceIds: [],\n    _currentID: 0,\n    _clearColor: cc.color(0, 0, 0, 255),              //background color,default BLACK\n\n    init: function () {\n        var gl = cc._renderContext;\n        gl.disable(gl.CULL_FACE);\n        gl.disable(gl.DEPTH_TEST);\n\n        this.mat4Identity = new cc.math.Matrix4();\n        this.mat4Identity.identity();\n        initQuadBuffer(cc.BATCH_VERTEX_COUNT);\n        if (cc.sys.os === cc.sys.OS_IOS) {\n            _IS_IOS = true;\n        }\n    },\n\n    getVertexSize: function () {\n        return _maxVertexSize;\n    },\n\n    getRenderCmd: function (renderableObject) {\n        //TODO Add renderCmd pool here\n        return renderableObject._createRenderCmd();\n    },\n\n    _turnToCacheMode: function (renderTextureID) {\n        this._isCacheToBufferOn = true;\n        renderTextureID = renderTextureID || 0;\n        if (!this._cacheToBufferCmds[renderTextureID]) {\n            this._cacheToBufferCmds[renderTextureID] = [];\n        }\n        else {\n            this._cacheToBufferCmds[renderTextureID].length = 0;\n        }\n        if (this._cacheInstanceIds.indexOf(renderTextureID) === -1) {\n            this._cacheInstanceIds.push(renderTextureID);\n        }\n        this._currentID = renderTextureID;\n    },\n\n    _turnToNormalMode: function () {\n        this._isCacheToBufferOn = false;\n    },\n\n    _removeCache: function (instanceID) {\n        instanceID = instanceID || this._currentID;\n        var cmds = this._cacheToBufferCmds[instanceID];\n        if (cmds) {\n            cmds.length = 0;\n            delete this._cacheToBufferCmds[instanceID];\n        }\n\n        var locIDs = this._cacheInstanceIds;\n        cc.arrayRemoveObject(locIDs, instanceID);\n    },\n\n    /**\n     * drawing all renderer command to cache canvas' context\n     * @param {Number} [renderTextureId]\n     */\n    _renderingToBuffer: function (renderTextureId) {\n        renderTextureId = renderTextureId || this._currentID;\n        var locCmds = this._cacheToBufferCmds[renderTextureId];\n        var ctx = cc._renderContext;\n        this.rendering(ctx, locCmds);\n        this._removeCache(renderTextureId);\n\n        var locIDs = this._cacheInstanceIds;\n        if (locIDs.length === 0)\n            this._isCacheToBufferOn = false;\n        else\n            this._currentID = locIDs[locIDs.length - 1];\n    },\n\n    //reset renderer's flag\n    resetFlag: function () {\n        if (this.childrenOrderDirty) {\n            this.childrenOrderDirty = false;\n        }\n        this._transformNodePool.length = 0;\n    },\n\n    //update the transform data\n    transform: function () {\n        var locPool = this._transformNodePool;\n        //sort the pool\n        locPool.sort(this._sortNodeByLevelAsc);\n        //transform node\n        var i, len, cmd;\n        for (i = 0, len = locPool.length; i < len; i++) {\n            cmd = locPool[i];\n            cmd.updateStatus();\n        }\n        locPool.length = 0;\n    },\n\n    transformDirty: function () {\n        return this._transformNodePool.length > 0;\n    },\n\n    _sortNodeByLevelAsc: function (n1, n2) {\n        return n1._curLevel - n2._curLevel;\n    },\n\n    pushDirtyNode: function (node) {\n        //if (this._transformNodePool.indexOf(node) === -1)\n        this._transformNodePool.push(node);\n    },\n\n    clearRenderCommands: function () {\n        // Copy previous command list for late check in rendering\n        this._renderCmds.length = 0;\n    },\n\n    clear: function () {\n        var gl = cc._renderContext;\n        gl.clearColor(this._clearColor.r / 255, this._clearColor.g / 255, this._clearColor.b / 255, this._clearColor.a / 255);\n        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n    },\n\n    setDepthTest: function (enable) {\n        var gl = cc._renderContext;\n        if (enable) {\n            gl.clearDepth(1.0);\n            gl.enable(gl.DEPTH_TEST);\n            gl.depthFunc(gl.LEQUAL);\n        }\n        else {\n            gl.disable(gl.DEPTH_TEST);\n        }\n    },\n    \n    pushRenderCommand: function (cmd) {\n        if (!cmd.rendering && !cmd.uploadData)\n            return;\n        if (this._isCacheToBufferOn) {\n            var currentId = this._currentID, locCmdBuffer = this._cacheToBufferCmds;\n            var cmdList = locCmdBuffer[currentId];\n            if (cmdList.indexOf(cmd) === -1)\n                cmdList.push(cmd);\n        } else {\n            if (this._renderCmds.indexOf(cmd) === -1) {\n                this._renderCmds.push(cmd);\n            }\n        }\n    },\n\n    _increaseBatchingSize: function (increment, vertexType, indices) {\n        vertexType = vertexType || VertexType.QUAD;\n        var i, curr;\n        switch (vertexType) {\n        case VertexType.QUAD:\n            for (i = 0; i < increment; i += 4) {\n                curr = _batchingSize + i;\n                _indexData[_indexSize++] = curr + 0;\n                _indexData[_indexSize++] = curr + 1;\n                _indexData[_indexSize++] = curr + 2;\n                _indexData[_indexSize++] = curr + 1;\n                _indexData[_indexSize++] = curr + 2;\n                _indexData[_indexSize++] = curr + 3;\n            }\n            break;\n        case VertexType.TRIANGLE:\n            _pureQuad = false;\n            for (i = 0; i < increment; i += 3) {\n                curr = _batchingSize + i;\n                _indexData[_indexSize++] = curr + 0;\n                _indexData[_indexSize++] = curr + 1;\n                _indexData[_indexSize++] = curr + 2;\n            }\n            break;\n        case VertexType.CUSTOM:\n            // CUSTOM type increase the indices data\n            _pureQuad = false;\n            var len = indices.length;\n            for (i = 0; i < len; i++) {\n                _indexData[_indexSize++] = _batchingSize + indices[i];\n            }\n            break;\n        default:\n            return;\n        }\n        _batchingSize += increment;\n    },\n\n    _updateBatchedInfo: function (texture, blendFunc, glProgramState) {\n        if (texture !== _batchedInfo.texture ||\n            blendFunc.src !== _batchedInfo.blendSrc ||\n            blendFunc.dst !== _batchedInfo.blendDst ||\n            glProgramState !== _batchedInfo.glProgramState) {\n            // Draw batched elements\n            this._batchRendering();\n            // Update _batchedInfo\n            _batchedInfo.texture = texture;\n            _batchedInfo.blendSrc = blendFunc.src;\n            _batchedInfo.blendDst = blendFunc.dst;\n            _batchedInfo.glProgramState = glProgramState;\n\n            return true;\n        }\n        else {\n            return false;\n        }\n    },\n\n    _breakBatch: function () {\n        _batchBroken = true;\n    },\n\n    _uploadBufferData: function (cmd) {\n        if (_batchingSize >= _maxVertexSize) {\n            this._batchRendering();\n        }\n\n        // Check batching\n        var node = cmd._node;\n        var texture = node._texture || (node._spriteFrame && node._spriteFrame._texture);\n        var blendSrc = node._blendFunc.src;\n        var blendDst = node._blendFunc.dst;\n        var glProgramState = cmd._glProgramState;\n        if (_batchBroken ||\n            _batchedInfo.texture !== texture ||\n            _batchedInfo.blendSrc !== blendSrc ||\n            _batchedInfo.blendDst !== blendDst ||\n            _batchedInfo.glProgramState !== glProgramState) {\n            // Draw batched elements\n            this._batchRendering();\n            // Update _batchedInfo\n            _batchedInfo.texture = texture;\n            _batchedInfo.blendSrc = blendSrc;\n            _batchedInfo.blendDst = blendDst;\n            _batchedInfo.glProgramState = glProgramState;\n            _batchBroken = false;\n        }\n\n        // Upload vertex data\n        var len = cmd.uploadData(_vertexDataF32, _vertexDataUI32, _batchingSize * _sizePerVertex);\n        if (len > 0) {\n            this._increaseBatchingSize(len, cmd.vertexType);\n        }\n    },\n\n    _batchRendering: function () {\n        if (_batchingSize === 0 || !_batchedInfo.texture) {\n            return;\n        }\n\n        var gl = cc._renderContext;\n        var texture = _batchedInfo.texture;\n        var glProgramState = _batchedInfo.glProgramState;\n        var uploadAll = _batchingSize > _maxVertexSize * 0.5;\n\n        if (glProgramState) {\n            glProgramState.apply();\n            glProgramState.getGLProgram()._updateProjectionUniform();\n        }\n\n        cc.glBlendFunc(_batchedInfo.blendSrc, _batchedInfo.blendDst);\n        cc.glBindTexture2DN(0, texture);                   // = cc.glBindTexture2D(texture);\n\n        gl.bindBuffer(gl.ARRAY_BUFFER, _vertexBuffer);\n        // upload the vertex data to the gl buffer\n        if (uploadAll) {\n            gl.bufferData(gl.ARRAY_BUFFER, _vertexDataF32, gl.DYNAMIC_DRAW);\n        }\n        else {\n            var view = _vertexDataF32.subarray(0, _batchingSize * _sizePerVertex);\n            gl.bufferData(gl.ARRAY_BUFFER, view, gl.DYNAMIC_DRAW);\n        }\n\n        gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_POSITION);\n        gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_COLOR);\n        gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_TEX_COORDS);\n        gl.vertexAttribPointer(cc.VERTEX_ATTRIB_POSITION, 3, gl.FLOAT, false, 24, 0);\n        gl.vertexAttribPointer(cc.VERTEX_ATTRIB_COLOR, 4, gl.UNSIGNED_BYTE, true, 24, 12);\n        gl.vertexAttribPointer(cc.VERTEX_ATTRIB_TEX_COORDS, 2, gl.FLOAT, false, 24, 16);\n\n        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, _indexBuffer);\n        if (!_prevIndexSize || !_pureQuad || _indexSize > _prevIndexSize) {\n            if (uploadAll) {\n                gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, _indexData, gl.DYNAMIC_DRAW);\n            }\n            else {\n                gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, _indexData.subarray(0, _indexSize), gl.DYNAMIC_DRAW);\n            }\n        }\n        gl.drawElements(gl.TRIANGLES, _indexSize, gl.UNSIGNED_SHORT, 0);\n\n        cc.g_NumberOfDraws++;\n\n        if (_pureQuad) {\n            _prevIndexSize = _indexSize;\n        }\n        else {\n            _prevIndexSize = 0;\n            _pureQuad = true;\n        }\n        _batchingSize = 0;\n        _indexSize = 0;\n    },\n\n    /**\n     * drawing all renderer command to context (default is cc._renderContext)\n     * @param {WebGLRenderingContext} [ctx=cc._renderContext]\n     */\n    rendering: function (ctx, cmds) {\n        var locCmds = cmds || this._renderCmds,\n            i, len, cmd,\n            context = ctx || cc._renderContext;\n\n        // Reset buffer for rendering\n        context.bindBuffer(gl.ARRAY_BUFFER, null);\n\n        for (i = 0, len = locCmds.length; i < len; ++i) {\n            cmd = locCmds[i];\n            if (!cmd.needDraw()) continue;\n\n            if (cmd.uploadData) {\n                this._uploadBufferData(cmd);\n            }\n            else {\n                if (_batchingSize > 0) {\n                    this._batchRendering();\n                }\n                cmd.rendering(context);\n            }\n        }\n        this._batchRendering();\n        _batchedInfo.texture = null;\n    }\n};\n})();\n"]}