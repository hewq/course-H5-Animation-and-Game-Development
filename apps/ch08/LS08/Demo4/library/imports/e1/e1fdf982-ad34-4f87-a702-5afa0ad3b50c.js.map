{"version":3,"sources":["../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/particle/assets/frameworks/cocos2d-html5/cocos2d/particle/CCParticleSystemCanvasRenderCmd.js"],"names":["cc","ParticleSystem","CanvasRenderCmd","renderable","_rootCtor","_needDraw","_drawMode","TEXTURE_MODE","_shapeType","BALL_SHAPE","_pointRect","rect","_tintCache","proto","prototype","Object","create","Node","constructor","getDrawMode","setDrawMode","drawMode","getShapeType","setShapeType","shapeType","setBatchNode","batchNode","_batchNode","_node","updateQuadWithParticle","particle","newPosition","updateParticlePosition","position","pIn","drawPos","rendering","ctx","scaleX","scaleY","wrapper","_renderContext","context","getContext","node","pointRect","setTransform","_worldTransform","save","isBlendAdditive","globalCompositeOperation","i","lpx","alpha","particleCount","particles","_particles","SHAPE_MODE","_texture","_textureLoaded","restore","element","getHtmlElementObj","width","height","drawElement","size","color","a","globalAlpha","translate","x","y","Math","floor","w","h","scale","max","rotation","rotate","degreesToRadians","isChangeColor","_changeTextureColor","drawImage","drawTool","_drawingUtil","STAR_SHAPE","drawStar","drawColorBall","g_NumberOfDraws","texture","document","createElement","tintCache","textureContentSize","getContentSize","_generateColorTexture","r","g","b","initTexCoordsWithRect","setTotalParticles","tp","_totalParticles","addParticle","length","Particle","push","_setupVBO","_allocMemory","postStep","_setBlendAdditive","locBlendFunc","_blendFunc","src","BLEND_SRC","dst","BLEND_DST","_initWithTotalParticles","totalParticles","_updateDeltaColor","selParticle","dt","_dontTint","deltaColor"],"mappings":"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","file":"CCParticleSystemCanvasRenderCmd.js","sourceRoot":"../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/particle","sourcesContent":["/****************************************************************************\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\n/**\n * ParticleSystem's canvas render command\n */\n(function () {\n    cc.ParticleSystem.CanvasRenderCmd = function (renderable) {\n        this._rootCtor(renderable);\n        this._needDraw = true;\n\n        this._drawMode = cc.ParticleSystem.TEXTURE_MODE;\n        this._shapeType = cc.ParticleSystem.BALL_SHAPE;\n\n        this._pointRect = cc.rect(0, 0, 0, 0);\n        this._tintCache = null;\n    };\n    var proto = cc.ParticleSystem.CanvasRenderCmd.prototype = Object.create(cc.Node.CanvasRenderCmd.prototype);\n    proto.constructor = cc.ParticleSystem.CanvasRenderCmd;\n\n    proto.getDrawMode = function () {\n        return this._drawMode;\n    };\n\n    proto.setDrawMode = function (drawMode) {\n        this._drawMode = drawMode;\n    };\n\n    proto.getShapeType = function () {\n        return this._shapeType;\n    };\n\n    proto.setShapeType = function (shapeType) {\n        this._shapeType = shapeType;\n    };\n\n    proto.setBatchNode = function (batchNode) {\n        if (this._batchNode !== batchNode) {\n            this._node._batchNode = batchNode;\n        }\n    };\n\n    proto.updateQuadWithParticle = function (particle, newPosition) {\n        //do nothing\n    };\n\n    proto.updateParticlePosition = function (particle, position) {\n        cc.pIn(particle.drawPos, position);\n    };\n\n    proto.rendering = function (ctx, scaleX, scaleY) {\n        //TODO: need refactor rendering for performance\n        var wrapper = ctx || cc._renderContext, context = wrapper.getContext(),\n            node = this._node, pointRect = this._pointRect;\n\n        wrapper.setTransform(this._worldTransform, scaleX, scaleY);\n        wrapper.save();\n        if (node.isBlendAdditive())\n            context.globalCompositeOperation = 'lighter';\n        else\n            context.globalCompositeOperation = 'source-over';\n\n        var i, particle, lpx, alpha;\n        var particleCount = this._node.particleCount, particles = this._node._particles;\n        if (node.drawMode !== cc.ParticleSystem.SHAPE_MODE && node._texture) {\n            // Delay drawing until the texture is fully loaded by the browser\n            if (!node._texture._textureLoaded) {\n                wrapper.restore();\n                return;\n            }\n            var element = node._texture.getHtmlElementObj();\n            if (!element.width || !element.height) {\n                wrapper.restore();\n                return;\n            }\n\n            var drawElement = element;\n            for (i = 0; i < particleCount; i++) {\n                particle = particles[i];\n                lpx = (0 | (particle.size * 0.5));\n\n                alpha = particle.color.a / 255;\n                if (alpha === 0) continue;\n                context.globalAlpha = alpha;\n\n                context.save();\n                context.translate((0 | particle.drawPos.x), -(0 | particle.drawPos.y));\n\n                var size = Math.floor(particle.size / 4) * 4;\n                var w = pointRect.width;\n                var h = pointRect.height;\n\n                context.scale(Math.max((1 / w) * size, 0.000001), Math.max((1 / h) * size, 0.000001));\n                if (particle.rotation)\n                    context.rotate(cc.degreesToRadians(particle.rotation));\n\n                drawElement = particle.isChangeColor ? this._changeTextureColor(node._texture, particle.color, this._pointRect) : element;\n                context.drawImage(drawElement, -(0 | (w / 2)), -(0 | (h / 2)));\n                context.restore();\n            }\n        } else {\n            var drawTool = cc._drawingUtil;\n            for (i = 0; i < particleCount; i++) {\n                particle = particles[i];\n                lpx = (0 | (particle.size * 0.5));\n                alpha = particle.color.a / 255;\n                if (alpha === 0) continue;\n                context.globalAlpha = alpha;\n\n                context.save();\n                context.translate(0 | particle.drawPos.x, -(0 | particle.drawPos.y));\n                if (node.shapeType === cc.ParticleSystem.STAR_SHAPE) {\n                    if (particle.rotation)\n                        context.rotate(cc.degreesToRadians(particle.rotation));\n                    drawTool.drawStar(wrapper, lpx, particle.color);\n                } else\n                    drawTool.drawColorBall(wrapper, lpx, particle.color);\n                context.restore();\n            }\n        }\n        wrapper.restore();\n        cc.g_NumberOfDraws++;\n    };\n\n    proto._changeTextureColor = function (texture, color, rect) {\n        if (!this._tintCache) {\n            this._tintCache = document.createElement(\"canvas\");\n        }\n        var tintCache = this._tintCache;\n        var textureContentSize = texture.getContentSize();\n        tintCache.width = textureContentSize.width;\n        tintCache.height = textureContentSize.height;\n        return texture._generateColorTexture(color.r, color.g, color.b, rect, tintCache);\n    };\n\n    proto.initTexCoordsWithRect = function (pointRect) {\n        this._pointRect = pointRect;\n    };\n\n    proto.setTotalParticles = function (tp) {\n        //cc.assert(tp <= this._allocatedParticles, \"Particle: resizing particle array only supported for quads\");\n        this._node._totalParticles = (tp < 200) ? tp : 200;\n    };\n\n    proto.addParticle = function () {\n        var node = this._node,\n            particles = node._particles,\n            particle;\n        if (node.particleCount < particles.length) {\n            particle = particles[node.particleCount];\n        } else {\n            particle = new cc.Particle();\n            particles.push(particle);\n        }\n        return particle;\n    };\n\n    proto._setupVBO = function () {\n    };\n    proto._allocMemory = function () {\n        return true;\n    };\n\n    proto.postStep = function () {\n    };\n\n    proto._setBlendAdditive = function () {\n        var locBlendFunc = this._node._blendFunc;\n        locBlendFunc.src = cc.BLEND_SRC;\n        locBlendFunc.dst = cc.BLEND_DST;\n    };\n\n    proto._initWithTotalParticles = function (totalParticles) {\n    };\n    proto._updateDeltaColor = function (selParticle, dt) {\n        if (!this._node._dontTint) {\n            var deltaColor = selParticle.deltaColor;\n            selParticle.color.r += deltaColor.r * dt;\n            selParticle.color.g += deltaColor.g * dt;\n            selParticle.color.b += deltaColor.b * dt;\n            selParticle.color.a += deltaColor.a * dt;\n            selParticle.isChangeColor = deltaColor.r !== 0 || deltaColor.g !== 0 || deltaColor.b !== 0;\n        }\n    };\n})();\n"]}