{"version":3,"sources":["../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/labels/assets/frameworks/cocos2d-html5/cocos2d/labels/CCLabelAtlasWebGLRenderCmd.js"],"names":["cc","LabelAtlas","WebGLRenderCmd","renderable","AtlasNode","call","_needDraw","proto","prototype","Object","create","constructor","_updateColor","_colorF32Array","locDisplayedColor","_displayedColor","a","_displayedOpacity","_node","_opacityModifyRGB","r","g","b","setCascade","node","_cascadeOpacityEnabled","_cascadeColorEnabled","rendering","ctx","LABELATLAS_DEBUG_DRAW","s","getContentSize","locRect","getBoundingBoxToWorld","posX","x","posY","y","width","height","vertices","p","_drawingUtil","drawPoly","updateAtlasValues","locString","_string","n","length","locTextureAtlas","_textureAtlas","texture","textureWide","pixelsWidth","textureHigh","pixelsHeight","itemWidthInPixels","_itemWidth","itemHeightInPixels","_itemHeight","_ignoreContentScaleFactor","contentScaleFactor","getCapacity","log","quads","locItemWidth","locItemHeight","i","cr","charCodeAt","_mapStartChar","row","_itemsPerRow","col","left","right","top","bottom","FIX_ARTIFACTS_BY_STRECHING_TEXEL","quad","locQuadTL","tl","locQuadTR","tr","locQuadBL","bl","locQuadBR","br","texCoords","u","v","z","updateContentSize","dirty","totalQuads","increaseTotalQuadsWith","contentSize","_contentSize","setContentSize","setString","label","len","resizeCapacity","_addChild"],"mappings":";;;;;;AAAA;;;;;;;;;;;;;;;;;;;;;;;;AAwBA,CAAC,YAAY;AACTA,OAAGC,UAAH,CAAcC,cAAd,GAA+B,UAAUC,UAAV,EAAsB;AACjDH,WAAGI,SAAH,CAAaF,cAAb,CAA4BG,IAA5B,CAAiC,IAAjC,EAAuCF,UAAvC;AACA,aAAKG,SAAL,GAAiB,IAAjB;AACH,KAHD;;AAKA,QAAIC,QAAQP,GAAGC,UAAH,CAAcC,cAAd,CAA6BM,SAA7B,GAAyCC,OAAOC,MAAP,CAAcV,GAAGI,SAAH,CAAaF,cAAb,CAA4BM,SAA1C,CAArD;AACAD,UAAMI,WAAN,GAAoBX,GAAGC,UAAH,CAAcC,cAAlC;;AAEAK,UAAMK,YAAN,GAAqB,YAAY;AAC7B,YAAI,KAAKC,cAAT,EAAyB;AACrB,gBAAIC,oBAAoB,KAAKC,eAA7B;AACA,gBAAIC,IAAI,KAAKC,iBAAL,GAAyB,GAAjC;AACA,gBAAI,KAAKC,KAAL,CAAWC,iBAAf,EAAkC;AAC9B,qBAAKN,cAAL,CAAoB,CAApB,IAAyBC,kBAAkBM,CAAlB,GAAsBJ,CAAtB,GAA0B,GAAnD;AACA,qBAAKH,cAAL,CAAoB,CAApB,IAAyBC,kBAAkBO,CAAlB,GAAsBL,CAAtB,GAA0B,GAAnD;AACA,qBAAKH,cAAL,CAAoB,CAApB,IAAyBC,kBAAkBQ,CAAlB,GAAsBN,CAAtB,GAA0B,GAAnD;AACA,qBAAKH,cAAL,CAAoB,CAApB,IAAyBG,CAAzB;AACH,aALD,MAMK;AACD,qBAAKH,cAAL,CAAoB,CAApB,IAAyBC,kBAAkBM,CAAlB,GAAsB,GAA/C;AACA,qBAAKP,cAAL,CAAoB,CAApB,IAAyBC,kBAAkBO,CAAlB,GAAsB,GAA/C;AACA,qBAAKR,cAAL,CAAoB,CAApB,IAAyBC,kBAAkBQ,CAAlB,GAAsB,GAA/C;AACA,qBAAKT,cAAL,CAAoB,CAApB,IAAyBG,CAAzB;AACH;AACJ;AACJ,KAjBD;;AAmBAT,UAAMgB,UAAN,GAAmB,YAAY;AAC3B,YAAIC,OAAO,KAAKN,KAAhB;AACAM,aAAKC,sBAAL,GAA8B,IAA9B;AACAD,aAAKE,oBAAL,GAA4B,IAA5B;AACH,KAJD;;AAMAnB,UAAMoB,SAAN,GAAkB,UAAUC,GAAV,EAAe;AAC7B5B,WAAGI,SAAH,CAAaF,cAAb,CAA4BM,SAA5B,CAAsCmB,SAAtC,CAAgDtB,IAAhD,CAAqD,IAArD,EAA2DuB,GAA3D;AACA,YAAI5B,GAAG6B,qBAAP,EAA8B;AAC1B,gBAAIL,OAAO,KAAKN,KAAhB;AACA,gBAAIY,IAAIN,KAAKO,cAAL,EAAR;AACA,gBAAIC,UAAUR,KAAKS,qBAAL,EAAd;AACA,gBAAIC,OAAOF,QAAQG,CAAnB;AAAA,gBACIC,OAAOJ,QAAQK,CADnB;AAEAP,cAAEQ,KAAF,GAAUN,QAAQM,KAAlB;AACAR,cAAES,MAAF,GAAWP,QAAQO,MAAnB;AACA,gBAAIC,WAAW,CAACxC,GAAGyC,CAAH,CAAKP,IAAL,EAAWE,IAAX,CAAD,EAAmBpC,GAAGyC,CAAH,CAAKP,OAAOJ,EAAEQ,KAAd,EAAqBF,IAArB,CAAnB,EACXpC,GAAGyC,CAAH,CAAKX,EAAEQ,KAAF,GAAUJ,IAAf,EAAqBJ,EAAES,MAAF,GAAWH,IAAhC,CADW,EAC4BpC,GAAGyC,CAAH,CAAKP,IAAL,EAAWE,OAAON,EAAES,MAApB,CAD5B,CAAf;AAEAvC,eAAG0C,YAAH,CAAgBC,QAAhB,CAAyBH,QAAzB,EAAmC,CAAnC,EAAsC,IAAtC;AACH;AACJ,KAdD;;AAgBAjC,UAAMqC,iBAAN,GAA0B,YAAY;AAClC,YAAIpB,OAAO,KAAKN,KAAhB;AACA,YAAI2B,YAAYrB,KAAKsB,OAArB;AACA,YAAIC,IAAIF,UAAUG,MAAlB;AACA,YAAIC,kBAAkB,KAAKC,aAA3B;;AAEA,YAAIC,UAAUF,gBAAgBE,OAA9B;AACA,YAAIC,cAAcD,QAAQE,WAA1B;AACA,YAAIC,cAAcH,QAAQI,YAA1B;AACA,YAAIC,oBAAoBhC,KAAKiC,UAA7B;AACA,YAAIC,qBAAqBlC,KAAKmC,WAA9B;AACA,YAAI,CAACnC,KAAKoC,yBAAV,EAAqC;AACjCJ,gCAAoBhC,KAAKiC,UAAL,GAAkBzD,GAAG6D,kBAAH,EAAtC;AACAH,iCAAqBlC,KAAKmC,WAAL,GAAmB3D,GAAG6D,kBAAH,EAAxC;AACH;AACD,YAAId,IAAIE,gBAAgBa,WAAhB,EAAR,EACI9D,GAAG+D,GAAH,CAAO,2DAAP;AACJ,YAAIC,QAAQf,gBAAgBe,KAA5B;AACA,YAAIC,eAAezC,KAAKiC,UAAxB;AACA,YAAIS,gBAAgB1C,KAAKmC,WAAzB;AACA,aAAK,IAAIQ,IAAI,CAAR,EAAWC,KAAK,CAAC,CAAtB,EAAyBD,IAAIpB,CAA7B,EAAgCoB,GAAhC,EAAqC;AACjC,gBAAInD,IAAI6B,UAAUwB,UAAV,CAAqBF,CAArB,IAA0B3C,KAAK8C,aAAL,CAAmBD,UAAnB,CAA8B,CAA9B,CAAlC;AACA,gBAAIE,MAAMvD,IAAIQ,KAAKgD,YAAnB;AACA,gBAAIC,MAAM,IAAKzD,IAAIQ,KAAKgD,YAAxB;AACA,gBAAID,MAAM,CAAN,IAAWE,MAAM,CAArB,EACI;AACJ,gBAAIF,MAAMN,YAAN,GAAqBA,YAArB,GAAoCb,WAApC,IAAmDqB,MAAMP,aAAN,GAAsBA,aAAtB,GAAsCZ,WAA7F,EACI;;AAEJc;AACA,gBAAIM,IAAJ,EAAUC,KAAV,EAAiBC,GAAjB,EAAsBC,MAAtB;AACA,gBAAI7E,GAAG8E,gCAAP,EAAyC;AACrC;AACAJ,uBAAO,CAAC,IAAIH,GAAJ,GAAUf,iBAAV,GAA8B,CAA/B,KAAqC,IAAIJ,WAAzC,CAAP;AACAuB,wBAAQD,OAAO,CAAClB,oBAAoB,CAApB,GAAwB,CAAzB,KAA+B,IAAIJ,WAAnC,CAAf;AACAwB,sBAAM,CAAC,IAAIH,GAAJ,GAAUf,kBAAV,GAA+B,CAAhC,KAAsC,IAAIJ,WAA1C,CAAN;AACAuB,yBAASD,MAAM,CAAClB,qBAAqB,CAArB,GAAyB,CAA1B,KAAgC,IAAIJ,WAApC,CAAf;AACH,aAND,MAMO;AACHoB,uBAAOH,MAAMf,iBAAN,GAA0BJ,WAAjC;AACAuB,wBAAQD,OAAOlB,oBAAoBJ,WAAnC;AACAwB,sBAAMH,MAAMf,kBAAN,GAA2BJ,WAAjC;AACAuB,yBAASD,MAAMlB,qBAAqBJ,WAApC;AACH;AACD,gBAAIyB,OAAOf,MAAMG,CAAN,CAAX;AACA,gBAAIa,YAAYD,KAAKE,EAArB;AAAA,gBAAyBC,YAAYH,KAAKI,EAA1C;AAAA,gBAA8CC,YAAYL,KAAKM,EAA/D;AAAA,gBAAmEC,YAAYP,KAAKQ,EAApF;AACAP,sBAAUQ,SAAV,CAAoBC,CAApB,GAAwBf,IAAxB;AACAM,sBAAUQ,SAAV,CAAoBE,CAApB,GAAwBd,GAAxB;AACAM,sBAAUM,SAAV,CAAoBC,CAApB,GAAwBd,KAAxB;AACAO,sBAAUM,SAAV,CAAoBE,CAApB,GAAwBd,GAAxB;AACAQ,sBAAUI,SAAV,CAAoBC,CAApB,GAAwBf,IAAxB;AACAU,sBAAUI,SAAV,CAAoBE,CAApB,GAAwBb,MAAxB;AACAS,sBAAUE,SAAV,CAAoBC,CAApB,GAAwBd,KAAxB;AACAW,sBAAUE,SAAV,CAAoBE,CAApB,GAAwBb,MAAxB;;AAEAO,sBAAU5C,QAAV,CAAmBL,CAAnB,GAAwBiC,KAAKH,YAA7B;AACAmB,sBAAU5C,QAAV,CAAmBH,CAAnB,GAAuB,CAAvB;AACA+C,sBAAU5C,QAAV,CAAmBmD,CAAnB,GAAuB,GAAvB;AACAL,sBAAU9C,QAAV,CAAmBL,CAAnB,GAAwBiC,KAAKH,YAAL,GAAoBA,YAA5C;AACAqB,sBAAU9C,QAAV,CAAmBH,CAAnB,GAAuB,CAAvB;AACAiD,sBAAU9C,QAAV,CAAmBmD,CAAnB,GAAuB,GAAvB;AACAX,sBAAUxC,QAAV,CAAmBL,CAAnB,GAAuBiC,KAAKH,YAA5B;AACAe,sBAAUxC,QAAV,CAAmBH,CAAnB,GAAuBb,KAAKmC,WAA5B;AACAqB,sBAAUxC,QAAV,CAAmBmD,CAAnB,GAAuB,GAAvB;AACAT,sBAAU1C,QAAV,CAAmBL,CAAnB,GAAuBiC,KAAKH,YAAL,GAAoBA,YAA3C;AACAiB,sBAAU1C,QAAV,CAAmBH,CAAnB,GAAuBb,KAAKmC,WAA5B;AACAuB,sBAAU1C,QAAV,CAAmBmD,CAAnB,GAAuB,GAAvB;AACH;;AAED,aAAK/E,YAAL;;AAEA,aAAKgF,iBAAL,CAAuBzB,CAAvB,EAA0BC,KAAK,CAA/B;AACA,YAAIrB,IAAI,CAAR,EAAW;AACPE,4BAAgB4C,KAAhB,GAAwB,IAAxB;AACA,gBAAIC,aAAa7C,gBAAgB6C,UAAjC;AACA,gBAAI/C,IAAI+C,UAAR,EACI7C,gBAAgB8C,sBAAhB,CAAuChD,IAAI+C,UAA3C;AACP;AACJ,KA7ED;;AA+EAvF,UAAMqF,iBAAN,GAA0B,UAAUzB,CAAV,EAAaC,EAAb,EAAiB;AACvC,YAAI5C,OAAO,KAAKN,KAAhB;AAAA,YACI8E,cAAcxE,KAAKyE,YADvB;AAEA,YAAI9B,MAAMC,EAAN,IAAYD,IAAI3C,KAAKiC,UAAT,KAAwBuC,YAAY1D,KAAhD,IAAyDd,KAAKmC,WAAL,KAAqBqC,YAAYzD,MAA9F,EAAsG;AAClGf,iBAAK0E,cAAL,CAAoB9B,KAAK5C,KAAKiC,UAA9B,EAA0CjC,KAAKmC,WAA/C;AACH;AACJ,KAND;;AAQApD,UAAM4F,SAAN,GAAkB,UAAUC,KAAV,EAAiB;AAC/B,YAAIC,MAAMD,MAAMpD,MAAhB;AACA,YAAIqD,MAAM,KAAKnD,aAAL,CAAmB4C,UAA7B,EACI,KAAK5C,aAAL,CAAmBoD,cAAnB,CAAkCD,GAAlC;AACP,KAJD;;AAMA9F,UAAMgG,SAAN,GAAkB,YAAY,CAC7B,CADD;AAEH,CAjJD","file":"CCLabelAtlasWebGLRenderCmd.js","sourceRoot":"../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/labels","sourcesContent":["/****************************************************************************\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\n(function () {\n    cc.LabelAtlas.WebGLRenderCmd = function (renderable) {\n        cc.AtlasNode.WebGLRenderCmd.call(this, renderable);\n        this._needDraw = true;\n    };\n\n    var proto = cc.LabelAtlas.WebGLRenderCmd.prototype = Object.create(cc.AtlasNode.WebGLRenderCmd.prototype);\n    proto.constructor = cc.LabelAtlas.WebGLRenderCmd;\n\n    proto._updateColor = function () {\n        if (this._colorF32Array) {\n            var locDisplayedColor = this._displayedColor;\n            var a = this._displayedOpacity / 255;\n            if (this._node._opacityModifyRGB) {\n                this._colorF32Array[0] = locDisplayedColor.r * a / 255;\n                this._colorF32Array[1] = locDisplayedColor.g * a / 255;\n                this._colorF32Array[2] = locDisplayedColor.b * a / 255;\n                this._colorF32Array[3] = a;\n            }\n            else {\n                this._colorF32Array[0] = locDisplayedColor.r / 255;\n                this._colorF32Array[1] = locDisplayedColor.g / 255;\n                this._colorF32Array[2] = locDisplayedColor.b / 255;\n                this._colorF32Array[3] = a;\n            }\n        }\n    };\n\n    proto.setCascade = function () {\n        var node = this._node;\n        node._cascadeOpacityEnabled = true;\n        node._cascadeColorEnabled = true;\n    };\n\n    proto.rendering = function (ctx) {\n        cc.AtlasNode.WebGLRenderCmd.prototype.rendering.call(this, ctx);\n        if (cc.LABELATLAS_DEBUG_DRAW) {\n            var node = this._node;\n            var s = node.getContentSize();\n            var locRect = node.getBoundingBoxToWorld();\n            var posX = locRect.x,\n                posY = locRect.y;\n            s.width = locRect.width;\n            s.height = locRect.height;\n            var vertices = [cc.p(posX, posY), cc.p(posX + s.width, posY),\n                cc.p(s.width + posX, s.height + posY), cc.p(posX, posY + s.height)];\n            cc._drawingUtil.drawPoly(vertices, 4, true);\n        }\n    };\n\n    proto.updateAtlasValues = function () {\n        var node = this._node;\n        var locString = node._string;\n        var n = locString.length;\n        var locTextureAtlas = this._textureAtlas;\n\n        var texture = locTextureAtlas.texture;\n        var textureWide = texture.pixelsWidth;\n        var textureHigh = texture.pixelsHeight;\n        var itemWidthInPixels = node._itemWidth;\n        var itemHeightInPixels = node._itemHeight;\n        if (!node._ignoreContentScaleFactor) {\n            itemWidthInPixels = node._itemWidth * cc.contentScaleFactor();\n            itemHeightInPixels = node._itemHeight * cc.contentScaleFactor();\n        }\n        if (n > locTextureAtlas.getCapacity())\n            cc.log(\"cc.LabelAtlas._updateAtlasValues(): Invalid String length\");\n        var quads = locTextureAtlas.quads;\n        var locItemWidth = node._itemWidth;\n        var locItemHeight = node._itemHeight;\n        for (var i = 0, cr = -1; i < n; i++) {\n            var a = locString.charCodeAt(i) - node._mapStartChar.charCodeAt(0);\n            var row = a % node._itemsPerRow;\n            var col = 0 | (a / node._itemsPerRow);\n            if (row < 0 || col < 0)\n                continue;\n            if (row * locItemWidth + locItemWidth > textureWide || col * locItemHeight + locItemHeight > textureHigh)\n                continue;\n\n            cr++;\n            var left, right, top, bottom;\n            if (cc.FIX_ARTIFACTS_BY_STRECHING_TEXEL) {\n                // Issue #938. Don't use texStepX & texStepY\n                left = (2 * row * itemWidthInPixels + 1) / (2 * textureWide);\n                right = left + (itemWidthInPixels * 2 - 2) / (2 * textureWide);\n                top = (2 * col * itemHeightInPixels + 1) / (2 * textureHigh);\n                bottom = top + (itemHeightInPixels * 2 - 2) / (2 * textureHigh);\n            } else {\n                left = row * itemWidthInPixels / textureWide;\n                right = left + itemWidthInPixels / textureWide;\n                top = col * itemHeightInPixels / textureHigh;\n                bottom = top + itemHeightInPixels / textureHigh;\n            }\n            var quad = quads[i];\n            var locQuadTL = quad.tl, locQuadTR = quad.tr, locQuadBL = quad.bl, locQuadBR = quad.br;\n            locQuadTL.texCoords.u = left;\n            locQuadTL.texCoords.v = top;\n            locQuadTR.texCoords.u = right;\n            locQuadTR.texCoords.v = top;\n            locQuadBL.texCoords.u = left;\n            locQuadBL.texCoords.v = bottom;\n            locQuadBR.texCoords.u = right;\n            locQuadBR.texCoords.v = bottom;\n\n            locQuadBL.vertices.x = (cr * locItemWidth);\n            locQuadBL.vertices.y = 0;\n            locQuadBL.vertices.z = 0.0;\n            locQuadBR.vertices.x = (cr * locItemWidth + locItemWidth);\n            locQuadBR.vertices.y = 0;\n            locQuadBR.vertices.z = 0.0;\n            locQuadTL.vertices.x = cr * locItemWidth;\n            locQuadTL.vertices.y = node._itemHeight;\n            locQuadTL.vertices.z = 0.0;\n            locQuadTR.vertices.x = cr * locItemWidth + locItemWidth;\n            locQuadTR.vertices.y = node._itemHeight;\n            locQuadTR.vertices.z = 0.0;\n        }\n\n        this._updateColor();\n\n        this.updateContentSize(i, cr + 1);\n        if (n > 0) {\n            locTextureAtlas.dirty = true;\n            var totalQuads = locTextureAtlas.totalQuads;\n            if (n > totalQuads)\n                locTextureAtlas.increaseTotalQuadsWith(n - totalQuads);\n        }\n    };\n\n    proto.updateContentSize = function (i, cr) {\n        var node = this._node,\n            contentSize = node._contentSize;\n        if (i !== cr && i * node._itemWidth === contentSize.width && node._itemHeight === contentSize.height) {\n            node.setContentSize(cr * node._itemWidth, node._itemHeight);\n        }\n    };\n\n    proto.setString = function (label) {\n        var len = label.length;\n        if (len > this._textureAtlas.totalQuads)\n            this._textureAtlas.resizeCapacity(len);\n    };\n\n    proto._addChild = function () {\n    };\n})();\n"]}