{"version":3,"sources":["../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/tilemap/assets/frameworks/cocos2d-html5/cocos2d/tilemap/CCTMXLayerCanvasRenderCmd.js"],"names":["cc","TMXLayer","CanvasRenderCmd","renderable","_rootCtor","_needDraw","proto","prototype","Object","create","Node","constructor","visit","parentCmd","node","_node","renderer","getParentRenderCmd","_curLevel","_visible","isNaN","_customZ","_vertexZ","assignedZ","assignedZStep","_syncStatus","children","_children","child","spTiles","_spriteTiles","i","len","length","sortAllChildren","_localZOrder","_renderCmd","pushRenderCommand","tag","updateStatus","_dirtyFlag","rendering","ctx","scaleX","scaleY","hasRotation","_rotationX","_rotationY","layerOrientation","tiles","alpha","_opacity","maptw","_mapTileSize","width","mapth","height","tilew","tileset","_tileSize","director","_contentScaleFactor","tileh","extw","exth","winw","winSize","winh","rows","_layerSize","cols","grids","_texGrids","wt","_worldTransform","ox","_contentSize","_anchorPoint","x","oy","y","a","b","c","d","mapx","tx","mapy","ty","wrapper","_renderContext","context","getContext","startCol","startRow","maxCol","maxRow","TMX_ORIENTATION_ORTHO","Math","floor","ceil","row","col","colOffset","z","gid","grid","tex","cmd","mask","TMX_TILE_FLIPPED_MASK","top","left","bottom","right","dw","dh","w","h","gt","gl","gb","gr","flippedX","flippedY","setTransform","setGlobalAlpha","_textures","texId","_htmlElementObj","TMX_ORIENTATION_ISO","TMX_ORIENTATION_HEX","TMX_TILE_DIAGONAL_FLAG","TMX_TILE_HORIZONTAL_FLAG","TMX_TILE_VERTICAL_FLAG","scale","drawImage","g_NumberOfDraws"],"mappings":"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","file":"CCTMXLayerCanvasRenderCmd.js","sourceRoot":"../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/tilemap","sourcesContent":["/****************************************************************************\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\n(function () {\n    cc.TMXLayer.CanvasRenderCmd = function (renderable) {\n        this._rootCtor(renderable);\n        this._needDraw = true;\n    };\n\n    var proto = cc.TMXLayer.CanvasRenderCmd.prototype = Object.create(cc.Node.CanvasRenderCmd.prototype);\n    proto.constructor = cc.TMXLayer.CanvasRenderCmd;\n\n    proto.visit = function (parentCmd) {\n        var node = this._node, renderer = cc.renderer;\n\n        parentCmd = parentCmd || this.getParentRenderCmd();\n        if (parentCmd) {\n            this._curLevel = parentCmd._curLevel + 1;\n        }\n\n        // quick return if not visible\n        if (!node._visible)\n            return;\n\n        if (isNaN(node._customZ)) {\n            node._vertexZ = renderer.assignedZ;\n            renderer.assignedZ += renderer.assignedZStep;\n        }\n\n        this._syncStatus(parentCmd);\n\n        // Visit children\n        var children = node._children, child,\n            spTiles = node._spriteTiles,\n            i, len = children.length;\n        if (len > 0) {\n            node.sortAllChildren();\n            // draw children zOrder < 0\n            for (i = 0; i < len; i++) {\n                child = children[i];\n                if (child._localZOrder < 0) {\n                    child._renderCmd.visit(this);\n                }\n                else {\n                    break;\n                }\n            }\n\n            renderer.pushRenderCommand(this);\n            for (; i < len; i++) {\n                child = children[i];\n                if (child._localZOrder === 0 && spTiles[child.tag]) {\n                    if (isNaN(child._customZ)) {\n                        child._vertexZ = renderer.assignedZ;\n                        renderer.assignedZ += renderer.assignedZStep;\n                    }\n                    child._renderCmd.updateStatus();\n                    continue;\n                }\n                child._renderCmd.visit(this);\n            }\n        } else {\n            renderer.pushRenderCommand(this);\n        }\n        this._dirtyFlag = 0;\n    };\n\n    proto.rendering = function (ctx, scaleX, scaleY) {\n        var node = this._node, hasRotation = (node._rotationX || node._rotationY),\n            layerOrientation = node.layerOrientation,\n            tiles = node.tiles,\n            alpha = node._opacity / 255;\n\n        if (!tiles || alpha <= 0) {\n            return;\n        }\n\n        var maptw = node._mapTileSize.width,\n            mapth = node._mapTileSize.height,\n            tilew = node.tileset._tileSize.width / cc.director._contentScaleFactor,\n            tileh = node.tileset._tileSize.height / cc.director._contentScaleFactor,\n            extw = tilew - maptw,\n            exth = tileh - mapth,\n            winw = cc.winSize.width,\n            winh = cc.winSize.height,\n            rows = node._layerSize.height,\n            cols = node._layerSize.width,\n            grids = node._texGrids,\n            spTiles = node._spriteTiles,\n            wt = this._worldTransform,\n            ox = -node._contentSize.width * node._anchorPoint.x,\n            oy = -node._contentSize.height * node._anchorPoint.y,\n            a = wt.a, b = wt.b, c = wt.c, d = wt.d,\n            mapx = ox * a + oy * c + wt.tx,\n            mapy = ox * b + oy * d + wt.ty;\n\n        var wrapper = ctx || cc._renderContext, context = wrapper.getContext();\n\n        // Culling\n        var startCol = 0, startRow = 0,\n            maxCol = cols, maxRow = rows;\n        if (!hasRotation && layerOrientation === cc.TMX_ORIENTATION_ORTHO) {\n            startCol = Math.floor(-(mapx - extw * a) / (maptw * a));\n            startRow = Math.floor((mapy - exth * d + mapth * rows * d - winh) / (mapth * d));\n            maxCol = Math.ceil((winw - mapx + extw * a) / (maptw * a));\n            maxRow = rows - Math.floor(-(mapy + exth * d) / (mapth * d));\n            // Adjustment\n            if (startCol < 0) startCol = 0;\n            if (startRow < 0) startRow = 0;\n            if (maxCol > cols) maxCol = cols;\n            if (maxRow > rows) maxRow = rows;\n        }\n\n        var i, row, col, colOffset = startRow * cols, z,\n            gid, grid, tex, cmd,\n            mask = cc.TMX_TILE_FLIPPED_MASK,\n            top, left, bottom, right, dw = tilew, dh = tileh,\n            w = tilew * a, h = tileh * d, gt, gl, gb, gr,\n            flippedX = false, flippedY = false;\n\n        // Draw culled sprite tiles\n        z = colOffset + startCol;\n        for (i in spTiles) {\n            if (i < z && spTiles[i]) {\n                cmd = spTiles[i]._renderCmd;\n                if (spTiles[i]._localZOrder === 0 && !!cmd.rendering) {\n                    cmd.rendering(ctx, scaleX, scaleY);\n                }\n            }\n            else if (i >= z) {\n                break;\n            }\n        }\n\n        wrapper.setTransform(wt, scaleX, scaleY);\n        wrapper.setGlobalAlpha(alpha);\n\n        for (row = startRow; row < maxRow; ++row) {\n            for (col = startCol; col < maxCol; ++col) {\n                z = colOffset + col;\n                // Skip sprite tiles\n                if (spTiles[z]) {\n                    cmd = spTiles[z]._renderCmd;\n                    if (spTiles[z]._localZOrder === 0 && !!cmd.rendering) {\n                        cmd.rendering(ctx, scaleX, scaleY);\n                        wrapper.setTransform(wt, scaleX, scaleY);\n                        wrapper.setGlobalAlpha(alpha);\n                    }\n                    continue;\n                }\n\n                gid = node.tiles[z];\n                grid = grids[(gid & mask) >>> 0];\n                if (!grid) {\n                    continue;\n                }\n                tex = node._textures[grid.texId];\n                if (!tex || !tex._htmlElementObj) {\n                    continue;\n                }\n\n                switch (layerOrientation) {\n                case cc.TMX_ORIENTATION_ORTHO:\n                    left = col * maptw;\n                    bottom = -(rows - row - 1) * mapth;\n                    break;\n                case cc.TMX_ORIENTATION_ISO:\n                    left = maptw / 2 * ( cols + col - row - 1);\n                    bottom = -mapth / 2 * ( rows * 2 - col - row - 2);\n                    break;\n                case cc.TMX_ORIENTATION_HEX:\n                    left = col * maptw * 3 / 4;\n                    bottom = -(rows - row - 1) * mapth + ((col % 2 === 1) ? (-mapth / 2) : 0);\n                    break;\n                }\n                right = left + tilew;\n                top = bottom - tileh;\n                // TMX_ORIENTATION_ISO trim\n                if (!hasRotation && layerOrientation === cc.TMX_ORIENTATION_ISO) {\n                    gb = -mapy + bottom * d;\n                    if (gb < -winh - h) {\n                        col += Math.floor((-winh - gb) * 2 / h) - 1;\n                        continue;\n                    }\n                    gr = mapx + right * a;\n                    if (gr < -w) {\n                        col += Math.floor((-gr) * 2 / w) - 1;\n                        continue;\n                    }\n                    gl = mapx + left * a;\n                    gt = -mapy + top * d;\n                    if (gl > winw || gt > 0) {\n                        col = maxCol;\n                        continue;\n                    }\n                }\n\n                // Rotation and Flip\n                if (gid > cc.TMX_TILE_DIAGONAL_FLAG) {\n                    flippedX = (gid & cc.TMX_TILE_HORIZONTAL_FLAG) >>> 0;\n                    flippedY = (gid & cc.TMX_TILE_VERTICAL_FLAG) >>> 0;\n                }\n\n                if (flippedX) {\n                    left = -right;\n                    context.scale(-1, 1);\n                }\n                if (flippedY) {\n                    top = -bottom;\n                    context.scale(1, -1);\n                }\n\n                context.drawImage(tex._htmlElementObj,\n                    grid.x, grid.y, grid.width, grid.height,\n                    left, top, dw, dh);\n                // Revert flip\n                if (flippedX) {\n                    context.scale(-1, 1);\n                }\n                if (flippedY) {\n                    context.scale(1, -1);\n                }\n                cc.g_NumberOfDraws++;\n            }\n            colOffset += cols;\n        }\n\n        // Draw culled sprite tiles\n        for (i in spTiles) {\n            if (i > z && spTiles[i]) {\n                cmd = spTiles[i]._renderCmd;\n                if (spTiles[i]._localZOrder === 0 && !!cmd.rendering) {\n                    cmd.rendering(ctx, scaleX, scaleY);\n                }\n            }\n        }\n    };\n})();\n"]}