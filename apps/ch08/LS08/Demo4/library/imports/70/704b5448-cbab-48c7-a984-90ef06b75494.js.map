{"version":3,"sources":["../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/effects/assets/frameworks/cocos2d-html5/cocos2d/effects/CCGrid.js"],"names":["cc","GridBase","Class","extend","_active","_reuseGrid","_gridSize","_gridRect","_texture","_step","_grabber","_isTextureFlipped","_glProgramState","_directorProjection","_dirty","ctor","gridSize","texture","flipped","rect","sys","_checkWebGLRenderMode","p","undefined","initWithSize","isActive","setActive","active","director","proj","getProjection","setProjection","getReuseGrid","setReuseGrid","reuseGrid","getGridSize","size","width","height","setGridSize","parseInt","setGridRect","getGridRect","getStep","x","y","setStep","step","isTextureFlipped","setTextureFlipped","calculateVertexPoints","winSize","getWinSizeInPixels","POTWide","NextPOT","POTHigh","data","Uint8Array","log","Texture2D","initWithData","PIXEL_FORMAT_RGBA8888","_rectEqualToZero","getContentSize","Grabber","grab","GLProgramState","getOrCreateWithGLProgram","shaderCache","programForKey","SHADER_POSITION_TEXTURE","beforeDraw","gl","viewport","beforeRender","afterDraw","target","afterRender","setViewport","glBindTexture2D","beforeBlit","blit","afterBlit","reuse","set2DProjection","_renderContext","kmGLMatrixMode","KM_GL_PROJECTION","kmGLLoadIdentity","orthoMatrix","math","Matrix4","createOrthographicProjection","kmGLMultMatrix","KM_GL_MODELVIEW","setProjectionMatrixDirty","create","Grid3D","_texCoordinates","_vertices","_originalVertices","_indices","_texCoordinateBuffer","_verticesBuffer","_indicesBuffer","_needDepthTestForBlit","_oldDepthTestValue","_oldDepthWriteValue","prototype","call","_matrix","identity","vertex","pos","getVertex","index","locVertices","Vertex3F","originalVertex","getOriginalVertex","locOriginalVertices","setVertex","vertArray","z","isEnabled","DEPTH_TEST","getParameter","DEPTH_WRITEMASK","enable","depthMask","disable","n","wt","_renderCmd","_worldTransform","mat","a","c","tx","b","d","ty","apply","locDirty","enableVertexAttribArray","VERTEX_ATTRIB_POSITION","VERTEX_ATTRIB_TEX_COORDS","bindBuffer","ARRAY_BUFFER","bufferData","DYNAMIC_DRAW","vertexAttribPointer","FLOAT","ELEMENT_ARRAY_BUFFER","STATIC_DRAW","drawElements","TRIANGLES","UNSIGNED_SHORT","incrementGLDraws","i","len","length","pixelsWidth","pixelsHeight","imageH","getContentSizeInPixels","locGridSize","numOfPoints","Float32Array","Uint16Array","deleteBuffer","createBuffer","locIndices","locTexCoordinates","locIsTextureFlipped","idx","x1","x2","y1","y2","l1","e","f","g","h","l2","tex1","tex2","setNeedDepthTestForBlit","needDepthTest","getNeedDepthTestForBlit","TiledGrid3D","tile","getTile","Quad3","getOriginalTile","originalTile","setTile","coords","bl","br","tl","tr","numQuads","locStep","locTexCoords","newY1","newY2"],"mappings":"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","file":"CCGrid.js","sourceRoot":"../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/effects","sourcesContent":["/****************************************************************************\n Copyright (c) 2008-2010 Ricardo Quesada\n Copyright (c) 2011-2012 cocos2d-x.org\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n Copyright (c) 2009      On-Core\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\n/**\n * Base class for cc.Grid\n * @class\n * @extends cc.Class\n */\ncc.GridBase = cc.Class.extend(/** @lends cc.GridBase# */{\n    _active: false,\n    _reuseGrid: 0,\n    _gridSize: null,\n    _gridRect: null,\n    _texture: null,\n    _step: null,\n    _grabber: null,\n    _isTextureFlipped: false,\n    _glProgramState: null,\n    _directorProjection: 0,\n\n    _dirty: false,\n\n    /**\n     * create one cc.GridBase Object\n     * Constructor of cc.GridBase\n     * @param {cc.Size} gridSize\n     * @param {cc.Texture2D} [texture=]\n     * @param {Boolean} [flipped=]\n     * @param {cc.Rect} rect\n     */\n    ctor: function (gridSize, texture, flipped, rect) {\n        cc.sys._checkWebGLRenderMode();\n        this._active = false;\n        this._reuseGrid = 0;\n        this._gridSize = null;\n        this._gridRect = new cc.rect();\n        this._texture = null;\n        this._step = cc.p(0, 0);\n        this._grabber = null;\n        this._isTextureFlipped = false;\n        this._glProgramState = null;\n        this._directorProjection = 0;\n        this._dirty = false;\n\n        if (gridSize !== undefined)\n            this.initWithSize(gridSize, texture, flipped, rect);\n    },\n\n    /**\n     * whether or not the grid is active\n     * @return {Boolean}\n     */\n    isActive: function () {\n        return this._active;\n    },\n\n    /**\n     * whether or not the grid is active\n     * @param {Number} active\n     */\n    setActive: function (active) {\n        this._active = active;\n        if (!active) {\n            var director = cc.director;\n            var proj = director.getProjection();\n            director.setProjection(proj);\n        }\n    },\n\n    /**\n     * get number of times that the grid will be reused\n     * @return {Number}\n     */\n    getReuseGrid: function () {\n        return this._reuseGrid;\n    },\n    /**\n     * set number of times that the grid will be reused\n     * @param reuseGrid\n     */\n    setReuseGrid: function (reuseGrid) {\n        this._reuseGrid = reuseGrid;\n    },\n\n    /**\n     * get size of the grid\n     * @return {cc.Size}\n     */\n    getGridSize: function () {\n        return cc.size(this._gridSize.width, this._gridSize.height);\n    },\n\n    /**\n     * set size of the grid\n     * @param {cc.Size} gridSize\n     */\n    setGridSize: function (gridSize) {\n        this._gridSize.width = parseInt(gridSize.width);\n        this._gridSize.height = parseInt(gridSize.height);\n    },\n\n    /**\n     * set rect of the grid\n     * @param {cc.Rect} rect\n     */\n    setGridRect: function (rect) {\n        this._gridRect = rect;\n    },\n\n    /**\n     * get rect of the grid\n     * @return {cc.Rect} rect\n     */\n    getGridRect: function () {\n        return this._gridRect;\n    },\n\n    /**\n     * get pixels between the grids\n     * @return {cc.Point}\n     */\n    getStep: function () {\n        return cc.p(this._step.x, this._step.y);\n    },\n\n    /**\n     * set pixels between the grids\n     * @param {cc.Point} step\n     */\n    setStep: function (step) {\n        this._step.x = step.x;\n        this._step.y = step.y;\n    },\n\n    /**\n     * get whether or not the texture is flipped\n     * @return {Boolean}\n     */\n    isTextureFlipped: function () {\n        return this._isTextureFlipped;\n    },\n\n    /**\n     * set whether or not the texture is flipped\n     * @param {Boolean} flipped\n     */\n    setTextureFlipped: function (flipped) {\n        if (this._isTextureFlipped !== flipped) {\n            this._isTextureFlipped = flipped;\n            this.calculateVertexPoints();\n        }\n    },\n\n    /**\n     *\n     * @param {cc.Size} gridSize\n     * @param {cc.Texture2D} [texture=]\n     * @param {Boolean} [flipped=false]\n     * @param {cc.Rect} [rect=]\n     * @returns {boolean}\n     */\n    initWithSize: function (gridSize, texture, flipped, rect) {\n        if (!texture) {\n            var director = cc.director;\n            var winSize = director.getWinSizeInPixels();\n\n            var POTWide = cc.NextPOT(winSize.width);\n            var POTHigh = cc.NextPOT(winSize.height);\n\n            var data = new Uint8Array(POTWide * POTHigh * 4);\n            if (!data) {\n                cc.log(\"cocos2d: CCGrid: not enough memory.\");\n                return false;\n            }\n\n            texture = new cc.Texture2D();\n            // we only use rgba8888\n            texture.initWithData(data, cc.Texture2D.PIXEL_FORMAT_RGBA8888, POTWide, POTHigh, winSize);\n            if (!texture) {\n                cc.log(\"cocos2d: CCGrid: error creating texture\");\n                return false;\n            }\n        }\n\n        flipped = flipped || false;\n\n        this._active = false;\n        this._reuseGrid = 0;\n        this._gridSize = gridSize;\n        this._texture = texture;\n        this._isTextureFlipped = flipped;\n        if (rect === undefined || cc._rectEqualToZero(rect)) {\n            var size = this._texture.getContentSize();\n            rect = new cc.rect(0, 0, size.width, size.height);\n        }\n\n        this._gridRect = rect;\n\n        this._step.x = this._gridRect.width / gridSize.width;\n        this._step.y = this._gridRect.height / gridSize.height;\n\n        this._grabber = new cc.Grabber();\n        if (!this._grabber)\n            return false;\n        this._grabber.grab(this._texture);\n        this._glProgramState = cc.GLProgramState.getOrCreateWithGLProgram(cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURE));\n        this.calculateVertexPoints();\n        return true;\n    },\n\n    beforeDraw: function () {\n        // save projection\n        this._directorProjection = cc.director.getProjection();\n\n        //this.set2DProjection();    //TODO why?\n        var size = cc.director.getWinSizeInPixels();\n        gl.viewport(0, 0, size.width, size.height);\n        this._grabber.beforeRender(this._texture);\n    },\n\n    afterDraw: function (target) {\n        this._grabber.afterRender(this._texture);\n\n        // restore projection\n        //cc.director.setProjection(this._directorProjection);\n        cc.director.setViewport();\n\n        cc.glBindTexture2D(this._texture);\n        this.beforeBlit();\n        this.blit(target);\n        this.afterBlit();\n    },\n\n    beforeBlit: function () {\n    },\n\n    afterBlit: function () {\n    },\n\n    blit: function () {\n        cc.log(\"cc.GridBase.blit(): Shall be overridden in subclass.\");\n    },\n\n    reuse: function () {\n        cc.log(\"cc.GridBase.reuse(): Shall be overridden in subclass.\");\n    },\n\n    calculateVertexPoints: function () {\n        cc.log(\"cc.GridBase.calculateVertexPoints(): Shall be overridden in subclass.\");\n    },\n\n    set2DProjection: function () {\n        var winSize = cc.director.getWinSizeInPixels();\n\n        var gl = cc._renderContext;\n        gl.viewport(0, 0, winSize.width, winSize.height);\n        cc.kmGLMatrixMode(cc.KM_GL_PROJECTION);\n        cc.kmGLLoadIdentity();\n\n        var orthoMatrix = cc.math.Matrix4.createOrthographicProjection(0, winSize.width, 0, winSize.height, -1, 1);\n        cc.kmGLMultMatrix(orthoMatrix);\n\n        cc.kmGLMatrixMode(cc.KM_GL_MODELVIEW);\n        cc.kmGLLoadIdentity();\n        cc.setProjectionMatrixDirty()\n    }\n});\n\n/**\n * create one cc.GridBase Object\n * @deprecated\n * @param {cc.Size} gridSize\n * @param {cc.Texture2D} [texture=]\n * @param {Boolean} [flipped=]\n * @param {cc.Rect} [rect=]\n * @return {cc.GridBase}\n */\ncc.GridBase.create = function (gridSize, texture, flipped, rect) {\n    return new cc.GridBase(gridSize, texture, flipped, rect);\n};\n\n/**\n * cc.Grid3D is a 3D grid implementation. Each vertex has 3 dimensions: x,y,z\n * @class\n * @extends cc.GridBase\n */\ncc.Grid3D = cc.GridBase.extend(/** @lends cc.Grid3D# */{\n    _texCoordinates: null,\n    _vertices: null,\n    _originalVertices: null,\n    _indices: null,\n\n    _texCoordinateBuffer: null,\n    _verticesBuffer: null,\n    _indicesBuffer: null,\n\n    _needDepthTestForBlit: false,\n    _oldDepthTestValue: false,\n    _oldDepthWriteValue: false,\n\n    /**\n     * create one Grid3D object\n     * Constructor of cc.Grid3D\n     * @param {cc.Size} gridSize\n     * @param {cc.Texture2D} [texture=]\n     * @param {Boolean} [flipped=]\n     * @param {cc.Rect} [rect=]\n     */\n    ctor: function (gridSize, texture, flipped, rect) {\n        cc.GridBase.prototype.ctor.call(this);\n        this._texCoordinates = null;\n        this._vertices = null;\n        this._originalVertices = null;\n        this._indices = null;\n\n        this._texCoordinateBuffer = null;\n        this._verticesBuffer = null;\n        this._indicesBuffer = null;\n\n        this._matrix = new cc.math.Matrix4();\n        this._matrix.identity();\n\n        if (gridSize !== undefined)\n            this.initWithSize(gridSize, texture, flipped, rect);\n    },\n\n    /**\n     * returns the vertex at a given position      <br/>\n     * It will be deprecated in future, please use getVertex instead.\n     * @param {cc.Point} pos\n     * @return {cc.Vertex3F}\n     */\n    vertex: function (pos) {\n        return this.getVertex(pos);\n    },\n\n    /**\n     * returns the vertex at a given position\n     * @param {cc.Point} pos\n     * @return {cc.Vertex3F}\n     */\n    getVertex: function (pos) {\n        if (pos.x !== (0 | pos.x) || pos.y !== (0 | pos.y))\n            cc.log(\"cc.Grid3D.vertex() : Numbers must be integers\");\n        var index = 0 | ((pos.x * (this._gridSize.height + 1) + pos.y) * 3);\n        var locVertices = this._vertices;\n        return new cc.Vertex3F(locVertices[index], locVertices[index + 1], locVertices[index + 2]);\n    },\n\n    /**\n     * returns the original (non-transformed) vertex at a given position             <br/>\n     * It will be deprecated in future, please use getOriginalVertex instead.\n     * @param {cc.Point} pos\n     * @return {cc.Vertex3F}\n     */\n    originalVertex: function (pos) {\n        return this.getOriginalVertex(pos);\n    },\n\n    /**\n     * returns the original (non-transformed) vertex at a given position\n     * @param {cc.Point} pos\n     * @return {cc.Vertex3F}\n     */\n    getOriginalVertex: function (pos) {\n        if (pos.x !== (0 | pos.x) || pos.y !== (0 | pos.y))\n            cc.log(\"cc.Grid3D.originalVertex() : Numbers must be integers\");\n        var index = 0 | ((pos.x * (this._gridSize.height + 1) + pos.y) * 3);\n        var locOriginalVertices = this._originalVertices;\n        return new cc.Vertex3F(locOriginalVertices[index], locOriginalVertices[index + 1], locOriginalVertices[index + 2]);\n    },\n\n    /**\n     * sets a new vertex at a given position\n     * @param {cc.Point} pos\n     * @param {cc.Vertex3F} vertex\n     */\n    setVertex: function (pos, vertex) {\n        if (pos.x !== (0 | pos.x) || pos.y !== (0 | pos.y))\n            cc.log(\"cc.Grid3D.setVertex() : Numbers must be integers\");\n        var index = 0 | ((pos.x * (this._gridSize.height + 1) + pos.y) * 3);\n        var vertArray = this._vertices;\n        vertArray[index] = vertex.x;\n        vertArray[index + 1] = vertex.y;\n        vertArray[index + 2] = vertex.z;\n        this._dirty = true;\n    },\n\n    beforeBlit: function () {\n        if (this._needDepthTestForBlit) {\n            var gl = cc._renderContext;\n            this._oldDepthTestValue = gl.isEnabled(gl.DEPTH_TEST);\n            this._oldDepthWriteValue = gl.getParameter(gl.DEPTH_WRITEMASK);\n            //CHECK_GL_ERROR_DEBUG();\n            gl.enable(gl.DEPTH_TEST);\n            gl.depthMask(true);\n        }\n    },\n\n    afterBlit: function () {\n        if (this._needDepthTestForBlit) {\n            var gl = cc._renderContext;\n            if (this._oldDepthTestValue)\n                gl.enable(gl.DEPTH_TEST);\n            else\n                gl.disable(gl.DEPTH_TEST);\n            gl.depthMask(this._oldDepthWriteValue);\n        }\n    },\n\n    blit: function (target) {\n        var n = this._gridSize.width * this._gridSize.height;\n\n        var wt = target._renderCmd._worldTransform;\n        this._matrix.mat[0] = wt.a;\n        this._matrix.mat[4] = wt.c;\n        this._matrix.mat[12] = wt.tx;\n        this._matrix.mat[1] = wt.b;\n        this._matrix.mat[5] = wt.d;\n        this._matrix.mat[13] = wt.ty;\n\n        this._glProgramState.apply(this._matrix);\n\n        var gl = cc._renderContext, locDirty = this._dirty;\n\n        gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_POSITION);\n        gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_TEX_COORDS);\n        //\n        // Attributes\n        //\n        // position\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._verticesBuffer);\n        if (locDirty)\n            gl.bufferData(gl.ARRAY_BUFFER, this._vertices, gl.DYNAMIC_DRAW);\n        gl.vertexAttribPointer(cc.VERTEX_ATTRIB_POSITION, 3, gl.FLOAT, false, 0, 0);\n\n        // texCoords\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._texCoordinateBuffer);\n        if (locDirty)\n            gl.bufferData(gl.ARRAY_BUFFER, this._texCoordinates, gl.DYNAMIC_DRAW);\n        gl.vertexAttribPointer(cc.VERTEX_ATTRIB_TEX_COORDS, 2, gl.FLOAT, false, 0, 0);\n\n        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this._indicesBuffer);\n        if (locDirty)\n            gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this._indices, gl.STATIC_DRAW);\n        gl.drawElements(gl.TRIANGLES, n * 6, gl.UNSIGNED_SHORT, 0);\n        if (locDirty)\n            this._dirty = false;\n        cc.incrementGLDraws(1);\n    },\n\n    reuse: function () {\n        if (this._reuseGrid > 0) {\n            var locOriginalVertices = this._originalVertices, locVertices = this._vertices;\n            for (var i = 0, len = this._vertices.length; i < len; i++)\n                locOriginalVertices[i] = locVertices[i];\n            --this._reuseGrid;\n        }\n    },\n\n    calculateVertexPoints: function () {\n        var gl = cc._renderContext;\n\n        var width = this._texture.pixelsWidth;\n        var height = this._texture.pixelsHeight;\n        var imageH = this._texture.getContentSizeInPixels().height;\n        var locGridSize = this._gridSize;\n\n        var numOfPoints = (locGridSize.width + 1) * (locGridSize.height + 1);\n        this._vertices = new Float32Array(numOfPoints * 3);\n        this._texCoordinates = new Float32Array(numOfPoints * 2);\n        this._indices = new Uint16Array(locGridSize.width * locGridSize.height * 6);\n\n        if (this._verticesBuffer)\n            gl.deleteBuffer(this._verticesBuffer);\n        this._verticesBuffer = gl.createBuffer();\n        if (this._texCoordinateBuffer)\n            gl.deleteBuffer(this._texCoordinateBuffer);\n        this._texCoordinateBuffer = gl.createBuffer();\n        if (this._indicesBuffer)\n            gl.deleteBuffer(this._indicesBuffer);\n        this._indicesBuffer = gl.createBuffer();\n\n        var x, y, i, locIndices = this._indices, locTexCoordinates = this._texCoordinates;\n        var locIsTextureFlipped = this._isTextureFlipped, locVertices = this._vertices;\n        for (x = 0; x < locGridSize.width; ++x) {\n            for (y = 0; y < locGridSize.height; ++y) {\n                var idx = (y * locGridSize.width) + x;\n                var x1 = x * this._step.x + this._gridRect.x;\n                var x2 = x1 + this._step.x;\n                var y1 = y * this._step.y + this._gridRect.y;\n                var y2 = y1 + this._step.y;\n\n                var a = (x * (locGridSize.height + 1) + y);\n                var b = ((x + 1) * (locGridSize.height + 1) + y);\n                var c = ((x + 1) * (locGridSize.height + 1) + (y + 1));\n                var d = (x * (locGridSize.height + 1) + (y + 1));\n\n                locIndices[idx * 6] = a;\n                locIndices[idx * 6 + 1] = b;\n                locIndices[idx * 6 + 2] = d;\n                locIndices[idx * 6 + 3] = b;\n                locIndices[idx * 6 + 4] = c;\n                locIndices[idx * 6 + 5] = d;\n\n                var l1 = [a * 3, b * 3, c * 3, d * 3];\n                var e = {x: x1, y: y1, z: 0};   //new cc.Vertex3F(x1, y1, 0);\n                var f = {x: x2, y: y1, z: 0};   //new cc.Vertex3F(x2, y1, 0);\n                var g = {x: x2, y: y2, z: 0};   // new cc.Vertex3F(x2, y2, 0);\n                var h = {x: x1, y: y2, z: 0};   //new cc.Vertex3F(x1, y2, 0);\n\n                var l2 = [e, f, g, h];\n                var tex1 = [a * 2, b * 2, c * 2, d * 2];\n                var tex2 = [cc.p(x1, y1), cc.p(x2, y1), cc.p(x2, y2), cc.p(x1, y2)];\n                for (i = 0; i < 4; ++i) {\n                    locVertices[l1[i]] = l2[i].x;\n                    locVertices[l1[i] + 1] = l2[i].y;\n                    locVertices[l1[i] + 2] = l2[i].z;\n                    locTexCoordinates[tex1[i]] = tex2[i].x / width;\n                    if (locIsTextureFlipped)\n                        locTexCoordinates[tex1[i] + 1] = (imageH - tex2[i].y) / height;\n                    else\n                        locTexCoordinates[tex1[i] + 1] = tex2[i].y / height;\n                }\n            }\n        }\n        this._originalVertices = new Float32Array(this._vertices);\n\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._verticesBuffer);\n        gl.bufferData(gl.ARRAY_BUFFER, this._vertices, gl.DYNAMIC_DRAW);\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._texCoordinateBuffer);\n        gl.bufferData(gl.ARRAY_BUFFER, this._texCoordinates, gl.DYNAMIC_DRAW);\n        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this._indicesBuffer);\n        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this._indices, gl.STATIC_DRAW);\n        this._dirty = true;\n    },\n\n    setNeedDepthTestForBlit: function (needDepthTest) {\n        this._needDepthTestForBlit = needDepthTest;\n    },\n\n    getNeedDepthTestForBlit: function () {\n        return this._needDepthTestForBlit;\n    }\n});\n\n/**\n * create one Grid3D object\n * @deprecated\n * @param {cc.Size} gridSize\n * @param {cc.Texture2D} [texture=]\n * @param {Boolean} [flipped=]\n * @return {cc.Grid3D}\n */\ncc.Grid3D.create = function (gridSize, texture, flipped) {\n    return new cc.Grid3D(gridSize, texture, flipped);\n};\n\n/**\n * cc.TiledGrid3D is a 3D grid implementation. It differs from Grid3D in that   <br/>\n * the tiles can be separated from the grid.\n * @class\n * @extends cc.GridBase\n */\ncc.TiledGrid3D = cc.GridBase.extend(/** @lends cc.TiledGrid3D# */{\n    _texCoordinates: null,\n    _vertices: null,\n    _originalVertices: null,\n    _indices: null,\n\n    _texCoordinateBuffer: null,\n    _verticesBuffer: null,\n    _indicesBuffer: null,\n\n    /**\n     * create one TiledGrid3D object\n     * Constructor of cc.TiledGrid3D\n     * @param {cc.Size} gridSize\n     * @param {cc.Texture2D} [texture=]\n     * @param {Boolean} [flipped=]\n     */\n    ctor: function (gridSize, texture, flipped, rect) {\n        cc.GridBase.prototype.ctor.call(this);\n        this._texCoordinates = null;\n        this._vertices = null;\n        this._originalVertices = null;\n        this._indices = null;\n\n        this._texCoordinateBuffer = null;\n        this._verticesBuffer = null;\n        this._indicesBuffer = null;\n\n        this._matrix = new cc.math.Matrix4();\n        this._matrix.identity();\n\n        if (gridSize !== undefined)\n            this.initWithSize(gridSize, texture, flipped, rect);\n    },\n\n    /**\n     * returns the tile at the given position    <br/>\n     * It will be deprecated in future, please use getTile instead.\n     * @param {cc.Point} pos\n     * @return {cc.Quad3}\n     */\n    tile: function (pos) {\n        return this.getTile(pos);\n    },\n\n    /**\n     * returns the tile at the given position\n     * @param {cc.Point} pos\n     * @return {cc.Quad3}\n     */\n    getTile: function (pos) {\n        if (pos.x !== (0 | pos.x) || pos.y !== (0 | pos.y))\n            cc.log(\"cc.TiledGrid3D.tile() : Numbers must be integers\");\n\n        var idx = (this._gridSize.height * pos.x + pos.y) * 4 * 3;\n        var locVertices = this._vertices;\n        return new cc.Quad3(new cc.Vertex3F(locVertices[idx], locVertices[idx + 1], locVertices[idx + 2]),\n            new cc.Vertex3F(locVertices[idx + 3], locVertices[idx + 4], locVertices[idx + 5]),\n            new cc.Vertex3F(locVertices[idx + 6], locVertices[idx + 7], locVertices[idx + 8]),\n            new cc.Vertex3F(locVertices[idx + 9], locVertices[idx + 10], locVertices[idx + 11]));\n    },\n\n    /**\n     * returns the original tile (untransformed) at the given position\n     * @param {cc.Point} pos\n     * @return {cc.Quad3}\n     */\n    getOriginalTile: function (pos) {\n        if (pos.x !== (0 | pos.x) || pos.y !== (0 | pos.y))\n            cc.log(\"cc.TiledGrid3D.originalTile() : Numbers must be integers\");\n\n        var idx = (this._gridSize.height * pos.x + pos.y) * 4 * 3;\n        var locOriginalVertices = this._originalVertices;\n        return new cc.Quad3(new cc.Vertex3F(locOriginalVertices[idx], locOriginalVertices[idx + 1], locOriginalVertices[idx + 2]),\n            new cc.Vertex3F(locOriginalVertices[idx + 3], locOriginalVertices[idx + 4], locOriginalVertices[idx + 5]),\n            new cc.Vertex3F(locOriginalVertices[idx + 6], locOriginalVertices[idx + 7], locOriginalVertices[idx + 8]),\n            new cc.Vertex3F(locOriginalVertices[idx + 9], locOriginalVertices[idx + 10], locOriginalVertices[idx + 11]));\n    },\n\n    /**\n     * returns the original tile (untransformed) at the given position.      <br/>\n     * It will be deprecated in future, please use getOriginalTile instead.\n     * @param {cc.Point} pos\n     * @return {cc.Quad3}\n     */\n    originalTile: function (pos) {\n        return this.getOriginalTile(pos);\n    },\n\n    /**\n     * sets a new tile\n     * @param {cc.Point} pos\n     * @param {cc.Quad3} coords\n     */\n    setTile: function (pos, coords) {\n        if (pos.x !== (0 | pos.x) || pos.y !== (0 | pos.y))\n            cc.log(\"cc.TiledGrid3D.setTile() : Numbers must be integers\");\n\n        var idx = (this._gridSize.height * pos.x + pos.y) * 12;\n        var locVertices = this._vertices;\n        locVertices[idx] = coords.bl.x;\n        locVertices[idx + 1] = coords.bl.y;\n        locVertices[idx + 2] = coords.bl.z;\n        locVertices[idx + 3] = coords.br.x;\n        locVertices[idx + 4] = coords.br.y;\n        locVertices[idx + 5] = coords.br.z;\n        locVertices[idx + 6] = coords.tl.x;\n        locVertices[idx + 7] = coords.tl.y;\n        locVertices[idx + 8] = coords.tl.z;\n        locVertices[idx + 9] = coords.tr.x;\n        locVertices[idx + 10] = coords.tr.y;\n        locVertices[idx + 11] = coords.tr.z;\n        this._dirty = true;\n    },\n\n    blit: function (target) {\n        var n = this._gridSize.width * this._gridSize.height;\n\n        var wt = target._renderCmd._worldTransform;\n        this._matrix.mat[0] = wt.a;\n        this._matrix.mat[4] = wt.c;\n        this._matrix.mat[12] = wt.tx;\n        this._matrix.mat[1] = wt.b;\n        this._matrix.mat[5] = wt.d;\n        this._matrix.mat[13] = wt.ty;\n\n        this._glProgramState.apply(this._matrix);\n\n        //\n        // Attributes\n        //\n        var gl = cc._renderContext, locDirty = this._dirty;\n        gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_POSITION);\n        gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_TEX_COORDS);\n\n        // position\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._verticesBuffer);\n        if (locDirty)\n            gl.bufferData(gl.ARRAY_BUFFER, this._vertices, gl.DYNAMIC_DRAW);\n        gl.vertexAttribPointer(cc.VERTEX_ATTRIB_POSITION, 3, gl.FLOAT, false, 0, this._vertices);\n\n        // texCoords\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._texCoordinateBuffer);\n        if (locDirty)\n            gl.bufferData(gl.ARRAY_BUFFER, this._texCoordinates, gl.DYNAMIC_DRAW);\n        gl.vertexAttribPointer(cc.VERTEX_ATTRIB_TEX_COORDS, 2, gl.FLOAT, false, 0, this._texCoordinates);\n\n        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this._indicesBuffer);\n        if (locDirty)\n            gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this._indices, gl.STATIC_DRAW);\n        gl.drawElements(gl.TRIANGLES, n * 6, gl.UNSIGNED_SHORT, 0);\n        if (locDirty)\n            this._dirty = false;\n        cc.incrementGLDraws(1);\n    },\n\n    reuse: function () {\n        if (this._reuseGrid > 0) {\n            var locVertices = this._vertices, locOriginalVertices = this._originalVertices;\n            for (var i = 0; i < locVertices.length; i++)\n                locOriginalVertices[i] = locVertices[i];\n            --this._reuseGrid;\n        }\n    },\n\n    calculateVertexPoints: function () {\n        var width = this._texture.pixelsWidth;\n        var height = this._texture.pixelsHeight;\n        var imageH = this._texture.getContentSizeInPixels().height;\n        var locGridSize = this._gridSize;\n\n        var numQuads = locGridSize.width * locGridSize.height;\n        this._vertices = new Float32Array(numQuads * 12);\n        this._texCoordinates = new Float32Array(numQuads * 8);\n        this._indices = new Uint16Array(numQuads * 6);\n\n        var gl = cc._renderContext;\n        if (this._verticesBuffer)\n            gl.deleteBuffer(this._verticesBuffer);\n        this._verticesBuffer = gl.createBuffer();\n        if (this._texCoordinateBuffer)\n            gl.deleteBuffer(this._texCoordinateBuffer);\n        this._texCoordinateBuffer = gl.createBuffer();\n        if (this._indicesBuffer)\n            gl.deleteBuffer(this._indicesBuffer);\n        this._indicesBuffer = gl.createBuffer();\n\n        var x, y, i = 0;\n        var locStep = this._step, locVertices = this._vertices, locTexCoords = this._texCoordinates, locIsTextureFlipped = this._isTextureFlipped;\n        for (x = 0; x < locGridSize.width; x++) {\n            for (y = 0; y < locGridSize.height; y++) {\n                var x1 = x * locStep.x;\n                var x2 = x1 + locStep.x;\n                var y1 = y * locStep.y;\n                var y2 = y1 + locStep.y;\n\n                locVertices[i * 12] = x1;\n                locVertices[i * 12 + 1] = y1;\n                locVertices[i * 12 + 2] = 0;\n                locVertices[i * 12 + 3] = x2;\n                locVertices[i * 12 + 4] = y1;\n                locVertices[i * 12 + 5] = 0;\n                locVertices[i * 12 + 6] = x1;\n                locVertices[i * 12 + 7] = y2;\n                locVertices[i * 12 + 8] = 0;\n                locVertices[i * 12 + 9] = x2;\n                locVertices[i * 12 + 10] = y2;\n                locVertices[i * 12 + 11] = 0;\n\n                var newY1 = y1;\n                var newY2 = y2;\n\n                if (locIsTextureFlipped) {\n                    newY1 = imageH - y1;\n                    newY2 = imageH - y2;\n                }\n\n                locTexCoords[i * 8] = x1 / width;\n                locTexCoords[i * 8 + 1] = newY1 / height;\n                locTexCoords[i * 8 + 2] = x2 / width;\n                locTexCoords[i * 8 + 3] = newY1 / height;\n                locTexCoords[i * 8 + 4] = x1 / width;\n                locTexCoords[i * 8 + 5] = newY2 / height;\n                locTexCoords[i * 8 + 6] = x2 / width;\n                locTexCoords[i * 8 + 7] = newY2 / height;\n                i++;\n            }\n        }\n\n        var locIndices = this._indices;\n        for (x = 0; x < numQuads; x++) {\n            locIndices[x * 6 + 0] = (x * 4 + 0);\n            locIndices[x * 6 + 1] = (x * 4 + 1);\n            locIndices[x * 6 + 2] = (x * 4 + 2);\n\n            locIndices[x * 6 + 3] = (x * 4 + 1);\n            locIndices[x * 6 + 4] = (x * 4 + 2);\n            locIndices[x * 6 + 5] = (x * 4 + 3);\n        }\n        this._originalVertices = new Float32Array(this._vertices);\n\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._verticesBuffer);\n        gl.bufferData(gl.ARRAY_BUFFER, this._vertices, gl.DYNAMIC_DRAW);\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._texCoordinateBuffer);\n        gl.bufferData(gl.ARRAY_BUFFER, this._texCoordinates, gl.DYNAMIC_DRAW);\n        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this._indicesBuffer);\n        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this._indices, gl.DYNAMIC_DRAW);\n        this._dirty = true;\n    }\n});\n\n/**\n * create one TiledGrid3D object\n * @deprecated since v3.0, please use new cc.TiledGrid3D(gridSize, texture, flipped) instead\n * @param {cc.Size} gridSize\n * @param {cc.Texture2D} [texture=]\n * @param {Boolean} [flipped=]\n * @return {cc.TiledGrid3D}\n */\ncc.TiledGrid3D.create = function (gridSize, texture, flipped) {\n    return new cc.TiledGrid3D(gridSize, texture, flipped);\n};\n"]}