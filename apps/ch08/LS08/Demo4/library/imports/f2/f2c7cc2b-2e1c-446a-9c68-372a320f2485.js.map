{"version":3,"sources":["../../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/core/base-nodes/assets/frameworks/cocos2d-html5/cocos2d/core/base-nodes/CCAtlasNodeWebGLRenderCmd.js"],"names":["cc","AtlasNode","WebGLRenderCmd","renderableObject","_rootCtor","_needDraw","_textureAtlas","_colorUnmodified","color","WHITE","_colorF32Array","_uniformColor","_matrix","math","Matrix4","identity","_shaderProgram","shaderCache","programForKey","SHADER_POSITION_TEXTURE_UCOLOR","_renderContext","getUniformLocation","getProgram","proto","prototype","Object","create","Node","constructor","_updateBlendFunc","node","_node","texture","hasPremultipliedAlpha","_blendFunc","src","SRC_ALPHA","dst","ONE_MINUS_SRC_ALPHA","_updateOpacityModifyRGB","_opacityModifyRGB","rendering","ctx","context","wt","_worldTransform","mat","a","c","tx","b","d","ty","_glProgramState","apply","glBlendFunc","uniform4fv","drawNumberOfQuads","quadsToDraw","initWithTexture","tileWidth","tileHeight","itemsToRender","_itemWidth","_itemHeight","BLEND_SRC","BLEND_DST","locRealColor","_realColor","Float32Array","r","g","_realOpacity","TextureAtlas","log","_LogInfos","AtlasNode__initWithTexture","_calculateMaxItems","setColor","color3","temp","locDisplayedOpacity","_displayedOpacity","call","setOpacity","opacity","_updateColor","locDisplayedColor","_displayedColor","getTexture","setTexture","selTexture","size","getContentSize","_ignoreContentScaleFactor","getContentSizeInPixels","_itemsPerColumn","height","_itemsPerRow","width"],"mappings":"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","file":"CCAtlasNodeWebGLRenderCmd.js","sourceRoot":"../../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/core/base-nodes","sourcesContent":["/****************************************************************************\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\n/**\n * cc.AtlasNode's rendering objects of WebGL\n */\n(function () {\n    cc.AtlasNode.WebGLRenderCmd = function (renderableObject) {\n        this._rootCtor(renderableObject);\n        this._needDraw = true;\n        this._textureAtlas = null;\n        this._colorUnmodified = cc.color.WHITE;\n        this._colorF32Array = null;\n        this._uniformColor = null;\n\n        this._matrix = new cc.math.Matrix4();\n        this._matrix.identity();\n\n        //shader stuff\n        this._shaderProgram = cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURE_UCOLOR);\n        this._uniformColor = cc._renderContext.getUniformLocation(this._shaderProgram.getProgram(), \"u_color\");\n    };\n\n    var proto = cc.AtlasNode.WebGLRenderCmd.prototype = Object.create(cc.Node.WebGLRenderCmd.prototype);\n    proto.constructor = cc.AtlasNode.WebGLRenderCmd;\n\n    proto._updateBlendFunc = function () {\n        var node = this._node;\n        if (!this._textureAtlas.texture.hasPremultipliedAlpha()) {\n            node._blendFunc.src = cc.SRC_ALPHA;\n            node._blendFunc.dst = cc.ONE_MINUS_SRC_ALPHA;\n        }\n    };\n\n    proto._updateOpacityModifyRGB = function () {\n        this._node._opacityModifyRGB = this._textureAtlas.texture.hasPremultipliedAlpha();\n    };\n\n    proto.rendering = function (ctx) {\n        var context = ctx || cc._renderContext, node = this._node;\n\n        var wt = this._worldTransform;\n        this._matrix.mat[0] = wt.a;\n        this._matrix.mat[4] = wt.c;\n        this._matrix.mat[12] = wt.tx;\n        this._matrix.mat[1] = wt.b;\n        this._matrix.mat[5] = wt.d;\n        this._matrix.mat[13] = wt.ty;\n\n        this._glProgramState.apply(this._matrix);\n\n        cc.glBlendFunc(node._blendFunc.src, node._blendFunc.dst);\n        if (this._uniformColor && this._colorF32Array) {\n            context.uniform4fv(this._uniformColor, this._colorF32Array);\n            this._textureAtlas.drawNumberOfQuads(node.quadsToDraw, 0);\n        }\n    };\n\n    proto.initWithTexture = function (texture, tileWidth, tileHeight, itemsToRender) {\n        var node = this._node;\n        node._itemWidth = tileWidth;\n        node._itemHeight = tileHeight;\n        this._colorUnmodified = cc.color.WHITE;\n        node._opacityModifyRGB = true;\n\n        node._blendFunc.src = cc.BLEND_SRC;\n        node._blendFunc.dst = cc.BLEND_DST;\n\n        var locRealColor = node._realColor;\n        this._colorF32Array = new Float32Array([locRealColor.r / 255.0, locRealColor.g / 255.0, locRealColor.b / 255.0, node._realOpacity / 255.0]);\n        this._textureAtlas = new cc.TextureAtlas();\n        this._textureAtlas.initWithTexture(texture, itemsToRender);\n\n        if (!this._textureAtlas) {\n            cc.log(cc._LogInfos.AtlasNode__initWithTexture);\n            return false;\n        }\n\n        this._updateBlendFunc();\n        this._updateOpacityModifyRGB();\n        this._calculateMaxItems();\n        node.quadsToDraw = itemsToRender;\n\n        return true;\n    };\n\n    proto.setColor = function (color3) {\n        var temp = cc.color(color3.r, color3.g, color3.b), node = this._node;\n        this._colorUnmodified = color3;\n        var locDisplayedOpacity = this._displayedOpacity;\n        if (node._opacityModifyRGB) {\n            temp.r = temp.r * locDisplayedOpacity / 255;\n            temp.g = temp.g * locDisplayedOpacity / 255;\n            temp.b = temp.b * locDisplayedOpacity / 255;\n        }\n        cc.Node.prototype.setColor.call(node, temp);\n    };\n\n    proto.setOpacity = function (opacity) {\n        var node = this._node;\n        cc.Node.prototype.setOpacity.call(node, opacity);\n        // special opacity for premultiplied textures\n        if (node._opacityModifyRGB) {\n            node.color = this._colorUnmodified;\n        }\n    };\n\n    proto._updateColor = function () {\n        if (this._colorF32Array) {\n            var locDisplayedColor = this._displayedColor;\n            this._colorF32Array[0] = locDisplayedColor.r / 255.0;\n            this._colorF32Array[1] = locDisplayedColor.g / 255.0;\n            this._colorF32Array[2] = locDisplayedColor.b / 255.0;\n            this._colorF32Array[3] = this._displayedOpacity / 255.0;\n        }\n    };\n\n    proto.getTexture = function () {\n        return this._textureAtlas.texture;\n    };\n\n    proto.setTexture = function (texture) {\n        this._textureAtlas.texture = texture;\n        this._updateBlendFunc();\n        this._updateOpacityModifyRGB();\n    };\n\n    proto._calculateMaxItems = function () {\n        var node = this._node;\n        var selTexture = this._textureAtlas.texture;\n        var size = selTexture.getContentSize();\n        if (node._ignoreContentScaleFactor)\n            size = selTexture.getContentSizeInPixels();\n\n        node._itemsPerColumn = 0 | (size.height / node._itemHeight);\n        node._itemsPerRow = 0 | (size.width / node._itemWidth);\n    };\n})();\n"]}