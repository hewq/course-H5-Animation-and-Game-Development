{"version":3,"sources":["../../../../../../../../assets/frameworks/cocos2d-html5/extensions/cocostudio/armature/assets/frameworks/cocos2d-html5/extensions/cocostudio/armature/CCArmatureWebGLRenderCmd.js"],"names":["ccs","Armature","WebGLRenderCmd","renderableObject","_rootCtor","_needDraw","_parentCmd","_realAnchorPointInPoints","cc","Point","_transform","a","b","c","d","tx","ty","_worldTransform","proto","prototype","Object","create","Node","inject","RenderCmd","constructor","uploadData","f32buffer","ui32buffer","vertexDataOffset","node","_node","cmd","parentCmd","locChildren","_children","alphaPremultiplied","BlendFunc","ALPHA_PREMULTIPLIED","alphaNonPremultipled","ALPHA_NON_PREMULTIPLIED","i","len","length","selBone","boneCmd","_renderCmd","getDisplayRenderNode","selNode","getDisplayRenderNodeType","DISPLAY_TYPE_SPRITE","Skin","setShaderProgram","_shaderProgram","_updateColorAndOpacity","transform","func","getBlendFunc","src","dst","setBlendFunc","tex","getTexture","_blendFunc","hasPremultipliedAlpha","renderer","_uploadBufferData","DISPLAY_TYPE_ARMATURE","_syncStatus","rendering","_batchRendering","_renderContext","initShaderCache","shaderCache","programForKey","SHADER_SPRITE_POSITION_TEXTURECOLOR","shaderProgram","_glProgramState","GLProgramState","getOrCreateWithGLProgram","skinRenderCmd","bone","parentColor","_displayedColor","parentOpacity","_displayedOpacity","flags","_dirtyFlags","locFlag","_dirtyFlag","colorDirty","opacityDirty","_updateDisplayColor","_updateDisplayOpacity","_updateColor","visit","_visible","getParentRenderCmd","_curLevel","sortAllChildren","children","child","isNaN","_customZ","_vertexZ","assignedZ","assignedZStep","_localZOrder","pushRenderCommand"],"mappings":";;;;;;AAAA;;;;;;;;;;;;;;;;;;;;;;;;AAwBA,CAAC,YAAY;;AAETA,QAAIC,QAAJ,CAAaC,cAAb,GAA8B,UAAUC,gBAAV,EAA4B;AACtD,aAAKC,SAAL,CAAeD,gBAAf;AACA,aAAKE,SAAL,GAAiB,IAAjB;;AAEA,aAAKC,UAAL,GAAkB,IAAlB;AACA,aAAKC,wBAAL,GAAgC,IAAIC,GAAGC,KAAP,CAAa,CAAb,EAAgB,CAAhB,CAAhC;;AAEA,aAAKC,UAAL,GAAkB,EAACC,GAAG,CAAJ,EAAOC,GAAG,CAAV,EAAaC,GAAG,CAAhB,EAAmBC,GAAG,CAAtB,EAAyBC,IAAI,CAA7B,EAAgCC,IAAI,CAApC,EAAlB;AACA,aAAKC,eAAL,GAAuB,EAACN,GAAG,CAAJ,EAAOC,GAAG,CAAV,EAAaC,GAAG,CAAhB,EAAmBC,GAAG,CAAtB,EAAyBC,IAAI,CAA7B,EAAgCC,IAAI,CAApC,EAAvB;AACH,KATD;;AAWA,QAAIE,QAAQlB,IAAIC,QAAJ,CAAaC,cAAb,CAA4BiB,SAA5B,GAAwCC,OAAOC,MAAP,CAAcb,GAAGc,IAAH,CAAQpB,cAAR,CAAuBiB,SAArC,CAApD;AACAX,OAAGe,MAAH,CAAUvB,IAAIC,QAAJ,CAAauB,SAAvB,EAAkCN,KAAlC;AACAA,UAAMO,WAAN,GAAoBzB,IAAIC,QAAJ,CAAaC,cAAjC;;AAEAgB,UAAMQ,UAAN,GAAmB,UAAUC,SAAV,EAAqBC,UAArB,EAAiCC,gBAAjC,EAAmD;AAClE,YAAIC,OAAO,KAAKC,KAAhB;AAAA,YAAuBC,GAAvB;AACA,YAAIC,YAAY,KAAK3B,UAAL,IAAmB,IAAnC;;AAEA,YAAI4B,cAAcJ,KAAKK,SAAvB;AACA,YAAIC,qBAAqB5B,GAAG6B,SAAH,CAAaC,mBAAtC;AAAA,YAA2DC,uBAAuB/B,GAAG6B,SAAH,CAAaG,uBAA/F;AACA,aAAK,IAAIC,IAAI,CAAR,EAAWC,MAAMR,YAAYS,MAAlC,EAA0CF,IAAIC,GAA9C,EAAmDD,GAAnD,EAAwD;AACpD,gBAAIG,UAAUV,YAAYO,CAAZ,CAAd;AACA,gBAAII,UAAUD,QAAQE,UAAtB;AACA,gBAAIF,WAAWA,QAAQG,oBAAvB,EAA6C;AACzC,oBAAIC,UAAUJ,QAAQG,oBAAR,EAAd;AACA,oBAAI,SAASC,OAAb,EACI;AACJhB,sBAAMgB,QAAQF,UAAd;AACA,wBAAQF,QAAQK,wBAAR,EAAR;AACI,yBAAKjD,IAAIkD,mBAAT;AACI,4BAAIF,mBAAmBhD,IAAImD,IAA3B,EAAiC;AAC7BH,oCAAQI,gBAAR,CAAyB,KAAKC,cAA9B;AACA,iCAAKC,sBAAL,CAA4BtB,GAA5B,EAAiCY,OAAjC,EAF6B,CAEgB;AAC7CZ,gCAAIuB,SAAJ,CAActB,SAAd;;AAEA,gCAAIuB,OAAOZ,QAAQa,YAAR,EAAX;AACA,gCAAID,KAAKE,GAAL,KAAatB,mBAAmBsB,GAAhC,IAAuCF,KAAKG,GAAL,KAAavB,mBAAmBuB,GAA3E,EACIX,QAAQY,YAAR,CAAqBhB,QAAQa,YAAR,EAArB,EADJ,KAEK;AACD,oCAAII,MAAMb,QAAQc,UAAR,EAAV;AACA,oCAAIhC,KAAKiC,UAAL,CAAgBL,GAAhB,KAAwBtB,mBAAmBsB,GAA3C,IACA5B,KAAKiC,UAAL,CAAgBJ,GAAhB,KAAwBvB,mBAAmBuB,GAD3C,IAEAE,GAFA,IAEO,CAACA,IAAIG,qBAAJ,EAFZ,EAEyC;AACrChB,4CAAQY,YAAR,CAAqBrB,oBAArB;AACH,iCAJD,MAKK;AACDS,4CAAQY,YAAR,CAAqB9B,KAAKiC,UAA1B;AACH;AACJ;AACD;AACAvD,+BAAGyD,QAAH,CAAYC,iBAAZ,CAA8BlC,GAA9B;AACH;AACD;AACJ,yBAAKhC,IAAImE,qBAAT;AACInB,gCAAQI,gBAAR,CAAyB,KAAKC,cAA9B;AACA,6BAAKC,sBAAL,CAA4BtB,GAA5B,EAAiCY,OAAjC;AACAZ,4BAAI1B,UAAJ,GAAiB,IAAjB;AACJ;AACA;AACIuC,gCAAQuB,WAAR,CAAoBnC,SAApB;AACAD,4BAAIoC,WAAJ,CAAgBvB,OAAhB;AACA,4BAAIb,IAAIN,UAAR,EAAoB;AAChBlB,+BAAGyD,QAAH,CAAYC,iBAAZ,CAA8BlC,GAA9B;AACH,yBAFD,MAGK,IAAIA,IAAIqC,SAAR,EAAmB;AACpB;AACA7D,+BAAGyD,QAAH,CAAYK,eAAZ;AACAtC,gCAAIqC,SAAJ,CAAc7D,GAAG+D,cAAjB;AACH;AACD;AAzCR;AA2CH,aAhDD,MAgDO,IAAI3B,mBAAmBpC,GAAGc,IAA1B,EAAgC;AACnCsB,wBAAQQ,gBAAR,CAAyB,KAAKC,cAA9B;AACAR,wBAAQuB,WAAR,CAAoBnC,SAApB;AACA,oBAAIY,QAAQnB,UAAZ,EAAwB;AACpBlB,uBAAGyD,QAAH,CAAYC,iBAAZ,CAA8BrB,OAA9B;AACH,iBAFD,MAGK,IAAIA,QAAQwB,SAAZ,EAAuB;AACxB;AACA7D,uBAAGyD,QAAH,CAAYK,eAAZ;AACAzB,4BAAQwB,SAAR,CAAkB7D,GAAG+D,cAArB;AACH;AACJ;AACJ;AACD,aAAKjE,UAAL,GAAkB,IAAlB;AACA,eAAO,CAAP;AACH,KAxED;;AA0EAY,UAAMsD,eAAN,GAAwB,YAAY;AAChC,aAAKnB,cAAL,GAAsB7C,GAAGiE,WAAH,CAAeC,aAAf,CAA6BlE,GAAGmE,mCAAhC,CAAtB;AACH,KAFD;;AAIAzD,UAAMkC,gBAAN,GAAyB,UAAUwB,aAAV,EAAyB;AAC9C,aAAKC,eAAL,GAAuBrE,GAAGsE,cAAH,CAAkBC,wBAAlB,CAA2CH,aAA3C,CAAvB;AACH,KAFD;;AAIA1D,UAAMoC,sBAAN,GAA+B,UAAU0B,aAAV,EAAyBC,IAAzB,EAA+B;AAC1D;AACA,YAAIC,cAAcD,KAAKnC,UAAL,CAAgBqC,eAAlC;AAAA,YAAmDC,gBAAgBH,KAAKnC,UAAL,CAAgBuC,iBAAnF;;AAEA,YAAIC,QAAQ9E,GAAGc,IAAH,CAAQiE,WAApB;AAAA,YAAiCC,UAAUR,cAAcS,UAAzD;AACA,YAAIC,aAAaF,UAAUF,MAAMI,UAAjC;AAAA,YACIC,eAAeH,UAAUF,MAAMK,YADnC;AAEA,YAAID,UAAJ,EACIV,cAAcY,mBAAd,CAAkCV,WAAlC;AACJ,YAAIS,YAAJ,EACIX,cAAca,qBAAd,CAAoCT,aAApC;AACJ,YAAIM,cAAcC,YAAlB,EACIX,cAAcc,YAAd;AACP,KAbD;;AAeA5E,UAAM6E,KAAN,GAAc,UAAU9D,SAAV,EAAqB;AAC/B,YAAIH,OAAO,KAAKC,KAAhB;AACA;AACA,YAAI,CAACD,KAAKkE,QAAV,EACI;;AAEJ/D,oBAAYA,aAAa,KAAKgE,kBAAL,EAAzB;AACA,YAAIhE,SAAJ,EACI,KAAKiE,SAAL,GAAiBjE,UAAUiE,SAAV,GAAsB,CAAvC;;AAEJ,aAAK9B,WAAL,CAAiBnC,SAAjB;;AAEAH,aAAKqE,eAAL;AACA,YAAIlC,WAAWzD,GAAGyD,QAAlB;AAAA,YACImC,WAAWtE,KAAKK,SADpB;AAAA,YAC+BkE,KAD/B;AAAA,YAEI5D,CAFJ;AAAA,YAEOC,MAAM0D,SAASzD,MAFtB;;AAIA,YAAI2D,MAAMxE,KAAKyE,QAAX,CAAJ,EAA0B;AACtBzE,iBAAK0E,QAAL,GAAgBvC,SAASwC,SAAzB;AACAxC,qBAASwC,SAAT,IAAsBxC,SAASyC,aAA/B;AACH;;AAED,aAAKjE,IAAI,CAAT,EAAYA,IAAIC,GAAhB,EAAqBD,GAArB,EAA0B;AACtB4D,oBAAQD,SAAS3D,CAAT,CAAR;AACA,gBAAI4D,MAAMM,YAAN,GAAqB,CAAzB,EAA4B;AACxB,oBAAIL,MAAMD,MAAME,QAAZ,CAAJ,EAA2B;AACvBF,0BAAMG,QAAN,GAAiBvC,SAASwC,SAA1B;AACAxC,6BAASwC,SAAT,IAAsBxC,SAASyC,aAA/B;AACH;AACJ,aALD,MAMK;AACD;AACH;AACJ;;AAEDzC,iBAAS2C,iBAAT,CAA2B,IAA3B;AACA,eAAOnE,IAAIC,GAAX,EAAgBD,GAAhB,EAAqB;AACjB4D,oBAAQD,SAAS3D,CAAT,CAAR;AACA,gBAAI6D,MAAMD,MAAME,QAAZ,CAAJ,EAA2B;AACvBF,sBAAMG,QAAN,GAAiBvC,SAASwC,SAA1B;AACAxC,yBAASwC,SAAT,IAAsBxC,SAASyC,aAA/B;AACH;AACJ;;AAED,aAAKjB,UAAL,GAAkB,CAAlB;AACH,KA7CD;AA8CH,CAhKD","file":"CCArmatureWebGLRenderCmd.js","sourceRoot":"../../../../../../../../assets/frameworks/cocos2d-html5/extensions/cocostudio/armature","sourcesContent":["/****************************************************************************\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\n(function () {\n\n    ccs.Armature.WebGLRenderCmd = function (renderableObject) {\n        this._rootCtor(renderableObject);\n        this._needDraw = true;\n\n        this._parentCmd = null;\n        this._realAnchorPointInPoints = new cc.Point(0, 0);\n\n        this._transform = {a: 1, b: 0, c: 0, d: 1, tx: 0, ty: 0};\n        this._worldTransform = {a: 1, b: 0, c: 0, d: 1, tx: 0, ty: 0};\n    };\n\n    var proto = ccs.Armature.WebGLRenderCmd.prototype = Object.create(cc.Node.WebGLRenderCmd.prototype);\n    cc.inject(ccs.Armature.RenderCmd, proto);\n    proto.constructor = ccs.Armature.WebGLRenderCmd;\n\n    proto.uploadData = function (f32buffer, ui32buffer, vertexDataOffset) {\n        var node = this._node, cmd;\n        var parentCmd = this._parentCmd || this;\n\n        var locChildren = node._children;\n        var alphaPremultiplied = cc.BlendFunc.ALPHA_PREMULTIPLIED, alphaNonPremultipled = cc.BlendFunc.ALPHA_NON_PREMULTIPLIED;\n        for (var i = 0, len = locChildren.length; i < len; i++) {\n            var selBone = locChildren[i];\n            var boneCmd = selBone._renderCmd;\n            if (selBone && selBone.getDisplayRenderNode) {\n                var selNode = selBone.getDisplayRenderNode();\n                if (null === selNode)\n                    continue;\n                cmd = selNode._renderCmd;\n                switch (selBone.getDisplayRenderNodeType()) {\n                    case ccs.DISPLAY_TYPE_SPRITE:\n                        if (selNode instanceof ccs.Skin) {\n                            selNode.setShaderProgram(this._shaderProgram);\n                            this._updateColorAndOpacity(cmd, selBone);   //because skin didn't call visit()\n                            cmd.transform(parentCmd);\n\n                            var func = selBone.getBlendFunc();\n                            if (func.src !== alphaPremultiplied.src || func.dst !== alphaPremultiplied.dst)\n                                selNode.setBlendFunc(selBone.getBlendFunc());\n                            else {\n                                var tex = selNode.getTexture();\n                                if (node._blendFunc.src === alphaPremultiplied.src &&\n                                    node._blendFunc.dst === alphaPremultiplied.dst &&\n                                    tex && !tex.hasPremultipliedAlpha()) {\n                                    selNode.setBlendFunc(alphaNonPremultipled);\n                                }\n                                else {\n                                    selNode.setBlendFunc(node._blendFunc);\n                                }\n                            }\n                            // Support batch for Armature skin\n                            cc.renderer._uploadBufferData(cmd);\n                        }\n                        break;\n                    case ccs.DISPLAY_TYPE_ARMATURE:\n                        selNode.setShaderProgram(this._shaderProgram);\n                        this._updateColorAndOpacity(cmd, selBone);\n                        cmd._parentCmd = this;\n                    // Continue rendering in default\n                    default:\n                        boneCmd._syncStatus(parentCmd);\n                        cmd._syncStatus(boneCmd);\n                        if (cmd.uploadData) {\n                            cc.renderer._uploadBufferData(cmd);\n                        }\n                        else if (cmd.rendering) {\n                            // Finish previous batch\n                            cc.renderer._batchRendering();\n                            cmd.rendering(cc._renderContext);\n                        }\n                        break;\n                }\n            } else if (selBone instanceof cc.Node) {\n                selBone.setShaderProgram(this._shaderProgram);\n                boneCmd._syncStatus(parentCmd);\n                if (boneCmd.uploadData) {\n                    cc.renderer._uploadBufferData(boneCmd);\n                }\n                else if (boneCmd.rendering) {\n                    // Finish previous batch\n                    cc.renderer._batchRendering();\n                    boneCmd.rendering(cc._renderContext);\n                }\n            }\n        }\n        this._parentCmd = null;\n        return 0;\n    };\n\n    proto.initShaderCache = function () {\n        this._shaderProgram = cc.shaderCache.programForKey(cc.SHADER_SPRITE_POSITION_TEXTURECOLOR);\n    };\n\n    proto.setShaderProgram = function (shaderProgram) {\n        this._glProgramState = cc.GLProgramState.getOrCreateWithGLProgram(shaderProgram);\n    };\n\n    proto._updateColorAndOpacity = function (skinRenderCmd, bone) {\n        //update displayNode's color and opacity\n        var parentColor = bone._renderCmd._displayedColor, parentOpacity = bone._renderCmd._displayedOpacity;\n\n        var flags = cc.Node._dirtyFlags, locFlag = skinRenderCmd._dirtyFlag;\n        var colorDirty = locFlag & flags.colorDirty,\n            opacityDirty = locFlag & flags.opacityDirty;\n        if (colorDirty)\n            skinRenderCmd._updateDisplayColor(parentColor);\n        if (opacityDirty)\n            skinRenderCmd._updateDisplayOpacity(parentOpacity);\n        if (colorDirty || opacityDirty)\n            skinRenderCmd._updateColor();\n    };\n\n    proto.visit = function (parentCmd) {\n        var node = this._node;\n        // quick return if not visible. children won't be drawn.\n        if (!node._visible)\n            return;\n\n        parentCmd = parentCmd || this.getParentRenderCmd();\n        if (parentCmd)\n            this._curLevel = parentCmd._curLevel + 1;\n\n        this._syncStatus(parentCmd);\n\n        node.sortAllChildren();\n        var renderer = cc.renderer,\n            children = node._children, child,\n            i, len = children.length;\n\n        if (isNaN(node._customZ)) {\n            node._vertexZ = renderer.assignedZ;\n            renderer.assignedZ += renderer.assignedZStep;\n        }\n\n        for (i = 0; i < len; i++) {\n            child = children[i];\n            if (child._localZOrder < 0) {\n                if (isNaN(child._customZ)) {\n                    child._vertexZ = renderer.assignedZ;\n                    renderer.assignedZ += renderer.assignedZStep;\n                }\n            }\n            else {\n                break;\n            }\n        }\n\n        renderer.pushRenderCommand(this);\n        for (; i < len; i++) {\n            child = children[i];\n            if (isNaN(child._customZ)) {\n                child._vertexZ = renderer.assignedZ;\n                renderer.assignedZ += renderer.assignedZStep;\n            }\n        }\n\n        this._dirtyFlag = 0;\n    };\n})();\n"]}