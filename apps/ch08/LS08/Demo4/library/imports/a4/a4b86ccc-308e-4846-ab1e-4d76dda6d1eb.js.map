{"version":3,"sources":["../../../../../../assets/frameworks/cocos2d-html5/tools/assets/frameworks/cocos2d-html5/tools/publish.js"],"names":["exec","require","fs","path","core4cc","console","log","projectDir","join","__dirname","projectJson","engineDir","realEngineDir","realPublishDir","buildOpt","outputFileName","compilationLevel","sourceMapOpened","existsSync","mkdirSyncRecursive","externalList","outputJsPath","unlinkSync","err","data","info","error","sourceMapPath","smContent","readFileSync","toString","replace","RegExp","relative","writeFileSync","modules","jsList","JSON","stringify","publishResDir","rmdirSyncRecursive","copyFiles","indexContent","externalScript","forEach","external"],"mappings":"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","file":"publish.js","sourceRoot":"../../../../../../assets/frameworks/cocos2d-html5/tools","sourcesContent":["var exec = require(\"child_process\").exec;\nvar fs = require(\"fs\");\nvar path = require(\"path\");\nvar core4cc = require(\"./core4cc\");\nconsole.log(\"Publishing...\");\n\nvar projectDir = path.join(__dirname, \"../\");\n\nvar projectJson = require(path.join(projectDir, \"project.json\"));\nvar engineDir = path.join(projectJson.engineDir || \"frameworks/cocos2d-html5\", \"/\");\nvar realEngineDir = path.join(projectDir, engineDir, \"/\");\n\nvar realPublishDir = path.join(projectDir, \"publish/html5\");\n\nvar buildOpt = {\n    outputFileName : \"game.min.js\",\n//    compilationLevel : \"simple\",\n    compilationLevel : \"advanced\",\n    sourceMapOpened : true\n};\n\nif(!fs.existsSync(realPublishDir)) core4cc.mkdirSyncRecursive(realPublishDir);\n\nvar externalList = require(\"./genBuildXml\")(projectDir, projectJson, buildOpt);\n\nvar outputJsPath = path.join(realPublishDir, buildOpt.outputFileName);\nif(fs.existsSync(outputJsPath)) fs.unlinkSync(outputJsPath);\n\nexec(\"cd \" + realPublishDir + \" && ant\", function(err, data, info){\n    console.log(info);\n    console.log(data);\n    if(err) {\n        console.error(err);\n        console.log(err[0]);\n        return console.log(\"Failed!\")\n    }\n    var sourceMapPath = path.join(realPublishDir, \"sourcemap\");\n    if(fs.existsSync(sourceMapPath)){\n        var smContent = fs.readFileSync(sourceMapPath).toString();\n        smContent = smContent.replace(new RegExp(path.join(projectDir, \"/\").replace(/\\\\/g, \"\\\\\\\\\\\\\\\\\") , \"gi\"), path.join(path.relative(realPublishDir, projectDir), \"/\"));\n        smContent = smContent.replace(new RegExp(path.join(realEngineDir, \"/\").replace(/\\\\/g, \"\\\\\\\\\\\\\\\\\"), \"gi\"), path.join(path.relative(realPublishDir, realEngineDir), \"/\"));\n        fs.writeFileSync(sourceMapPath, smContent);\n    }\n\n    delete projectJson.engineDir;\n    delete projectJson.modules;\n    delete projectJson.jsList;\n    fs.writeFileSync(path.join(realPublishDir, \"project.json\"), JSON.stringify(projectJson, null, 4));\n\n    var publishResDir = path.join(realPublishDir, \"res\");\n    core4cc.rmdirSyncRecursive(publishResDir);\n    core4cc.copyFiles(path.join(projectDir, \"res\"), publishResDir);\n\n    var indexContent = fs.readFileSync(path.join(projectDir, \"index.html\")).toString();\n    var externalScript = \"\";\n    externalList.forEach(function(external){\n        externalScript += \"<script src=\\\"\" + path.join(\"../../\", engineDir, external) + \"\\\"></script>\\n\";\n    });\n    indexContent = indexContent.replace(/<script\\s+src\\s*=\\s*(\"|')[^\"']*CCBoot\\.js(\"|')\\s*><\\/script>/g, externalScript);\n    indexContent = indexContent.replace(/\"main\\.js\"\\s*/, '\"' + buildOpt.outputFileName + '\"');\n\n    externalScript = \"\";\n    [\n        \"external/pluginx/platform/facebook_sdk.js\",\n        \"external/pluginx/platform/facebook.js\"\n    ].forEach(function(external){\n        externalScript += \"\\n<script src=\\\"\" + path.join(\"../../\", engineDir, external) + \"\\\"></script>\";\n    });\n    indexContent += externalScript;\n    fs.writeFileSync(path.join(realPublishDir, \"index.html\"), indexContent);\n    console.log(\"Finished!\")\n});"]}