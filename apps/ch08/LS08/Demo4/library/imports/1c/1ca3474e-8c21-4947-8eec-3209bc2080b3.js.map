{"version":3,"sources":["../../../../../../../../../assets/frameworks/cocos2d-html5/extensions/cocostudio/armature/display/assets/frameworks/cocos2d-html5/extensions/cocostudio/armature/display/CCDisplayFactory.js"],"names":["ccs","displayFactory","addDisplay","bone","decoDisplay","displayData","displayType","DISPLAY_TYPE_SPRITE","addSpriteDisplay","DISPLAY_TYPE_PARTICLE","addParticleDisplay","DISPLAY_TYPE_ARMATURE","addArmatureDisplay","createDisplay","getDisplayData","createSpriteDisplay","createParticleDisplay","createArmatureDisplay","_helpTransform","a","b","c","d","tx","ty","updateDisplay","dt","dirty","display","getDisplayRenderNode","getDisplayRenderNodeType","_renderCmd","setDirtyFlag","cc","Node","_dirtyFlags","transformDirty","updateArmatureTransform","updateParticleDisplay","updateArmatureDisplay","transform","getNodeToArmatureTransform","setAdditionalTransform","ENABLE_PHYSICS_CHIPMUNK_DETECT","ENABLE_PHYSICS_SAVE_CALCULATED_VERTEX","getDisplayManager","getCurrentDecorativeDisplay","detector","getColliderDetector","node","getDisplay","displayTransform","getNodeToParentTransform","helpTransform","anchorPoint","pointApplyAffineTransform","getAnchorPointInPoints","x","y","t","affineTransformConcat","getArmature","updateTransform","sdp","SpriteDisplayData","copy","setDisplayData","skin","textureName","displayName","startPos","lastIndexOf","substring","Skin","setDisplay","setBone","initSpriteDisplay","armature","getArmatureData","dataVersion","CONST_VERSION_COMBINED","setSkinData","skinData","boneData","textureData","armatureDataManager","getTextureData","setAnchorPoint","p","pivotX","pivotY","contourDataList","length","colliderDetector","ColliderDetector","addContourDataList","setColliderDetector","adp","ArmatureDisplayData","Armature","sortAllChildren","update","ParticleDisplayData","system","ParticleSystem","removeFromParent","cleanup","setParent","particleSystem","BaseData","TransformHelp","matrixToNode","nodeToArmatureTransform","setPosition","setScaleX","scaleX","setScaleY","scaleY"],"mappings":"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","file":"CCDisplayFactory.js","sourceRoot":"../../../../../../../../../assets/frameworks/cocos2d-html5/extensions/cocostudio/armature/display","sourcesContent":["/****************************************************************************\n Copyright (c) 2011-2012 cocos2d-x.org\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\n/**\n * @ignore\n */\nccs.displayFactory = {\n    addDisplay: function (bone, decoDisplay, displayData) {\n        switch (displayData.displayType) {\n            case ccs.DISPLAY_TYPE_SPRITE:\n                this.addSpriteDisplay(bone, decoDisplay, displayData);\n                break;\n            case ccs.DISPLAY_TYPE_PARTICLE:\n                this.addParticleDisplay(bone, decoDisplay, displayData);\n                break;\n            case ccs.DISPLAY_TYPE_ARMATURE:\n                this.addArmatureDisplay(bone, decoDisplay, displayData);\n                break;\n            default:\n                break;\n        }\n    },\n\n    createDisplay: function (bone, decoDisplay) {\n        switch (decoDisplay.getDisplayData().displayType) {\n            case ccs.DISPLAY_TYPE_SPRITE:\n                this.createSpriteDisplay(bone, decoDisplay);\n                break;\n            case ccs.DISPLAY_TYPE_PARTICLE:\n                this.createParticleDisplay(bone, decoDisplay);\n                break;\n            case ccs.DISPLAY_TYPE_ARMATURE:\n                this.createArmatureDisplay(bone, decoDisplay);\n                break;\n            default:\n                break;\n        }\n    },\n\n    _helpTransform: {a:1, b:0, c:0, d:1, tx:0, ty:0},\n    updateDisplay: function (bone, dt, dirty) {\n        var display = bone.getDisplayRenderNode();\n        if(!display)\n            return;\n\n        switch (bone.getDisplayRenderNodeType()) {\n            case ccs.DISPLAY_TYPE_SPRITE:\n                if (dirty) {\n                    display._renderCmd.setDirtyFlag(cc.Node._dirtyFlags.transformDirty);\n                    display.updateArmatureTransform();\n                }\n                break;\n            case ccs.DISPLAY_TYPE_PARTICLE:\n                this.updateParticleDisplay(bone, display, dt);\n                break;\n            case ccs.DISPLAY_TYPE_ARMATURE:\n                this.updateArmatureDisplay(bone, display, dt);\n                break;\n            default:\n                var transform = bone.getNodeToArmatureTransform();\n                display.setAdditionalTransform(transform);\n                break;\n        }\n        if (ccs.ENABLE_PHYSICS_CHIPMUNK_DETECT || ccs.ENABLE_PHYSICS_SAVE_CALCULATED_VERTEX) {\n            if (dirty) {\n                var decoDisplay = bone.getDisplayManager().getCurrentDecorativeDisplay();\n                var detector = decoDisplay.getColliderDetector();\n                if (detector) {\n                    var node = decoDisplay.getDisplay();\n                    var displayTransform = node.getNodeToParentTransform();\n                    var helpTransform = this._helpTransform;\n                    helpTransform.a = displayTransform.a;\n                    helpTransform.b = displayTransform.b;\n                    helpTransform.c = displayTransform.c;\n                    helpTransform.d = displayTransform.d;\n                    helpTransform.tx = displayTransform.tx;\n                    helpTransform.ty = displayTransform.ty;\n                    var anchorPoint = cc.pointApplyAffineTransform(node.getAnchorPointInPoints(), helpTransform);\n                    helpTransform.tx = anchorPoint.x;\n                    helpTransform.ty = anchorPoint.y;\n                    var t = cc.affineTransformConcat(helpTransform, bone.getArmature().getNodeToParentTransform());\n                    detector.updateTransform(t);\n                }\n            }\n        }\n    },\n\n    addSpriteDisplay: function (bone, decoDisplay, displayData) {\n        var sdp = new ccs.SpriteDisplayData();\n        sdp.copy(displayData);\n        decoDisplay.setDisplayData(sdp);\n        this.createSpriteDisplay(bone, decoDisplay);\n    },\n\n    createSpriteDisplay: function (bone, decoDisplay) {\n        var skin = null;\n        var displayData = decoDisplay.getDisplayData();\n        //! remove .xxx\n        var textureName = displayData.displayName;\n        var startPos = textureName.lastIndexOf(\".\");\n        if (startPos !== -1)\n            textureName = textureName.substring(0, startPos);\n        //! create display\n        if (textureName === \"\")\n            skin = new ccs.Skin();\n        else\n            skin = new ccs.Skin(\"#\" + textureName + \".png\");\n\n        decoDisplay.setDisplay(skin);\n\n        skin.setBone(bone);\n        this.initSpriteDisplay(bone, decoDisplay, displayData.displayName, skin);\n\n        var armature = bone.getArmature();\n        if (armature) {\n            if (armature.getArmatureData().dataVersion >= ccs.CONST_VERSION_COMBINED)\n                skin.setSkinData(displayData.skinData);\n            else\n                skin.setSkinData(bone.boneData);\n        }\n    },\n\n    initSpriteDisplay: function (bone, decoDisplay, displayName, skin) {\n        //! remove .xxx\n        var textureName = displayName;\n        var startPos = textureName.lastIndexOf(\".\");\n\n        if (startPos !== -1)\n            textureName = textureName.substring(0, startPos);\n\n        var textureData = ccs.armatureDataManager.getTextureData(textureName);\n        if (textureData) {\n            //! Init display anchorPoint, every Texture have a anchor point\n            skin.setAnchorPoint(cc.p(textureData.pivotX, textureData.pivotY));\n        }\n\n        if (ccs.ENABLE_PHYSICS_CHIPMUNK_DETECT || ccs.ENABLE_PHYSICS_SAVE_CALCULATED_VERTEX) {\n            if (textureData && textureData.contourDataList.length > 0) {\n                //! create ContourSprite\n                var colliderDetector = new ccs.ColliderDetector(bone);\n                colliderDetector.addContourDataList(textureData.contourDataList);\n                decoDisplay.setColliderDetector(colliderDetector);\n            }\n        }\n    },\n\n    addArmatureDisplay: function (bone, decoDisplay, displayData) {\n        var adp = new ccs.ArmatureDisplayData();\n        adp.copy(displayData);\n        decoDisplay.setDisplayData(adp);\n\n        this.createArmatureDisplay(bone, decoDisplay);\n    },\n\n    createArmatureDisplay: function (bone, decoDisplay) {\n        var displayData = decoDisplay.getDisplayData();\n        var armature = new ccs.Armature(displayData.displayName, bone);\n        decoDisplay.setDisplay(armature);\n    },\n\n    updateArmatureDisplay: function (bone, armature, dt) {\n        if (armature) {\n            armature.sortAllChildren();\n            armature.update(dt);\n        }\n    },\n\n    addParticleDisplay: function (bone, decoDisplay, displayData) {\n        var adp = new ccs.ParticleDisplayData();\n        adp.copy(displayData);\n        decoDisplay.setDisplayData(adp);\n        this.createParticleDisplay(bone, decoDisplay);\n    },\n\n    createParticleDisplay: function (bone, decoDisplay) {\n        var displayData = decoDisplay.getDisplayData();\n        var system = new cc.ParticleSystem(displayData.displayName);\n\n        system.removeFromParent();\n        system.cleanup();\n\n        var armature = bone.getArmature();\n        if (armature)\n            system.setParent(bone.getArmature());\n\n        decoDisplay.setDisplay(system);\n    },\n\n    updateParticleDisplay: function (bone, particleSystem, dt) {\n        var node = new ccs.BaseData();\n        ccs.TransformHelp.matrixToNode(bone.nodeToArmatureTransform(), node);\n        particleSystem.setPosition(node.x, node.y);\n        particleSystem.setScaleX(node.scaleX);\n        particleSystem.setScaleY(node.scaleY);\n        particleSystem.update(dt);\n    }\n};"]}