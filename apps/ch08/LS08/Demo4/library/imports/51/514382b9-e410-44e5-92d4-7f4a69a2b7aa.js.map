{"version":3,"sources":["../../../../../../../../assets/frameworks/cocos2d-html5/extensions/cocostudio/armature/assets/frameworks/cocos2d-html5/extensions/cocostudio/armature/CCArmatureCanvasRenderCmd.js"],"names":["ccs","Armature","RenderCmd","_updateAnchorPointInPoint","node","_node","contentSize","_contentSize","anchorPoint","_anchorPoint","offsetPoint","_offsetPoint","_anchorPointInPoints","x","width","y","height","_realAnchorPointInPoints","setDirtyFlag","cc","Node","_dirtyFlags","transformDirty","getAnchorPointInPoints","p","CanvasRenderCmd","renderableObject","_rootCtor","_needDraw","Point","_canUseDirtyRegion","_startRenderCmd","CustomRenderCmd","_startCmdCallback","_RestoreRenderCmd","_RestoreCmdCallback","_transform","a","b","c","d","tx","ty","_worldTransform","proto","prototype","Object","create","inject","constructor","ctx","scaleX","scaleY","parent","_parent","transform","_renderCmd","wrapper","_renderContext","save","_switchToArmatureMode","parentCmd","recursive","originTransform","locChildren","_children","i","len","length","selBone","boneCmd","getDisplayRenderNode","boneType","getDisplayRenderNodeType","selNode","cmd","DISPLAY_TYPE_ARMATURE","DISPLAY_TYPE_SPRITE","affineTransformConcatIn","flags","locFlag","_dirtyFlag","boneFlag","colorDirty","opacityDirty","_updateDisplayColor","_displayedColor","_updateDisplayOpacity","_displayedOpacity","_updateColor","parentColor","parentOpacity","_cacheDirty","restore","initShaderCache","setShaderProgram","updateChildPosition","dis","bone","visit","rendering","alphaPremultiplied","BlendFunc","ALPHA_PREMULTIPLIED","alphaNonPremultipled","ALPHA_NON_PREMULTIPLIED","_syncStatus","_visitNormalChild","childNode","_visible","_curLevel","children","child","sortAllChildren","_localZOrder","renderer","pushRenderCommand"],"mappings":"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","file":"CCArmatureCanvasRenderCmd.js","sourceRoot":"../../../../../../../../assets/frameworks/cocos2d-html5/extensions/cocostudio/armature","sourcesContent":["/****************************************************************************\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\n(function () {\n    ccs.Armature.RenderCmd = {\n        _updateAnchorPointInPoint: function () {\n            var node = this._node;\n            var contentSize = node._contentSize, anchorPoint = node._anchorPoint, offsetPoint = node._offsetPoint;\n            this._anchorPointInPoints.x = contentSize.width * anchorPoint.x - offsetPoint.x;\n            this._anchorPointInPoints.y = contentSize.height * anchorPoint.y - offsetPoint.y;\n\n            this._realAnchorPointInPoints.x = contentSize.width * anchorPoint.x;\n            this._realAnchorPointInPoints.y = contentSize.height * anchorPoint.y;\n            this.setDirtyFlag(cc.Node._dirtyFlags.transformDirty);\n        },\n\n        getAnchorPointInPoints: function () {\n            return cc.p(this._realAnchorPointInPoints);\n        }\n    };\n})();\n\n(function () {\n    ccs.Armature.CanvasRenderCmd = function (renderableObject) {\n        this._rootCtor(renderableObject);\n        this._needDraw = true;\n\n        this._realAnchorPointInPoints = new cc.Point(0, 0);\n        this._canUseDirtyRegion = true;\n        this._startRenderCmd = new cc.CustomRenderCmd(this, this._startCmdCallback);\n        this._RestoreRenderCmd = new cc.CustomRenderCmd(this, this._RestoreCmdCallback);\n        this._startRenderCmd._canUseDirtyRegion = true;\n        this._RestoreRenderCmd._canUseDirtyRegion = true;\n\n        this._transform = {a: 1, b: 0, c: 0, d: 1, tx: 0, ty: 0};\n        this._worldTransform = {a: 1, b: 0, c: 0, d: 1, tx: 0, ty: 0};\n    };\n\n    var proto = ccs.Armature.CanvasRenderCmd.prototype = Object.create(cc.Node.CanvasRenderCmd.prototype);\n    cc.inject(ccs.Armature.RenderCmd, proto);\n    proto.constructor = ccs.Armature.CanvasRenderCmd;\n\n    proto._startCmdCallback = function (ctx, scaleX, scaleY) {\n        var node = this._node, parent = node._parent;\n        this.transform(parent ? parent._renderCmd : null);\n\n        var wrapper = ctx || cc._renderContext;\n        wrapper.save();\n        //set to armature mode\n        wrapper._switchToArmatureMode(true, this._worldTransform, scaleX, scaleY);\n    };\n\n    proto.transform = function (parentCmd, recursive) {\n        this.originTransform(parentCmd, recursive);\n\n        var locChildren = this._node._children;\n        for (var i = 0, len = locChildren.length; i < len; i++) {\n            var selBone = locChildren[i];\n            var boneCmd = selBone._renderCmd;\n            if (selBone && selBone.getDisplayRenderNode) {\n                var boneType = selBone.getDisplayRenderNodeType();\n                var selNode = selBone.getDisplayRenderNode();\n                if (selNode && selNode._renderCmd) {\n                    var cmd = selNode._renderCmd;\n                    cmd.transform(null);   //must be null, use transform in armature mode\n                    if (boneType !== ccs.DISPLAY_TYPE_ARMATURE && boneType !== ccs.DISPLAY_TYPE_SPRITE) {\n                        cc.affineTransformConcatIn(cmd._worldTransform, selBone._worldTransform);\n                    }\n\n                    //update displayNode's color and opacity, because skin didn't call visit()\n                    var flags = cc.Node._dirtyFlags, locFlag = cmd._dirtyFlag, boneFlag = boneCmd._dirtyFlag;\n                    var colorDirty = boneFlag & flags.colorDirty,\n                        opacityDirty = boneFlag & flags.opacityDirty;\n                    if (colorDirty)\n                        boneCmd._updateDisplayColor(this._displayedColor);\n                    if (opacityDirty)\n                        boneCmd._updateDisplayOpacity(this._displayedOpacity);\n                    if (colorDirty || opacityDirty)\n                        boneCmd._updateColor();\n\n                    var parentColor = selBone._renderCmd._displayedColor, parentOpacity = selBone._renderCmd._displayedOpacity;\n                    colorDirty = locFlag & flags.colorDirty;\n                    opacityDirty = locFlag & flags.opacityDirty;\n                    if (colorDirty)\n                        cmd._updateDisplayColor(parentColor);\n                    if (opacityDirty)\n                        cmd._updateDisplayOpacity(parentOpacity);\n                    if (colorDirty || opacityDirty) {\n                        cmd._updateColor();\n                    }\n                }\n            }\n        }\n    };\n\n    proto._RestoreCmdCallback = function (wrapper) {\n        this._cacheDirty = false;\n        wrapper._switchToArmatureMode(false);\n        wrapper.restore();\n    };\n\n    proto.initShaderCache = function () {\n    };\n    proto.setShaderProgram = function () {\n    };\n    proto.updateChildPosition = function (dis, bone) {\n        dis.visit();\n        // cc.renderer.pushRenderCommand(dis._renderCmd);\n    };\n\n    proto.rendering = function (ctx, scaleX, scaleY) {\n        var node = this._node;\n        var locChildren = node._children;\n        var alphaPremultiplied = cc.BlendFunc.ALPHA_PREMULTIPLIED, alphaNonPremultipled = cc.BlendFunc.ALPHA_NON_PREMULTIPLIED;\n        for (var i = 0, len = locChildren.length; i < len; i++) {\n            var selBone = locChildren[i];\n            if (selBone && selBone.getDisplayRenderNode) {\n                var selNode = selBone.getDisplayRenderNode();\n                if (null === selNode)\n                    continue;\n\n                selBone._renderCmd._syncStatus(this);\n                switch (selBone.getDisplayRenderNodeType()) {\n                    case ccs.DISPLAY_TYPE_SPRITE:\n                        selNode.visit(selBone);\n                        break;\n                    case ccs.DISPLAY_TYPE_ARMATURE:\n                        selNode._renderCmd.rendering(ctx, scaleX, scaleY);\n                        break;\n                    default:\n                        selNode.visit(selBone);\n                        break;\n                }\n            } else if (selBone instanceof cc.Node) {\n                this._visitNormalChild(selBone);\n                // selBone.visit(this);\n            }\n        }\n    };\n\n    proto._visitNormalChild = function (childNode) {\n        if (!childNode)\n            return;\n\n        var cmd = childNode._renderCmd;\n        // quick return if not visible\n        if (!childNode._visible)\n            return;\n        cmd._curLevel = this._curLevel + 1;\n\n        //visit for canvas\n        var i, children = childNode._children, child;\n        cmd._syncStatus(this);\n        //because armature use transform, not setTransform\n        cmd.transform(null);\n\n        var len = children.length;\n        if (len > 0) {\n            childNode.sortAllChildren();\n            // draw children zOrder < 0\n            for (i = 0; i < len; i++) {\n                child = children[i];\n                if (child._localZOrder < 0)\n                    child.visit(childNode);\n                else\n                    break;\n            }\n            cc.renderer.pushRenderCommand(cmd);\n            for (; i < len; i++)\n                children[i].visit(childNode);\n        } else {\n            cc.renderer.pushRenderCommand(cmd);\n        }\n        this._dirtyFlag = 0;\n    };\n\n    proto.visit = function (parentCmd) {\n        var node = this._node;\n        // quick return if not visible. children won't be drawn.\n        if (!node._visible)\n            return;\n\n        this._syncStatus(parentCmd);\n        node.sortAllChildren();\n\n        cc.renderer.pushRenderCommand(this._startRenderCmd);\n        this.rendering();\n        cc.renderer.pushRenderCommand(this._RestoreRenderCmd);\n\n        this._cacheDirty = false;\n    };\n})();\n"]}