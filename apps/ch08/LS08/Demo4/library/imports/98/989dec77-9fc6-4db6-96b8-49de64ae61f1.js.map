{"version":3,"sources":["../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/particle/assets/frameworks/cocos2d-html5/cocos2d/particle/CCParticleSystemWebGLRenderCmd.js"],"names":["cc","ParticleSystem","WebGLRenderCmd","renderable","_rootCtor","_needDraw","_matrix","_buffersVBO","_quads","_indices","_quadsArrayBuffer","proto","prototype","Object","create","Node","constructor","getDrawMode","setDrawMode","drawMode","getShapeType","setShapeType","shapeType","setBatchNode","batchNode","node","_node","_batchNode","oldBatch","locParticles","_particles","i","_totalParticles","atlasIndex","_allocMemory","initIndices","setTexture","getTexture","_setupVBO","textureAtlas","_copyQuadsToTextureAtlas","_renderContext","deleteBuffer","totalParticles","locIndices","len","i6","i4","isDifferentTexture","texture1","texture2","updateParticlePosition","particle","position","updateQuadWithParticle","newPosition","quad","batchQuads","quads","dirty","_particleIdx","r","g","b","a","_opacityModifyRGB","color","blColors","bl","colors","brColors","br","tlColors","tl","trColors","tr","size_2","size","rotation","x1","y1","x2","y2","x","y","rad","degreesToRadians","cr","Math","cos","sr","sin","ax","ay","bx","by","cx","cy","dx","dy","vertices","rendering","ctx","_texture","gl","math","Matrix4","identity","wt","_worldTransform","mat","c","tx","d","ty","_glProgramState","apply","glBindTexture2D","glBlendFuncForParticle","_blendFunc","src","dst","enableVertexAttribArray","VERTEX_ATTRIB_POSITION","VERTEX_ATTRIB_COLOR","VERTEX_ATTRIB_TEX_COORDS","bindBuffer","ARRAY_BUFFER","vertexAttribPointer","FLOAT","UNSIGNED_BYTE","ELEMENT_ARRAY_BUFFER","drawElements","TRIANGLES","UNSIGNED_SHORT","initTexCoordsWithRect","pointRect","texture","scaleFactor","contentScaleFactor","rect","width","height","wide","high","pixelsWidth","pixelsHeight","left","bottom","right","top","FIX_ARTIFACTS_BY_STRECHING_TEXEL","temp","start","end","V3F_C4B_T2F_QuadZero","selQuad","texCoords","u","v","setTotalParticles","tp","_allocatedParticles","quadSize","V3F_C4B_T2F_Quad","BYTES_PER_ELEMENT","Uint16Array","locQuadsArrayBuffer","ArrayBuffer","length","locQuads","j","Particle","resetSystem","addParticle","particles","particleCount","createBuffer","bufferData","DYNAMIC_DRAW","STATIC_DRAW","log","postStep","bufferSubData","_setBlendAdditive","locBlendFunc","hasPremultipliedAlpha","SRC_ALPHA","ONE_MINUS_SRC_ALPHA","BLEND_SRC","BLEND_DST","_initWithTotalParticles","_shaderProgram","shaderCache","programForKey","SHADER_POSITION_TEXTURECOLOR","_updateDeltaColor","selParticle","dt","deltaColor","isChangeColor"],"mappings":"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","file":"CCParticleSystemWebGLRenderCmd.js","sourceRoot":"../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/particle","sourcesContent":["/****************************************************************************\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\n(function () {\n    /**\n     * ParticleSystem's WebGL render command\n     */\n    cc.ParticleSystem.WebGLRenderCmd = function (renderable) {\n        this._rootCtor(renderable);\n        this._needDraw = true;\n\n        this._matrix = null;\n\n        this._buffersVBO = [0, 0];\n        this._quads = [];\n        this._indices = [];\n        this._quadsArrayBuffer = null;\n    };\n    var proto = cc.ParticleSystem.WebGLRenderCmd.prototype = Object.create(cc.Node.WebGLRenderCmd.prototype);\n    proto.constructor = cc.ParticleSystem.WebGLRenderCmd;\n\n    proto.getDrawMode = function () {\n    };\n    proto.setDrawMode = function (drawMode) {\n    };\n    proto.getShapeType = function () {\n    };\n    proto.setShapeType = function (shapeType) {\n    };\n\n    proto.setBatchNode = function (batchNode) {\n        var node = this._node;\n        if (node._batchNode !== batchNode) {\n            var oldBatch = node._batchNode;\n            node._batchNode = batchNode; //weak reference\n\n            if (batchNode) {\n                var locParticles = node._particles;\n                for (var i = 0; i < node._totalParticles; i++)\n                    locParticles[i].atlasIndex = i;\n            }\n\n            // NEW: is self render ?\n            if (!batchNode) {\n                this._allocMemory();\n                this.initIndices(node._totalParticles);\n                node.setTexture(oldBatch.getTexture());\n                this._setupVBO();\n\n            } else if (!oldBatch) {\n                // OLD: was it self render cleanup  ?\n                // copy current state to batch\n                node._batchNode.textureAtlas._copyQuadsToTextureAtlas(this._quads, node.atlasIndex);\n\n                //delete buffer\n                cc._renderContext.deleteBuffer(this._buffersVBO[1]);     //where is re-bindBuffer code?\n            }\n        }\n    };\n\n    proto.initIndices = function (totalParticles) {\n        var locIndices = this._indices;\n        for (var i = 0, len = totalParticles; i < len; ++i) {\n            var i6 = i * 6;\n            var i4 = i * 4;\n            locIndices[i6 + 0] = i4 + 0;\n            locIndices[i6 + 1] = i4 + 1;\n            locIndices[i6 + 2] = i4 + 2;\n\n            locIndices[i6 + 5] = i4 + 1;\n            locIndices[i6 + 4] = i4 + 2;\n            locIndices[i6 + 3] = i4 + 3;\n        }\n    };\n\n    proto.isDifferentTexture = function (texture1, texture2) {\n        return (texture1 === texture2);\n    };\n\n    proto.updateParticlePosition = function (particle, position) {\n        // IMPORTANT: newPos may not be used as a reference here! (as it is just the temporary tpa point)\n        // the implementation of updateQuadWithParticle must use\n        // the x and y values directly\n        this.updateQuadWithParticle(particle, position);\n    };\n\n    proto.updateQuadWithParticle = function (particle, newPosition) {\n        var quad = null, node = this._node;\n        if (node._batchNode) {\n            var batchQuads = node._batchNode.textureAtlas.quads;\n            quad = batchQuads[node.atlasIndex + particle.atlasIndex];\n            node._batchNode.textureAtlas.dirty = true;\n        } else\n            quad = this._quads[node._particleIdx];\n\n        var r, g, b, a;\n        if (node._opacityModifyRGB) {\n            r = 0 | (particle.color.r * particle.color.a / 255);\n            g = 0 | (particle.color.g * particle.color.a / 255);\n            b = 0 | (particle.color.b * particle.color.a / 255);\n        } else {\n            r = 0 | (particle.color.r );\n            g = 0 | (particle.color.g );\n            b = 0 | (particle.color.b );\n        }\n        a = 0 | (particle.color.a );\n\n        var blColors = quad.bl.colors, brColors = quad.br.colors, tlColors = quad.tl.colors, trColors = quad.tr.colors;\n        blColors.r = brColors.r = tlColors.r = trColors.r = r;\n        blColors.g = brColors.g = tlColors.g = trColors.g = g;\n        blColors.b = brColors.b = tlColors.b = trColors.b = b;\n        blColors.a = brColors.a = tlColors.a = trColors.a = a;\n\n        // vertices\n        var size_2 = particle.size / 2;\n        if (particle.rotation) {\n            var x1 = -size_2, y1 = -size_2;\n\n            var x2 = size_2, y2 = size_2;\n            var x = newPosition.x, y = newPosition.y;\n\n            var rad = -cc.degreesToRadians(particle.rotation);\n            var cr = Math.cos(rad), sr = Math.sin(rad);\n            var ax = x1 * cr - y1 * sr + x;\n            var ay = x1 * sr + y1 * cr + y;\n            var bx = x2 * cr - y1 * sr + x;\n            var by = x2 * sr + y1 * cr + y;\n            var cx = x2 * cr - y2 * sr + x;\n            var cy = x2 * sr + y2 * cr + y;\n            var dx = x1 * cr - y2 * sr + x;\n            var dy = x1 * sr + y2 * cr + y;\n\n            // bottom-left\n            quad.bl.vertices.x = ax;\n            quad.bl.vertices.y = ay;\n\n            // bottom-right vertex:\n            quad.br.vertices.x = bx;\n            quad.br.vertices.y = by;\n\n            // top-left vertex:\n            quad.tl.vertices.x = dx;\n            quad.tl.vertices.y = dy;\n\n            // top-right vertex:\n            quad.tr.vertices.x = cx;\n            quad.tr.vertices.y = cy;\n        } else {\n            // bottom-left vertex:\n            quad.bl.vertices.x = newPosition.x - size_2;\n            quad.bl.vertices.y = newPosition.y - size_2;\n\n            // bottom-right vertex:\n            quad.br.vertices.x = newPosition.x + size_2;\n            quad.br.vertices.y = newPosition.y - size_2;\n\n            // top-left vertex:\n            quad.tl.vertices.x = newPosition.x - size_2;\n            quad.tl.vertices.y = newPosition.y + size_2;\n\n            // top-right vertex:\n            quad.tr.vertices.x = newPosition.x + size_2;\n            quad.tr.vertices.y = newPosition.y + size_2;\n        }\n    };\n\n    proto.rendering = function (ctx) {\n        var node = this._node;\n        if (!node._texture)\n            return;\n\n        var gl = ctx || cc._renderContext;\n\n        if (!this._matrix) {\n            this._matrix = new cc.math.Matrix4();\n            this._matrix.identity();\n        }\n        var wt = this._worldTransform;\n        this._matrix.mat[0] = wt.a;\n        this._matrix.mat[4] = wt.c;\n        this._matrix.mat[12] = wt.tx;\n        this._matrix.mat[1] = wt.b;\n        this._matrix.mat[5] = wt.d;\n        this._matrix.mat[13] = wt.ty;\n\n        this._glProgramState.apply(this._matrix);\n\n        cc.glBindTexture2D(node._texture);\n        cc.glBlendFuncForParticle(node._blendFunc.src, node._blendFunc.dst);\n\n        //\n        // Using VBO without VAO\n        //\n        gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_POSITION);\n        gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_COLOR);\n        gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_TEX_COORDS);\n\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._buffersVBO[0]);\n        gl.vertexAttribPointer(cc.VERTEX_ATTRIB_POSITION, 3, gl.FLOAT, false, 24, 0);               // vertices\n        gl.vertexAttribPointer(cc.VERTEX_ATTRIB_COLOR, 4, gl.UNSIGNED_BYTE, true, 24, 12);          // colors\n        gl.vertexAttribPointer(cc.VERTEX_ATTRIB_TEX_COORDS, 2, gl.FLOAT, false, 24, 16);            // tex coords\n\n        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this._buffersVBO[1]);\n        gl.drawElements(gl.TRIANGLES, node._particleIdx * 6, gl.UNSIGNED_SHORT, 0);\n    };\n\n    proto.initTexCoordsWithRect = function (pointRect) {\n        var node = this._node;\n        var texture = node.texture;\n        var scaleFactor = cc.contentScaleFactor();\n        // convert to pixels coords\n        var rect = cc.rect(\n            pointRect.x * scaleFactor,\n            pointRect.y * scaleFactor,\n            pointRect.width * scaleFactor,\n            pointRect.height * scaleFactor);\n\n        var wide = pointRect.width;\n        var high = pointRect.height;\n\n        if (texture) {\n            wide = texture.pixelsWidth;\n            high = texture.pixelsHeight;\n        }\n\n        var left, bottom, right, top;\n        if (cc.FIX_ARTIFACTS_BY_STRECHING_TEXEL) {\n            left = (rect.x * 2 + 1) / (wide * 2);\n            bottom = (rect.y * 2 + 1) / (high * 2);\n            right = left + (rect.width * 2 - 2) / (wide * 2);\n            top = bottom + (rect.height * 2 - 2) / (high * 2);\n        } else {\n            left = rect.x / wide;\n            bottom = rect.y / high;\n            right = left + rect.width / wide;\n            top = bottom + rect.height / high;\n        }\n\n        // Important. Texture in cocos2d are inverted, so the Y component should be inverted\n        var temp = top;\n        top = bottom;\n        bottom = temp;\n\n        var quads;\n        var start = 0, end = 0;\n        if (node._batchNode) {\n            quads = node._batchNode.textureAtlas.quads;\n            start = node.atlasIndex;\n            end = node.atlasIndex + node._totalParticles;\n        } else {\n            quads = this._quads;\n            start = 0;\n            end = node._totalParticles;\n        }\n\n        for (var i = start; i < end; i++) {\n            if (!quads[i])\n                quads[i] = cc.V3F_C4B_T2F_QuadZero();\n\n            // bottom-left vertex:\n            var selQuad = quads[i];\n            selQuad.bl.texCoords.u = left;\n            selQuad.bl.texCoords.v = bottom;\n            // bottom-right vertex:\n            selQuad.br.texCoords.u = right;\n            selQuad.br.texCoords.v = bottom;\n            // top-left vertex:\n            selQuad.tl.texCoords.u = left;\n            selQuad.tl.texCoords.v = top;\n            // top-right vertex:\n            selQuad.tr.texCoords.u = right;\n            selQuad.tr.texCoords.v = top;\n        }\n    };\n\n    proto.setTotalParticles = function (tp) {\n        var node = this._node;\n        // If we are setting the total numer of particles to a number higher\n        // than what is allocated, we need to allocate new arrays\n        if (tp > node._allocatedParticles) {\n            var quadSize = cc.V3F_C4B_T2F_Quad.BYTES_PER_ELEMENT;\n            // Allocate new memory\n            this._indices = new Uint16Array(tp * 6);\n            var locQuadsArrayBuffer = new ArrayBuffer(tp * quadSize);\n            //TODO need fix\n            // Assign pointers\n            var locParticles = node._particles;\n            locParticles.length = 0;\n            var locQuads = this._quads;\n            locQuads.length = 0;\n            for (var j = 0; j < tp; j++) {\n                locParticles[j] = new cc.Particle();\n                locQuads[j] = new cc.V3F_C4B_T2F_Quad(null, null, null, null, locQuadsArrayBuffer, j * quadSize);\n            }\n            node._allocatedParticles = tp;\n            node._totalParticles = tp;\n\n            // Init particles\n            if (node._batchNode) {\n                for (var i = 0; i < tp; i++)\n                    locParticles[i].atlasIndex = i;\n            }\n\n            this._quadsArrayBuffer = locQuadsArrayBuffer;\n            this.initIndices(tp);\n            this._setupVBO();\n\n            //set the texture coord\n            if (node._texture) {\n                this.initTexCoordsWithRect(cc.rect(0, 0, node._texture.width, node._texture.height));\n            }\n        } else\n            node._totalParticles = tp;\n        node.resetSystem();\n    };\n\n    proto.addParticle = function () {\n        var node = this._node,\n            particles = node._particles;\n        return particles[node.particleCount];\n    };\n\n    proto._setupVBO = function () {\n        var node = this;\n        var gl = cc._renderContext;\n\n        //gl.deleteBuffer(this._buffersVBO[0]);\n        this._buffersVBO[0] = gl.createBuffer();\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._buffersVBO[0]);\n        gl.bufferData(gl.ARRAY_BUFFER, this._quadsArrayBuffer, gl.DYNAMIC_DRAW);\n\n        this._buffersVBO[1] = gl.createBuffer();\n        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this._buffersVBO[1]);\n        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this._indices, gl.STATIC_DRAW);\n\n        //cc.checkGLErrorDebug();\n    };\n\n    proto._allocMemory = function () {\n        var node = this._node;\n        //cc.assert((!this._quads && !this._indices), \"Memory already allocated\");\n        if (node._batchNode) {\n            cc.log(\"cc.ParticleSystem._allocMemory(): Memory should not be allocated when not using batchNode\");\n            return false;\n        }\n\n        var quadSize = cc.V3F_C4B_T2F_Quad.BYTES_PER_ELEMENT;\n        var totalParticles = node._totalParticles;\n        var locQuads = this._quads;\n        locQuads.length = 0;\n        this._indices = new Uint16Array(totalParticles * 6);\n        var locQuadsArrayBuffer = new ArrayBuffer(quadSize * totalParticles);\n\n        for (var i = 0; i < totalParticles; i++)\n            locQuads[i] = new cc.V3F_C4B_T2F_Quad(null, null, null, null, locQuadsArrayBuffer, i * quadSize);\n        if (!locQuads || !this._indices) {\n            cc.log(\"cocos2d: Particle system: not enough memory\");\n            return false;\n        }\n        this._quadsArrayBuffer = locQuadsArrayBuffer;\n        return true;\n    };\n\n    proto.postStep = function () {\n        var gl = cc._renderContext;\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._buffersVBO[0]);\n        gl.bufferSubData(gl.ARRAY_BUFFER, 0, this._quadsArrayBuffer);\n    };\n\n    proto._setBlendAdditive = function () {\n        var locBlendFunc = this._node._blendFunc;\n        if (this._texture && !this._texture.hasPremultipliedAlpha()) {\n            locBlendFunc.src = cc.SRC_ALPHA;\n            locBlendFunc.dst = cc.ONE_MINUS_SRC_ALPHA;\n        } else {\n            locBlendFunc.src = cc.BLEND_SRC;\n            locBlendFunc.dst = cc.BLEND_DST;\n        }\n    };\n\n    proto._initWithTotalParticles = function (totalParticles) {\n        // allocating data space\n        if (!this._allocMemory())\n            return false;\n\n        this.initIndices(totalParticles);\n        this._setupVBO();\n\n        this._shaderProgram = cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURECOLOR);\n    };\n\n    proto._updateDeltaColor = function (selParticle, dt) {\n        selParticle.color.r += selParticle.deltaColor.r * dt;\n        selParticle.color.g += selParticle.deltaColor.g * dt;\n        selParticle.color.b += selParticle.deltaColor.b * dt;\n        selParticle.color.a += selParticle.deltaColor.a * dt;\n        selParticle.isChangeColor = true;\n    };\n})();\n"]}