{"version":3,"sources":["../../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/core/renderer/assets/frameworks/cocos2d-html5/cocos2d/core/renderer/RendererCanvas.js"],"names":["cc","rendererCanvas","childrenOrderDirty","assignedZ","assignedZStep","_transformNodePool","_renderCmds","_isCacheToCanvasOn","_cacheToCanvasCmds","_cacheInstanceIds","_currentID","_clearColor","color","_clearFillStyle","_dirtyRegion","_allNeedDraw","_enableDirtyRegion","_debugDirtyRegion","_canUseDirtyRegion","_dirtyRegionCountThreshold","getRenderCmd","renderableObject","_createRenderCmd","enableDirtyRegion","enabled","isDirtyRegionEnabled","setDirtyRegionCountThreshold","threshold","_collectDirtyRegion","locCmds","i","len","dirtyRegion","dirtryRegionCount","result","localStatus","Node","CanvasRenderCmd","RegionStatus","length","cmd","regionFlag","_regionFlag","oldRegion","_oldRegion","currentRegion","_currentRegion","NotDirty","isEmpty","addRegion","Dirty","_beginDrawDirtyRegion","ctxWrapper","ctx","getContext","dirtyList","getDirtyRegions","save","scaleX","_scaleX","scaleY","_scaleY","setTransform","a","b","c","d","tx","ty","beginPath","index","count","region","rect","_minX","_maxY","_width","_height","clip","_endDrawDirtyRegion","restore","_debugDrawDirtyRegion","oldstyle","fillStyle","fill","rendering","DirtyRegion","viewport","_canvas","wrapper","_renderContext","view","getScaleX","getScaleY","setViewScale","computeRealOffsetY","allNeedDraw","collectResult","clearRect","width","height","r","g","setFillStyle","setGlobalAlpha","fillRect","needRendering","cmdRegion","intersects","clear","_renderingToCacheCanvas","instanceID","log","isUndefined","_removeCache","locIDs","_turnToCacheMode","renderTextureID","indexOf","push","_turnToNormalMode","cmds","arrayRemoveObject","resetFlag","transform","locPool","sort","_sortNodeByLevelAsc","_dirtyFlag","updateStatus","transformDirty","n1","n2","_curLevel","pushDirtyNode","node","clearRenderCommands","pushRenderCommand","needDraw","currentId","locCmdBuffer","cmdList","CanvasContextWrapper","context","_context","_saveCount","_currentAlpha","globalAlpha","_currentCompositeOperation","globalCompositeOperation","_currentFillStyle","_currentStrokeStyle","strokeStyle","_offsetX","_offsetY","_realOffsetY","_armatureMode","proto","prototype","resetCache","canvas","setOffset","x","y","alpha","setCompositeOperation","compositionOperation","setStrokeStyle","t","_switchToArmatureMode","enable"],"mappings":"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","file":"RendererCanvas.js","sourceRoot":"../../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/core/renderer","sourcesContent":["/****************************************************************************\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\ncc.rendererCanvas = {\n    childrenOrderDirty: true,\n    assignedZ: 0,\n    assignedZStep: 1 / 10000,\n\n    _transformNodePool: [],                              //save nodes transform dirty\n    _renderCmds: [],                                     //save renderer commands\n\n    _isCacheToCanvasOn: false,                          //a switch that whether cache the rendererCmd to cacheToCanvasCmds\n    _cacheToCanvasCmds: {},                              // an array saves the renderer commands need for cache to other canvas\n    _cacheInstanceIds: [],\n    _currentID: 0,\n    _clearColor: cc.color(),                                  //background color,default BLACK\n    _clearFillStyle: \"rgb(0, 0, 0)\",\n\n    _dirtyRegion: null,\n    _allNeedDraw: true,\n    _enableDirtyRegion: false,\n    _debugDirtyRegion: false,\n    _canUseDirtyRegion: false,\n    //max dirty Region count, default is 10\n    _dirtyRegionCountThreshold: 10,\n\n    getRenderCmd: function (renderableObject) {\n        //TODO Add renderCmd pool here\n        return renderableObject._createRenderCmd();\n    },\n\n    enableDirtyRegion: function (enabled) {\n        this._enableDirtyRegion = enabled;\n    },\n\n    isDirtyRegionEnabled: function () {\n        return this._enableDirtyRegion;\n    },\n\n    setDirtyRegionCountThreshold: function(threshold) {\n        this._dirtyRegionCountThreshold = threshold;\n    },\n\n    _collectDirtyRegion: function () {\n        //collect dirtyList\n        var locCmds = this._renderCmds, i, len;\n        var dirtyRegion = this._dirtyRegion;\n        var dirtryRegionCount = 0;\n        var result = true;\n        var localStatus = cc.Node.CanvasRenderCmd.RegionStatus;\n        for (i = 0, len = locCmds.length; i < len; i++) {\n            var cmd = locCmds[i];\n            var regionFlag = cmd._regionFlag;\n            var oldRegion = cmd._oldRegion;\n            var currentRegion = cmd._currentRegion;\n            if (regionFlag > localStatus.NotDirty) {\n                ++dirtryRegionCount;\n                if(dirtryRegionCount > this._dirtyRegionCountThreshold)\n                    result = false;\n                //add\n                if(result) {\n                    (!currentRegion.isEmpty()) && dirtyRegion.addRegion(currentRegion);\n                    if (cmd._regionFlag > localStatus.Dirty) {\n                        (!oldRegion.isEmpty()) && dirtyRegion.addRegion(oldRegion);\n                    }\n                }\n                cmd._regionFlag = localStatus.NotDirty;\n            }\n\n        }\n\n        return result;\n    },\n\n    _beginDrawDirtyRegion: function (ctxWrapper) {\n        var ctx = ctxWrapper.getContext();\n        var dirtyList = this._dirtyRegion.getDirtyRegions();\n        ctx.save();\n        //add clip\n        var scaleX = ctxWrapper._scaleX;\n        var scaleY = ctxWrapper._scaleY;\n        ctxWrapper.setTransform({a: 1, b: 0, c: 0, d: 1, tx: 0, ty: 0}, scaleX, scaleY);\n        ctx.beginPath();\n        for (var index = 0, count = dirtyList.length; index < count; ++index) {\n            var region = dirtyList[index];\n            ctx.rect(region._minX , -region._maxY , region._width , region._height );\n        }\n        ctx.clip();\n        //end add clip\n    },\n\n    _endDrawDirtyRegion: function (ctx) {\n        ctx.restore();\n    },\n\n    _debugDrawDirtyRegion: function (ctxWrapper) {\n        if (!this._debugDirtyRegion) return;\n        var ctx = ctxWrapper.getContext();\n        var dirtyList = this._dirtyRegion.getDirtyRegions();\n        //add clip\n        var scaleX = ctxWrapper._scaleX;\n        var scaleY = ctxWrapper._scaleY;\n        ctxWrapper.setTransform({a: 1, b: 0, c: 0, d: 1, tx: 0, ty: 0}, scaleX, scaleY);\n        ctx.beginPath();\n        for (var index = 0, count = dirtyList.length; index < count; ++index) {\n            var region = dirtyList[index];\n            ctx.rect(region._minX, -region._maxY , region._width , region._height );\n        }\n        var oldstyle = ctx.fillStyle;\n        ctx.fillStyle = 'green';\n        ctx.fill();\n        ctx.fillStyle = oldstyle;\n        //end add clip\n    },\n    /**\n     * drawing all renderer command to context (default is cc._renderContext)\n     * @param {cc.CanvasContextWrapper} [ctx=cc._renderContext]\n     */\n    rendering: function (ctxWrapper) {\n        var dirtyRegion = this._dirtyRegion = this._dirtyRegion || new cc.DirtyRegion();\n        var viewport = cc._canvas;\n        var wrapper = ctxWrapper || cc._renderContext;\n        var ctx = wrapper.getContext();\n\n        var scaleX = cc.view.getScaleX(),\n            scaleY = cc.view.getScaleY();\n        wrapper.setViewScale(scaleX, scaleY);\n        wrapper.computeRealOffsetY();\n        var dirtyList = this._dirtyRegion.getDirtyRegions();\n        var locCmds = this._renderCmds, i, len;\n        var allNeedDraw = this._allNeedDraw || !this._enableDirtyRegion || !this._canUseDirtyRegion;\n        var collectResult = true;\n        if (!allNeedDraw) {\n            collectResult = this._collectDirtyRegion();\n        }\n\n        allNeedDraw = allNeedDraw || (!collectResult);\n\n        if(!allNeedDraw) {\n            this._beginDrawDirtyRegion(wrapper);\n        }\n\n        ctx.setTransform(1, 0, 0, 1, 0, 0);\n        ctx.clearRect(0, 0, viewport.width, viewport.height);\n        if (this._clearColor.r !== 255 ||\n            this._clearColor.g !== 255 ||\n            this._clearColor.b !== 255) {\n            wrapper.setFillStyle(this._clearFillStyle);\n            wrapper.setGlobalAlpha(this._clearColor.a);\n            ctx.fillRect(0, 0, viewport.width, viewport.height);\n        }\n\n        for (i = 0, len = locCmds.length; i < len; i++) {\n            var cmd = locCmds[i];\n            var needRendering = false;\n            var cmdRegion = cmd._currentRegion;\n            if (!cmdRegion || allNeedDraw) {\n                needRendering = true;\n            } else {\n                for (var index = 0, count = dirtyList.length; index < count; ++index) {\n                    if (dirtyList[index].intersects(cmdRegion)) {\n                        needRendering = true;\n                        break;\n                    }\n                }\n            }\n            if (needRendering) {\n                cmd.rendering(wrapper, scaleX, scaleY);\n            }\n        }\n\n        if (!allNeedDraw) {\n            //draw debug info for dirty region if it is needed\n            this._debugDrawDirtyRegion(wrapper);\n            this._endDrawDirtyRegion(ctx);\n        }\n\n        dirtyRegion.clear();\n        this._allNeedDraw = false;\n    },\n\n    /**\n     * drawing all renderer command to cache canvas' context\n     * @param {cc.CanvasContextWrapper} ctx\n     * @param {Number} [instanceID]\n     * @param {Number} [scaleX]\n     * @param {Number} [scaleY]\n     */\n    _renderingToCacheCanvas: function (ctx, instanceID, scaleX, scaleY) {\n        if (!ctx)\n            cc.log(\"The context of RenderTexture is invalid.\");\n        scaleX = cc.isUndefined(scaleX) ? 1 : scaleX;\n        scaleY = cc.isUndefined(scaleY) ? 1 : scaleY;\n        instanceID = instanceID || this._currentID;\n        var i, locCmds = this._cacheToCanvasCmds[instanceID], len;\n        ctx.computeRealOffsetY();\n        for (i = 0, len = locCmds.length; i < len; i++) {\n            locCmds[i].rendering(ctx, scaleX, scaleY);\n        }\n        this._removeCache(instanceID);\n\n        var locIDs = this._cacheInstanceIds;\n        if (locIDs.length === 0)\n            this._isCacheToCanvasOn = false;\n        else\n            this._currentID = locIDs[locIDs.length - 1];\n    },\n\n    _turnToCacheMode: function (renderTextureID) {\n        this._isCacheToCanvasOn = true;\n        renderTextureID = renderTextureID || 0;\n        this._cacheToCanvasCmds[renderTextureID] = [];\n        if (this._cacheInstanceIds.indexOf(renderTextureID) === -1)\n            this._cacheInstanceIds.push(renderTextureID);\n        this._currentID = renderTextureID;\n    },\n\n    _turnToNormalMode: function () {\n        this._isCacheToCanvasOn = false;\n    },\n\n    _removeCache: function (instanceID) {\n        instanceID = instanceID || this._currentID;\n        var cmds = this._cacheToCanvasCmds[instanceID];\n        if (cmds) {\n            cmds.length = 0;\n            delete this._cacheToCanvasCmds[instanceID];\n        }\n\n        var locIDs = this._cacheInstanceIds;\n        cc.arrayRemoveObject(locIDs, instanceID);\n    },\n\n    resetFlag: function () {\n        this.childrenOrderDirty = false;\n        this._transformNodePool.length = 0;\n    },\n\n    transform: function () {\n        var locPool = this._transformNodePool;\n        //sort the pool\n        locPool.sort(this._sortNodeByLevelAsc);\n\n        //transform node\n        for (var i = 0, len = locPool.length; i < len; i++) {\n            if (locPool[i]._dirtyFlag !== 0)\n                locPool[i].updateStatus();\n        }\n        locPool.length = 0;\n    },\n\n    transformDirty: function () {\n        return this._transformNodePool.length > 0;\n    },\n\n    _sortNodeByLevelAsc: function (n1, n2) {\n        return n1._curLevel - n2._curLevel;\n    },\n\n    pushDirtyNode: function (node) {\n        this._transformNodePool.push(node);\n    },\n\n    clear: function () {\n    },\n\n    clearRenderCommands: function () {\n        this._renderCmds.length = 0;\n        this._cacheInstanceIds.length = 0;\n        this._isCacheToCanvasOn = false;\n        this._allNeedDraw = true;\n        this._canUseDirtyRegion = true;\n    },\n\n    pushRenderCommand: function (cmd) {\n        if (!cmd.needDraw())\n            return;\n        if (!cmd._canUseDirtyRegion) {\n            this._canUseDirtyRegion = false;\n        }\n        if (this._isCacheToCanvasOn) {\n            var currentId = this._currentID, locCmdBuffer = this._cacheToCanvasCmds;\n            var cmdList = locCmdBuffer[currentId];\n            if (cmdList.indexOf(cmd) === -1)\n                cmdList.push(cmd);\n        } else {\n            if (this._renderCmds.indexOf(cmd) === -1)\n                this._renderCmds.push(cmd);\n        }\n    }\n};\n\n(function () {\n    cc.CanvasContextWrapper = function (context) {\n        this._context = context;\n\n        this._saveCount = 0;\n        this._currentAlpha = context.globalAlpha;\n        this._currentCompositeOperation = context.globalCompositeOperation;\n        this._currentFillStyle = context.fillStyle;\n        this._currentStrokeStyle = context.strokeStyle;\n\n        this._offsetX = 0;\n        this._offsetY = 0;\n        this._realOffsetY = this.height;\n        this._armatureMode = 0;\n    };\n\n    var proto = cc.CanvasContextWrapper.prototype;\n\n    proto.resetCache = function () {\n        var context = this._context;\n        //call it after resize cc._canvas, because context will reset.\n        this._currentAlpha = context.globalAlpha;\n        this._currentCompositeOperation = context.globalCompositeOperation;\n        this._currentFillStyle = context.fillStyle;\n        this._currentStrokeStyle = context.strokeStyle;\n        this._realOffsetY = this._context.canvas.height + this._offsetY;\n    };\n\n    proto.setOffset = function (x, y) {\n        this._offsetX = x;\n        this._offsetY = y;\n        this._realOffsetY = this._context.canvas.height + this._offsetY;\n    };\n\n    proto.computeRealOffsetY = function () {\n        this._realOffsetY = this._context.canvas.height + this._offsetY;\n    };\n\n    proto.setViewScale = function (scaleX, scaleY) {\n        //call it at cc.renderCanvas.rendering\n        this._scaleX = scaleX;\n        this._scaleY = scaleY;\n    };\n\n    proto.getContext = function () {\n        return this._context;\n    };\n\n    proto.save = function () {\n        this._context.save();\n        this._saveCount++;\n    };\n\n    proto.restore = function () {\n        this._context.restore();\n        this._saveCount--;\n    };\n\n    proto.setGlobalAlpha = function (alpha) {\n        if (this._saveCount > 0) {\n            this._context.globalAlpha = alpha;\n        } else {\n            if (this._currentAlpha !== alpha) {\n                this._currentAlpha = alpha;\n                this._context.globalAlpha = alpha;\n            }\n        }\n    };\n\n    proto.setCompositeOperation = function (compositionOperation) {\n        if (this._saveCount > 0) {\n            this._context.globalCompositeOperation = compositionOperation;\n        } else {\n            if (this._currentCompositeOperation !== compositionOperation) {\n                this._currentCompositeOperation = compositionOperation;\n                this._context.globalCompositeOperation = compositionOperation;\n            }\n        }\n    };\n\n    proto.setFillStyle = function (fillStyle) {\n        if (this._saveCount > 0) {\n            this._context.fillStyle = fillStyle;\n        } else {\n            if (this._currentFillStyle !== fillStyle) {\n                this._currentFillStyle = fillStyle;\n                this._context.fillStyle = fillStyle;\n            }\n        }\n    };\n\n    proto.setStrokeStyle = function (strokeStyle) {\n        if (this._saveCount > 0) {\n            this._context.strokeStyle = strokeStyle;\n        } else {\n            if (this._currentStrokeStyle !== strokeStyle) {\n                this._currentStrokeStyle = strokeStyle;\n                this._context.strokeStyle = strokeStyle;\n            }\n        }\n    };\n\n    proto.setTransform = function (t, scaleX, scaleY) {\n        if (this._armatureMode > 0) {\n            //ugly for armature\n            this.restore();\n            this.save();\n            this._context.transform(t.a * scaleX, -t.b * scaleY, -t.c * scaleX, t.d * scaleY, t.tx * scaleX, -(t.ty * scaleY));\n        } else {\n            this._context.setTransform(t.a * scaleX, -t.b * scaleY, -t.c * scaleX, t.d * scaleY, this._offsetX + t.tx * scaleX, this._realOffsetY - (t.ty * scaleY));\n        }\n    };\n\n    proto._switchToArmatureMode = function (enable, t, scaleX, scaleY) {\n        if (enable) {\n            this._armatureMode++;\n            this._context.setTransform(t.a, t.c, t.b, t.d, this._offsetX + t.tx * scaleX, this._realOffsetY - (t.ty * scaleY));\n            this.save();\n        } else {\n            this._armatureMode--;\n            this.restore();\n        }\n    };\n})();\n\n"]}