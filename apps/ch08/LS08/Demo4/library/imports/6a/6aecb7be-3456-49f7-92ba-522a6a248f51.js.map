{"version":3,"sources":["../../../../../../../../assets/frameworks/cocos2d-html5/external/gaf/Library/assets/frameworks/cocos2d-html5/external/gaf/Library/GAFSpriteCanvasRenderCmd.js"],"names":["gaf","Sprite","CanvasRenderCmd","renderable","cc","call","_hasTintMult","_hasTintOffset","_hasCtx","_tintMult","color","_tintOffset","_textureDirty","proto","prototype","Object","create","constructor","_disableCtx","setDirtyFlag","Node","_dirtyFlags","colorDirty","_enableCtx","_applyCtxState","gafObject","tintMult","_cascadeColorMult","tintOffset","_cascadeColorOffset","opacity","a","_node","getOpacity","setOpacity","multDirty","colorEqual","setColor","r","g","b","offfsetDirty","_filterStack","length","type","EFFECT_COLOR_MATRIX","rendering","ctx","scaleX","scaleY","node","locTextureCoord","_textureCoord","alpha","_displayedOpacity","_texture","width","height","_textureLoaded","wrapper","_renderContext","context","getContext","locX","_offsetPosition","x","locHeight","_rect","locWidth","locY","y","image","setTransform","_worldTransform","setCompositeOperation","_blendFuncStr","setGlobalAlpha","_flippedX","_flippedY","save","scale","_htmlElementObj","_colorized","drawImage","renderX","renderY","restore","g_NumberOfDraws","sys","_supportCanvasNewBlendModes","_updateColor","displayedColor","_displayedColor","texture","_originalTexture","locElement","locTexture","locRect","validRect","getHtmlElementObj","_generateTintImageWithMultiply","Texture2D","initWithElement","handleLoadedTexture","cacheTextureForColor","textureCache","getTextureColors","texRect","rect","_gafGenerateTintImage","tintedImgCache","renderCanvas","w","Math","min","h","buff","document","createElement","clearRect","globalCompositeOperation","fillStyle","round","fillRect"],"mappings":";;;;;;AACA,CAAC,YAAW;AACRA,QAAIC,MAAJ,CAAWC,eAAX,GAA6B,UAAUC,UAAV,EAAsB;AAC/CC,WAAGH,MAAH,CAAUC,eAAV,CAA0BG,IAA1B,CAA+B,IAA/B,EAAqCF,UAArC;AACA,aAAKG,YAAL,GAAoB,KAApB;AACA,aAAKC,cAAL,GAAsB,KAAtB;AACA,aAAKC,OAAL,GAAe,KAAf;AACA,aAAKC,SAAL,GAAiBL,GAAGM,KAAH,CAAS,GAAT,EAAa,GAAb,EAAiB,GAAjB,EAAqB,GAArB,CAAjB;AACA,aAAKC,WAAL,GAAmBP,GAAGM,KAAH,CAAS,CAAT,EAAW,CAAX,EAAa,CAAb,EAAe,CAAf,CAAnB;AACA,aAAKE,aAAL,GAAqB,KAArB;AACH,KARD;AASA,QAAIC,QAAQb,IAAIC,MAAJ,CAAWC,eAAX,CAA2BY,SAA3B,GAAuCC,OAAOC,MAAP,CAAcZ,GAAGH,MAAH,CAAUC,eAAV,CAA0BY,SAAxC,CAAnD;AACAD,UAAMI,WAAN,GAAoBjB,IAAIC,MAAJ,CAAWC,eAA/B;;AAEAW,UAAMK,WAAN,GAAoB,YAAU;AAC1B,aAAKX,cAAL,GAAsB,KAAtB;AACA,aAAKC,OAAL,GAAe,KAAf;AACA,aAAKI,aAAL,GAAqB,IAArB;AACA,aAAKO,YAAL,CAAkBf,GAAGgB,IAAH,CAAQC,WAAR,CAAoBC,UAAtC;AACA,aAAKb,SAAL,GAAiBL,GAAGM,KAAH,CAAS,GAAT,EAAa,GAAb,EAAiB,GAAjB,EAAqB,GAArB,CAAjB;AACA,aAAKC,WAAL,GAAmBP,GAAGM,KAAH,CAAS,CAAT,EAAW,CAAX,EAAa,CAAb,EAAe,CAAf,CAAnB;AACH,KAPD;;AASAG,UAAMU,UAAN,GAAmB,YAAU,CAE5B,CAFD;;AAIAV,UAAMW,cAAN,GAAuB,UAASC,SAAT,EAAmB;;AAEtC,YAAIC,WAAWD,UAAUE,iBAAzB;AACA,YAAIC,aAAaH,UAAUI,mBAA3B;AACA,YAAIC,UAAUJ,SAASK,CAAvB;;AAEA;AACA,YAAG,KAAKC,KAAL,CAAWC,UAAX,MAA2BH,OAA9B,EACA;AACI,iBAAKE,KAAL,CAAWE,UAAX,CAAsBJ,OAAtB;AACH;;AAED;AACA,YAAIK,YAAY,CAAC/B,GAAGgC,UAAH,CAAc,KAAK3B,SAAnB,EAA8BiB,QAA9B,CAAjB;AACA,YAAGS,SAAH,EACA;AACI,iBAAKH,KAAL,CAAWK,QAAX,CAAoBX,QAApB;AACA,iBAAKjB,SAAL,GAAiBiB,QAAjB;AACA,iBAAKpB,YAAL,GACKoB,SAASY,CAAT,KAAe,GAAf,IACAZ,SAASa,CAAT,KAAe,GADf,IAEAb,SAASc,CAAT,KAAe,GAHpB;AAIH;;AAED;AACA,YAAIC,eACC,KAAK9B,WAAL,CAAiB2B,CAAjB,IAAsBV,WAAWU,CAAlC,IACC,KAAK3B,WAAL,CAAiB4B,CAAjB,IAAsBX,WAAWW,CADlC,IAEC,KAAK5B,WAAL,CAAiB6B,CAAjB,IAAsBZ,WAAWY,CAFlC,IAGC,KAAK7B,WAAL,CAAiBoB,CAAjB,IAAsBH,WAAWG,CAJtC;;AAMA,YAAGU,YAAH,EACA;AACI,iBAAK9B,WAAL,GAAmBiB,UAAnB;AACA,iBAAKrB,cAAL,GACKqB,WAAWU,CAAX,KAAiB,CAAjB,IACAV,WAAWW,CAAX,KAAiB,CADjB,IAEAX,WAAWY,CAAX,KAAiB,CAFjB,IAGAZ,WAAWG,CAAX,KAAiB,CAJtB;AAKH;;AAED;AACA,aAAKnB,aAAL,GAAqBuB,aAAaM,YAAlC;AACA,YAAG,KAAK7B,aAAR,EACA;AACI,iBAAKO,YAAL,CAAkBf,GAAGgB,IAAH,CAAQC,WAAR,CAAoBC,UAAtC;AACH;;AAGD,aAAKd,OAAL,GAAeiB,UAAUiB,YAAV,CAAuBC,MAAvB,GAAgC,CAAhC,IAAqClB,UAAUiB,YAAV,CAAuB,CAAvB,EAA0BE,IAA1B,KAAmC5C,IAAI6C,mBAA3F;AAEH,KAnDD;;AAqDAhC,UAAMiC,SAAN,GAAkB,UAASC,GAAT,EAAcC,MAAd,EAAsBC,MAAtB,EAClB;AACI,YAAIC,OAAO,KAAKlB,KAAhB;AACA,YAAImB,kBAAkB,KAAKC,aAA3B;AAAA,YACIC,QAAS,KAAKC,iBAAL,GAAyB,GADtC;;AAGA,YAAKJ,KAAKK,QAAL,KAAmBJ,gBAAgBK,KAAhB,KAA0B,CAA1B,IAA+BL,gBAAgBM,MAAhB,KAA2B,CAA3D,IAAyE;AACzF,SAACP,KAAKK,QAAL,CAAcG,cADjB,CAAD,IACsCL,UAAU,CADpD,EAEI;;AAEJ,YAAIM,UAAUZ,OAAO3C,GAAGwD,cAAxB;AAAA,YACIC,UAAUF,QAAQG,UAAR,EADd;AAEA,YAAIC,OAAOb,KAAKc,eAAL,CAAqBC,CAAhC;AAAA,YACIC,YAAYhB,KAAKiB,KAAL,CAAWV,MAD3B;AAAA,YAEIW,WAAWlB,KAAKiB,KAAL,CAAWX,KAF1B;AAAA,YAGIa,OAAO,CAACnB,KAAKc,eAAL,CAAqBM,CAAtB,GAA0BJ,SAHrC;AAAA,YAIIK,KAJJ;;AAMAZ,gBAAQa,YAAR,CAAqB,KAAKC,eAA1B,EAA2CzB,MAA3C,EAAmDC,MAAnD;AACAU,gBAAQe,qBAAR,CAA8B,KAAKC,aAAnC;AACAhB,gBAAQiB,cAAR,CAAuBvB,KAAvB;;AAEA,YAAGH,KAAK2B,SAAL,IAAkB3B,KAAK4B,SAA1B,EACInB,QAAQoB,IAAR;AACJ,YAAI7B,KAAK2B,SAAT,EAAoB;AAChBd,mBAAO,CAACA,IAAD,GAAQK,QAAf;AACAP,oBAAQmB,KAAR,CAAc,CAAC,CAAf,EAAkB,CAAlB;AACH;AACD,YAAI9B,KAAK4B,SAAT,EAAoB;AAChBT,mBAAOnB,KAAKc,eAAL,CAAqBM,CAA5B;AACAT,oBAAQmB,KAAR,CAAc,CAAd,EAAiB,CAAC,CAAlB;AACH;;AAEDT,gBAAQrB,KAAKK,QAAL,CAAc0B,eAAtB;;AAEA,YAAI,KAAKC,UAAT,EAAqB;AACjBrB,oBAAQsB,SAAR,CAAkBZ,KAAlB,EACI,CADJ,EACO,CADP,EACUpB,gBAAgBK,KAD1B,EACgCL,gBAAgBM,MADhD,EAEIM,OAAOf,MAFX,EAEkBqB,OAAOpB,MAFzB,EAEiCmB,WAAWpB,MAF5C,EAEoDkB,YAAYjB,MAFhE;AAGH,SAJD,MAIO;AACHY,oBAAQsB,SAAR,CAAkBZ,KAAlB,EACIpB,gBAAgBiC,OADpB,EAC6BjC,gBAAgBkC,OAD7C,EACsDlC,gBAAgBK,KADtE,EAC6EL,gBAAgBM,MAD7F,EAEIM,OAAOf,MAFX,EAEmBqB,OAAOpB,MAF1B,EAEkCmB,WAAWpB,MAF7C,EAEqDkB,YAAYjB,MAFjE;AAGH;;AAED,YAAGC,KAAK2B,SAAL,IAAkB3B,KAAK4B,SAA1B,EACInB,QAAQ2B,OAAR;AACJlF,WAAGmF,eAAH;AACH,KAhDD;;AAkDA,QAAGnF,GAAGoF,GAAH,CAAOC,2BAAV,EAAsC;AAClC5E,cAAM6E,YAAN,GAAqB,YAAY;AAC7B,gBAAIC,iBAAiB,KAAKC,eAA1B;AAAA,gBAA2C1C,OAAO,KAAKlB,KAAvD;AACA,iBAAK1B,YAAL,IAAsBqF,eAAerD,CAAf,KAAqB,GAArB,IAA4BqD,eAAepD,CAAf,KAAqB,GAAjD,IAAwDoD,eAAenD,CAAf,KAAqB,GAAnG;;AAEA;AACA,gBAAG,KAAK5B,aAAR,EACA;AACI,qBAAKA,aAAL,GAAqB,KAArB;AACA,oBAAI,KAAKsE,UAAT,EAAqB;AACjB,yBAAKA,UAAL,GAAkB,KAAlB;AACAhC,yBAAK2C,OAAL,GAAe,KAAKC,gBAApB;AACH;AACJ,aAPD,MASA;AACI;AACH;;AAED,gBAAIC,UAAJ;AAAA,gBAAgBC,aAAa9C,KAAKK,QAAlC;AAAA,gBAA4C0C,UAAU,KAAK7C,aAA3D;AACA,gBAAG,KAAK9C,YAAR,EACA;AACI,oBAAI0F,cAAcC,QAAQC,SAAtB,IAAmC,KAAKJ,gBAA5C,EAA8D;AAC1DC,iCAAaC,WAAWG,iBAAX,EAAb;AACA,wBAAI,CAACJ,UAAL,EACI;;AAEJ,yBAAKb,UAAL,GAAkB,IAAlB;AACA,wBAAI,KAAK3E,cAAL,IAAuB,KAAKC,OAAhC,EAAyCmF,iBAAiB,KAAKlF,SAAtB;;AAEzCsF,iCAAa3F,GAAGH,MAAH,CAAUC,eAAV,CAA0BkG,8BAA1B,CAAyD,KAAKN,gBAAL,CAAsBb,eAA/E,EAAgGU,cAAhG,EAAgHM,OAAhH,CAAb;AACAD,iCAAa,IAAI5F,GAAGiG,SAAP,EAAb;AACAL,+BAAWM,eAAX,CAA2BP,UAA3B;AACAC,+BAAWO,mBAAX;AACArD,yBAAK2C,OAAL,GAAeG,UAAf;AACH;AACJ;;AAEDA,yBAAa9C,KAAKK,QAAlB;AACA,gBAAG,KAAKhD,cAAR,EACA;AACI,oBAAIiG,uBAAuBpG,GAAGqG,YAAH,CAAgBC,gBAAhB,CAAiC,KAAKZ,gBAAL,CAAsBK,iBAAtB,EAAjC,CAA3B;AACA,oBAAIH,cAAcC,QAAQC,SAAtB,IAAmC,KAAKJ,gBAA5C,EAA8D;AAC1DC,iCAAaC,WAAWG,iBAAX,EAAb;AACA,wBAAI,CAACJ,UAAL,EACI;AACJ,wBAAG,KAAKb,UAAR,EACI,IAAIyB,UAAUvG,GAAGwG,IAAH,CAAQ,CAAR,EAAU,CAAV,EAAYX,QAAQzC,KAApB,EAA2ByC,QAAQxC,MAAnC,CAAd,CADJ,KAGIkD,UAAUV,OAAV;AACJF,iCAAa,KAAKc,qBAAL,CAA2B3D,KAAK2C,OAAL,CAAaZ,eAAxC,EAAyD0B,OAAzD,EAAkEH,oBAAlE,EAAwF,KAAK7F,WAA7F,EAA0GsF,OAA1G,CAAb;AACAD,iCAAa,IAAI5F,GAAGiG,SAAP,EAAb;AACAL,+BAAWM,eAAX,CAA2BP,UAA3B;AACAC,+BAAWO,mBAAX;AACArD,yBAAK2C,OAAL,GAAeG,UAAf;AACA,yBAAKd,UAAL,GAAkB,IAAlB;AACH;AACJ;AAGJ,SA3DD;;AA6DArE,cAAMgG,qBAAN,GAA8B,UAAShB,OAAT,EAAkBc,OAAlB,EAA2BG,cAA3B,EAA2CpG,KAA3C,EAAkDkG,IAAlD,EAAwDG,YAAxD,EAAqE;AAC/F,gBAAI,CAACH,IAAL,EACIA,OAAOxG,GAAGwG,IAAH,CAAQ,CAAR,EAAW,CAAX,EAAcf,QAAQrC,KAAtB,EAA6BqC,QAAQpC,MAArC,CAAP;;AAEJ;AACA,gBAAIuD,IAAIC,KAAKC,GAAL,CAASN,KAAKpD,KAAd,EAAqBsD,eAAe,CAAf,EAAkBtD,KAAvC,CAAR;AACA,gBAAI2D,IAAIF,KAAKC,GAAL,CAASN,KAAKnD,MAAd,EAAsBqD,eAAe,CAAf,EAAkBrD,MAAxC,CAAR;AACA,gBAAI2D,OAAOL,YAAX;AAAA,gBAAyBhE,GAAzB;AACA,gBAAI,CAACqE,IAAL,EAAW;AACPA,uBAAOC,SAASC,aAAT,CAAuB,QAAvB,CAAP;AACAF,qBAAK5D,KAAL,GAAawD,CAAb;AACAI,qBAAK3D,MAAL,GAAc0D,CAAd;AACApE,sBAAMqE,KAAKtD,UAAL,CAAgB,IAAhB,CAAN;AACH,aALD,MAKO;AACHf,sBAAMqE,KAAKtD,UAAL,CAAgB,IAAhB,CAAN;AACAf,oBAAIwE,SAAJ,CAAc,CAAd,EAAiB,CAAjB,EAAoBP,CAApB,EAAuBG,CAAvB;AACH;AACDpE,gBAAIgC,IAAJ;;AAEA;AACAhC,gBAAIyE,wBAAJ,GAA+B,aAA/B;AACA;AACAzE,gBAAIoC,SAAJ,CAAc2B,eAAe,CAAf,CAAd,EAAiCF,KAAK3C,CAAtC,EAAyC2C,KAAKtC,CAA9C,EAAiD0C,CAAjD,EAAoDG,CAApD,EAAuD,CAAvD,EAA0D,CAA1D,EAA6DH,CAA7D,EAAgEG,CAAhE;;AAEA;AACApE,gBAAIyE,wBAAJ,GAA+B,WAA/B;AACAzE,gBAAI0E,SAAJ,GAAgB,UAAUR,KAAKS,KAAL,CAAWhH,MAAM4B,CAAjB,CAAV,GAAgC,GAAhC,GAAsC2E,KAAKS,KAAL,CAAWhH,MAAM6B,CAAjB,CAAtC,GAA4D,GAA5D,GAAkE0E,KAAKS,KAAL,CAAWhH,MAAM8B,CAAjB,CAAlE,GAAwF,KAAxG;AACAO,gBAAI4E,QAAJ,CAAa,CAAb,EAAgB,CAAhB,EAAmBX,CAAnB,EAAsBG,CAAtB;;AAEA;AACApE,gBAAIyE,wBAAJ,GAA+B,SAA/B;AACAzE,gBAAIoC,SAAJ,CAAcU,OAAd,EAAuBc,QAAQ1C,CAA/B,EAAkC0C,QAAQrC,CAA1C,EAA6C0C,CAA7C,EAAgDG,CAAhD,EAAmD,CAAnD,EAAsD,CAAtD,EAAyDH,CAAzD,EAA4DG,CAA5D;;AAGApE,gBAAIuC,OAAJ;AACA,mBAAO8B,IAAP;AAEH,SArCD;AAsCH;AAEJ,CAvOD","file":"GAFSpriteCanvasRenderCmd.js","sourceRoot":"../../../../../../../../assets/frameworks/cocos2d-html5/external/gaf/Library","sourcesContent":["\n(function() {\n    gaf.Sprite.CanvasRenderCmd = function (renderable) {\n        cc.Sprite.CanvasRenderCmd.call(this, renderable);\n        this._hasTintMult = false;\n        this._hasTintOffset = false;\n        this._hasCtx = false;\n        this._tintMult = cc.color(255,255,255,255);\n        this._tintOffset = cc.color(0,0,0,0);\n        this._textureDirty = false;\n    };\n    var proto = gaf.Sprite.CanvasRenderCmd.prototype = Object.create(cc.Sprite.CanvasRenderCmd.prototype);\n    proto.constructor = gaf.Sprite.CanvasRenderCmd;\n\n    proto._disableCtx = function(){\n        this._hasTintOffset = false;\n        this._hasCtx = false;\n        this._textureDirty = true;\n        this.setDirtyFlag(cc.Node._dirtyFlags.colorDirty);\n        this._tintMult = cc.color(255,255,255,255);\n        this._tintOffset = cc.color(0,0,0,0);\n    };\n\n    proto._enableCtx = function(){\n\n    };\n\n    proto._applyCtxState = function(gafObject){\n\n        var tintMult = gafObject._cascadeColorMult;\n        var tintOffset = gafObject._cascadeColorOffset;\n        var opacity = tintMult.a;\n\n        // Apply opacity\n        if(this._node.getOpacity() != opacity)\n        {\n            this._node.setOpacity(opacity);\n        }\n\n        // Check Tint multiplicator\n        var multDirty = !cc.colorEqual(this._tintMult, tintMult);\n        if(multDirty)\n        {\n            this._node.setColor(tintMult);\n            this._tintMult = tintMult;\n            this._hasTintMult =\n                (tintMult.r !== 255 ||\n                 tintMult.g !== 255 ||\n                 tintMult.b !== 255 );\n        }\n\n        // Check Tint offset\n        var offfsetDirty =\n            (this._tintOffset.r != tintOffset.r) ||\n            (this._tintOffset.g != tintOffset.g) ||\n            (this._tintOffset.b != tintOffset.b) ||\n            (this._tintOffset.a != tintOffset.a);\n\n        if(offfsetDirty)\n        {\n            this._tintOffset = tintOffset;\n            this._hasTintOffset =\n                (tintOffset.r !== 0 ||\n                 tintOffset.g !== 0 ||\n                 tintOffset.b !== 0 ||\n                 tintOffset.a !== 0 );\n        }\n\n        // Update dirty flag\n        this._textureDirty = multDirty || offfsetDirty;\n        if(this._textureDirty)\n        {\n            this.setDirtyFlag(cc.Node._dirtyFlags.colorDirty);\n        }\n\n\n        this._hasCtx = gafObject._filterStack.length > 0 && gafObject._filterStack[0].type === gaf.EFFECT_COLOR_MATRIX;\n\n    };\n\n    proto.rendering = function(ctx, scaleX, scaleY)\n    {\n        var node = this._node;\n        var locTextureCoord = this._textureCoord,\n            alpha = (this._displayedOpacity / 255);\n\n        if ((node._texture && ((locTextureCoord.width === 0 || locTextureCoord.height === 0)            //set texture but the texture isn't loaded.\n            || !node._texture._textureLoaded)) || alpha === 0)\n            return;\n\n        var wrapper = ctx || cc._renderContext,\n            context = wrapper.getContext();\n        var locX = node._offsetPosition.x,\n            locHeight = node._rect.height,\n            locWidth = node._rect.width,\n            locY = -node._offsetPosition.y - locHeight,\n            image;\n\n        wrapper.setTransform(this._worldTransform, scaleX, scaleY);\n        wrapper.setCompositeOperation(this._blendFuncStr);\n        wrapper.setGlobalAlpha(alpha);\n\n        if(node._flippedX || node._flippedY)\n            wrapper.save();\n        if (node._flippedX) {\n            locX = -locX - locWidth;\n            context.scale(-1, 1);\n        }\n        if (node._flippedY) {\n            locY = node._offsetPosition.y;\n            context.scale(1, -1);\n        }\n\n        image = node._texture._htmlElementObj;\n\n        if (this._colorized) {\n            context.drawImage(image,\n                0, 0, locTextureCoord.width,locTextureCoord.height,\n                locX * scaleX,locY * scaleY, locWidth * scaleX, locHeight * scaleY);\n        } else {\n            context.drawImage(image,\n                locTextureCoord.renderX, locTextureCoord.renderY, locTextureCoord.width, locTextureCoord.height,\n                locX * scaleX, locY * scaleY, locWidth * scaleX, locHeight * scaleY);\n        }\n\n        if(node._flippedX || node._flippedY)\n            wrapper.restore();\n        cc.g_NumberOfDraws++;\n    };\n\n    if(cc.sys._supportCanvasNewBlendModes){\n        proto._updateColor = function () {\n            var displayedColor = this._displayedColor, node = this._node;\n            this._hasTintMult |= (displayedColor.r !== 255 || displayedColor.g !== 255 || displayedColor.b !== 255);\n\n            // If no color changes\n            if(this._textureDirty)\n            {\n                this._textureDirty = false;\n                if (this._colorized) {\n                    this._colorized = false;\n                    node.texture = this._originalTexture;\n                }\n            }\n            else\n            {\n                return;\n            }\n\n            var locElement, locTexture = node._texture, locRect = this._textureCoord;\n            if(this._hasTintMult)\n            {\n                if (locTexture && locRect.validRect && this._originalTexture) {\n                    locElement = locTexture.getHtmlElementObj();\n                    if (!locElement)\n                        return;\n\n                    this._colorized = true;\n                    if (this._hasTintOffset || this._hasCtx) displayedColor = this._tintMult;\n\n                    locElement = cc.Sprite.CanvasRenderCmd._generateTintImageWithMultiply(this._originalTexture._htmlElementObj, displayedColor, locRect);\n                    locTexture = new cc.Texture2D();\n                    locTexture.initWithElement(locElement);\n                    locTexture.handleLoadedTexture();\n                    node.texture = locTexture;\n                }\n            }\n\n            locTexture = node._texture;\n            if(this._hasTintOffset)\n            {\n                var cacheTextureForColor = cc.textureCache.getTextureColors(this._originalTexture.getHtmlElementObj());\n                if (locTexture && locRect.validRect && this._originalTexture) {\n                    locElement = locTexture.getHtmlElementObj();\n                    if (!locElement)\n                        return;\n                    if(this._colorized)\n                        var texRect = cc.rect(0,0,locRect.width, locRect.height);\n                    else\n                        texRect = locRect;\n                    locElement = this._gafGenerateTintImage(node.texture._htmlElementObj, texRect, cacheTextureForColor, this._tintOffset, locRect);\n                    locTexture = new cc.Texture2D();\n                    locTexture.initWithElement(locElement);\n                    locTexture.handleLoadedTexture();\n                    node.texture = locTexture;\n                    this._colorized = true;\n                }\n            }\n\n\n        };\n\n        proto._gafGenerateTintImage = function(texture, texRect, tintedImgCache, color, rect, renderCanvas){\n            if (!rect)\n                rect = cc.rect(0, 0, texture.width, texture.height);\n\n            // Create a new buffer if required\n            var w = Math.min(rect.width, tintedImgCache[0].width);\n            var h = Math.min(rect.height, tintedImgCache[0].height);\n            var buff = renderCanvas, ctx;\n            if (!buff) {\n                buff = document.createElement(\"canvas\");\n                buff.width = w;\n                buff.height = h;\n                ctx = buff.getContext(\"2d\");\n            } else {\n                ctx = buff.getContext(\"2d\");\n                ctx.clearRect(0, 0, w, h);\n            }\n            ctx.save();\n\n            // draw a channel with alpha of the original image\n            ctx.globalCompositeOperation = 'source-over';\n            //ctx.globalAlpha = 1;\n            ctx.drawImage(tintedImgCache[2], rect.x, rect.y, w, h, 0, 0, w, h);\n\n            // draw a rect of specified color\n            ctx.globalCompositeOperation = 'source-in';\n            ctx.fillStyle = 'rgba(' + Math.round(color.r) + ',' + Math.round(color.g) + ',' + Math.round(color.b) + ',1)';\n            ctx.fillRect(0, 0, w, h);\n\n            // add the desired image to the drawn\n            ctx.globalCompositeOperation = 'lighter';\n            ctx.drawImage(texture, texRect.x, texRect.y, w, h, 0, 0, w, h);\n\n\n            ctx.restore();\n            return buff;\n\n        };\n    }\n\n})();\n"]}