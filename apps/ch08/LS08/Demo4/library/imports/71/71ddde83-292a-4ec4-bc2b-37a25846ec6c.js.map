{"version":3,"sources":["../../../../../../../../assets/frameworks/cocos2d-html5/extensions/ccui/layouts/assets/frameworks/cocos2d-html5/extensions/ccui/layouts/UILayoutWebGLRenderCmd.js"],"names":["ccui","ProtectedNode","WebGLRenderCmd","Layout","renderable","_pNodeCmdCtor","_needDraw","_currentStencilEnabled","_scissorOldState","_clippingOldRect","_mask_layer_le","_beforeVisitCmdStencil","_afterDrawStencilCmd","_afterVisitCmdStencil","_beforeVisitCmdScissor","_afterVisitCmdScissor","proto","prototype","Object","create","constructor","_layoutCmdCtor","CanvasRenderCmd","_syncStatus","parentCmd","_originSyncStatus","_dirtyFlag","cc","Node","_dirtyFlags","transformDirty","_node","_clippingRectDirty","_onBeforeVisitStencil","ctx","gl","_renderContext","_layer","mask_layer","mask_layer_l","isEnabled","STENCIL_TEST","clear","DEPTH_BUFFER_BIT","enable","depthMask","stencilFunc","NEVER","stencilOp","REPLACE","KEEP","stencilMask","STENCIL_BUFFER_BIT","_onAfterDrawStencil","EQUAL","_onAfterVisitStencil","mask_layer_le","disable","_onBeforeVisitScissor","clippingRect","_getClippingRect","SCISSOR_TEST","view","setScissorInPoints","x","y","width","height","getScissorRect","rectEqualToRect","_onAfterVisitScissor","_clippingRect","rebindStencilRendering","stencil","transform","recursive","node","pNodeTransform","_clippingStencil","_renderCmd","stencilClippingVisit","isVisible","stencilBits","_visit_once","log","CustomRenderCmd","renderer","pushRenderCommand","currentStack","current_stack","stack","push","top","_stackMatrix","visit","postStencilVisit","cmd","pop","scissorClippingVisit","postScissorVisit"],"mappings":"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","file":"UILayoutWebGLRenderCmd.js","sourceRoot":"../../../../../../../../assets/frameworks/cocos2d-html5/extensions/ccui/layouts","sourcesContent":["/****************************************************************************\n Copyright (c) 2011-2012 cocos2d-x.org\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\n(function () {\n    if (!ccui.ProtectedNode.WebGLRenderCmd)\n        return;\n    ccui.Layout.WebGLRenderCmd = function (renderable) {\n        this._pNodeCmdCtor(renderable);\n        this._needDraw = false;\n\n        this._currentStencilEnabled = 0;\n        this._scissorOldState = false;\n        this._clippingOldRect = null;\n\n        this._mask_layer_le = 0;\n\n        this._beforeVisitCmdStencil = null;\n        this._afterDrawStencilCmd = null;\n        this._afterVisitCmdStencil = null;\n        this._beforeVisitCmdScissor = null;\n        this._afterVisitCmdScissor = null;\n    };\n\n    var proto = ccui.Layout.WebGLRenderCmd.prototype = Object.create(ccui.ProtectedNode.WebGLRenderCmd.prototype);\n    proto.constructor = ccui.Layout.WebGLRenderCmd;\n    proto._layoutCmdCtor = ccui.Layout.CanvasRenderCmd;\n\n    proto._syncStatus = function (parentCmd) {\n        this._originSyncStatus(parentCmd);\n\n        if (parentCmd && (parentCmd._dirtyFlag & cc.Node._dirtyFlags.transformDirty))\n            this._node._clippingRectDirty = true;\n    };\n    \n    proto._onBeforeVisitStencil = function (ctx) {\n        var gl = ctx || cc._renderContext;\n\n        ccui.Layout.WebGLRenderCmd._layer++;\n\n        var mask_layer = 0x1 << ccui.Layout.WebGLRenderCmd._layer;\n        var mask_layer_l = mask_layer - 1;\n        this._mask_layer_le = mask_layer | mask_layer_l;\n\n        // manually save the stencil state\n        this._currentStencilEnabled = gl.isEnabled(gl.STENCIL_TEST);\n\n        gl.clear(gl.DEPTH_BUFFER_BIT);\n\n        gl.enable(gl.STENCIL_TEST);\n\n        gl.depthMask(false);\n\n        gl.stencilFunc(gl.NEVER, mask_layer, mask_layer);\n        gl.stencilOp(gl.REPLACE, gl.KEEP, gl.KEEP);\n\n        gl.stencilMask(mask_layer);\n        gl.clear(gl.STENCIL_BUFFER_BIT);\n    };\n\n    proto._onAfterDrawStencil = function (ctx) {\n        var gl = ctx || cc._renderContext;\n        gl.depthMask(true);\n        gl.stencilFunc(gl.EQUAL, this._mask_layer_le, this._mask_layer_le);\n        gl.stencilOp(gl.KEEP, gl.KEEP, gl.KEEP);\n    };\n\n    proto._onAfterVisitStencil = function (ctx) {\n        var gl = ctx || cc._renderContext;\n\n        ccui.Layout.WebGLRenderCmd._layer--;\n\n        if (this._currentStencilEnabled) {\n            var mask_layer = 0x1 << ccui.Layout.WebGLRenderCmd._layer;\n            var mask_layer_l = mask_layer - 1;\n            var mask_layer_le = mask_layer | mask_layer_l;\n\n            gl.stencilMask(mask_layer);\n            gl.stencilFunc(gl.EQUAL, mask_layer_le, mask_layer_le);\n        }\n        else {\n            gl.disable(gl.STENCIL_TEST);\n        }\n    };\n\n    proto._onBeforeVisitScissor = function (ctx) {\n        this._node._clippingRectDirty = true;\n        var clippingRect = this._node._getClippingRect();\n        var gl = ctx || cc._renderContext;\n\n        this._scissorOldState = gl.isEnabled(gl.SCISSOR_TEST);\n\n        if (!this._scissorOldState) {\n            gl.enable(gl.SCISSOR_TEST);\n            cc.view.setScissorInPoints(clippingRect.x, clippingRect.y, clippingRect.width, clippingRect.height);\n        }\n        else {\n            this._clippingOldRect = cc.view.getScissorRect();\n            if (!cc.rectEqualToRect(this._clippingOldRect, clippingRect))\n                cc.view.setScissorInPoints(clippingRect.x, clippingRect.y, clippingRect.width, clippingRect.height);\n        }\n    };\n\n    proto._onAfterVisitScissor = function (ctx) {\n        var gl = ctx || cc._renderContext;\n        if (this._scissorOldState) {\n            if (!cc.rectEqualToRect(this._clippingOldRect, this._node._clippingRect)) {\n                cc.view.setScissorInPoints(this._clippingOldRect.x,\n                    this._clippingOldRect.y,\n                    this._clippingOldRect.width,\n                    this._clippingOldRect.height);\n            }\n        }\n        else {\n            gl.disable(gl.SCISSOR_TEST);\n        }\n    };\n\n    proto.rebindStencilRendering = function (stencil) {\n    };\n\n    proto.transform = function (parentCmd, recursive) {\n        var node = this._node;\n        this.pNodeTransform(parentCmd, recursive);\n        if (node._clippingStencil)\n            node._clippingStencil._renderCmd.transform(this, recursive);\n    };\n\n    proto.stencilClippingVisit = function (parentCmd) {\n        var node = this._node;\n        if (!node._clippingStencil || !node._clippingStencil.isVisible())\n            return;\n\n        // all the _stencilBits are in use?\n        if (ccui.Layout.WebGLRenderCmd._layer + 1 === cc.stencilBits) {\n            // warn once\n            ccui.Layout.WebGLRenderCmd._visit_once = true;\n            if (ccui.Layout.WebGLRenderCmd._visit_once) {\n                cc.log(\"Nesting more than \" + cc.stencilBits + \"stencils is not supported. Everything will be drawn without stencil for this node and its childs.\");\n                ccui.Layout.WebGLRenderCmd._visit_once = false;\n            }\n            // draw everything, as if there where no stencil\n            return;\n        }\n\n        if (!this._beforeVisitCmdStencil) {\n            this._beforeVisitCmdStencil = new cc.CustomRenderCmd(this, this._onBeforeVisitStencil);\n            this._afterDrawStencilCmd = new cc.CustomRenderCmd(this, this._onAfterDrawStencil);\n            this._afterVisitCmdStencil = new cc.CustomRenderCmd(this, this._onAfterVisitStencil);\n        }\n\n        cc.renderer.pushRenderCommand(this._beforeVisitCmdStencil);\n\n        //optimize performance for javascript\n        var currentStack = cc.current_stack;\n        currentStack.stack.push(currentStack.top);\n        currentStack.top = this._stackMatrix;\n\n        node._clippingStencil.visit(this);\n\n        cc.renderer.pushRenderCommand(this._afterDrawStencilCmd);\n    };\n\n    proto.postStencilVisit = function () {\n        renderer.pushRenderCommand(cmd._afterVisitCmdStencil);\n        cc.current_stack.top = cc.current_stack.stack.pop();\n    };\n\n    proto.scissorClippingVisit = function (parentCmd) {\n        if (!this._beforeVisitCmdScissor) {\n            this._beforeVisitCmdScissor = new cc.CustomRenderCmd(this, this._onBeforeVisitScissor);\n            this._afterVisitCmdScissor = new cc.CustomRenderCmd(this, this._onAfterVisitScissor);\n        }\n        cc.renderer.pushRenderCommand(this._beforeVisitCmdScissor);\n    };\n\n    proto.postScissorVisit = function () {\n        cc.renderer.pushRenderCommand(this._afterVisitCmdScissor);\n    };\n\n    ccui.Layout.WebGLRenderCmd._layer = -1;\n    ccui.Layout.WebGLRenderCmd._visit_once = null;\n})();\n"]}