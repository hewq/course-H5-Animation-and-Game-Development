{"version":3,"sources":["../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/tilemap/assets/frameworks/cocos2d-html5/cocos2d/tilemap/CCTMXLayerWebGLRenderCmd.js"],"names":["cc","TMXLayer","WebGLRenderCmd","renderableObject","_rootCtor","_needDraw","_vertices","x","y","_color","Uint32Array","_shaderProgram","shaderCache","programForKey","SHADER_SPRITE_POSITION_TEXTURECOLORALPHATEST","radian","Math","PI","_sin90","sin","_cos90","cos","_sin270","_cos270","proto","prototype","Object","create","Node","constructor","uploadData","f32buffer","ui32buffer","vertexDataOffset","node","_node","hasRotation","_rotationX","_rotationY","layerOrientation","tiles","scalex","view","_scaleX","scaley","_scaleY","maptw","_mapTileSize","width","mapth","height","tilew","tileset","_tileSize","director","_contentScaleFactor","tileh","extw","exth","winw","winSize","winh","rows","_layerSize","cols","grids","_texGrids","spTiles","_spriteTiles","wt","_worldTransform","a","b","c","d","tx","ty","ox","_contentSize","_anchorPoint","oy","mapx","mapy","opacity","_opacity","cr","_displayedColor","r","cg","g","cb","_opacityModifyRGB","ca","startCol","startRow","maxCol","maxRow","TMX_ORIENTATION_ORTHO","floor","ceil","row","col","offset","colOffset","z","gid","grid","mask","TMX_TILE_FLIPPED_MASK","i","top","left","bottom","right","w","h","gt","gl","gb","gr","wa","wb","wc","wd","wtx","wty","flagged","flippedX","flippedY","vertices","length","renderer","_increaseBatchingSize","_batchRendering","_vertexZ","assignedZStep","TMX_ORIENTATION_ISO","TMX_ORIENTATION_HEX","TMX_TILE_DIAGONAL_FLAG","TMX_TILE_HORIZONTAL_FLAG","TMX_TILE_VERTICAL_FLAG","l","t"],"mappings":"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","file":"CCTMXLayerWebGLRenderCmd.js","sourceRoot":"../../../../../../../assets/frameworks/cocos2d-html5/cocos2d/tilemap","sourcesContent":["/****************************************************************************\n Copyright (c) 2013-2014 Chukong Technologies Inc.\n\n http://www.cocos2d-x.org\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n\n(function () {\n    cc.TMXLayer.WebGLRenderCmd = function (renderableObject) {\n        this._rootCtor(renderableObject);\n        this._needDraw = true;\n        this._vertices = [\n            {x: 0, y: 0},\n            {x: 0, y: 0},\n            {x: 0, y: 0},\n            {x: 0, y: 0}\n        ];\n        this._color = new Uint32Array(1);\n        this._shaderProgram = cc.shaderCache.programForKey(cc.SHADER_SPRITE_POSITION_TEXTURECOLORALPHATEST);\n\n        var radian = Math.PI * 90 / 180;\n        this._sin90 = Math.sin(radian);\n        this._cos90 = Math.cos(radian);\n        radian = radian * 3;\n        this._sin270 = Math.sin(radian);\n        this._cos270 = Math.cos(radian);\n    };\n\n    var proto = cc.TMXLayer.WebGLRenderCmd.prototype = Object.create(cc.Node.WebGLRenderCmd.prototype);\n    proto.constructor = cc.TMXLayer.WebGLRenderCmd;\n\n    proto.uploadData = function (f32buffer, ui32buffer, vertexDataOffset) {\n        var node = this._node, hasRotation = (node._rotationX || node._rotationY),\n            layerOrientation = node.layerOrientation,\n            tiles = node.tiles;\n\n        if (!tiles) {\n            return 0;\n        }\n\n        var scalex = cc.view._scaleX,\n            scaley = cc.view._scaleY,\n            maptw = node._mapTileSize.width,\n            mapth = node._mapTileSize.height,\n            tilew = node.tileset._tileSize.width / cc.director._contentScaleFactor,\n            tileh = node.tileset._tileSize.height / cc.director._contentScaleFactor,\n            extw = tilew - maptw,\n            exth = tileh - mapth,\n            winw = cc.winSize.width,\n            winh = cc.winSize.height,\n            rows = node._layerSize.height,\n            cols = node._layerSize.width,\n            grids = node._texGrids,\n            spTiles = node._spriteTiles,\n            wt = this._worldTransform,\n            a = wt.a, b = wt.b, c = wt.c, d = wt.d, tx = wt.tx, ty = wt.ty,\n            ox = -node._contentSize.width * node._anchorPoint.x,\n            oy = -node._contentSize.height * node._anchorPoint.y,\n            mapx = ox * a + oy * c + tx,\n            mapy = ox * b + oy * d + ty;\n\n        var opacity = node._opacity,\n            cr = this._displayedColor.r,\n            cg = this._displayedColor.g,\n            cb = this._displayedColor.b;\n        if (node._opacityModifyRGB) {\n            var ca = opacity / 255;\n            cr *= ca;\n            cg *= ca;\n            cb *= ca;\n        }\n        this._color[0] = ((opacity << 24) | (cb << 16) | (cg << 8) | cr);\n\n        // Culling\n        var startCol = 0, startRow = 0,\n            maxCol = cols, maxRow = rows;\n        if (!hasRotation && layerOrientation === cc.TMX_ORIENTATION_ORTHO) {\n            startCol = Math.floor(-(mapx - extw * a) / (maptw * a));\n            startRow = Math.floor((mapy - exth * d + mapth * rows * d - winh) / (mapth * d));\n            maxCol = Math.ceil((winw - mapx + extw * a) / (maptw * a));\n            maxRow = rows - Math.floor(-(mapy + exth * d) / (mapth * d));\n            // Adjustment\n            if (startCol < 0) startCol = 0;\n            if (startRow < 0) startRow = 0;\n            if (maxCol > cols) maxCol = cols;\n            if (maxRow > rows) maxRow = rows;\n        }\n\n        var row, col,\n            offset = vertexDataOffset,\n            colOffset = startRow * cols, z, gid, grid,\n            mask = cc.TMX_TILE_FLIPPED_MASK,\n            i, top, left, bottom, right,\n            w = tilew * a, h = tileh * d, gt, gl, gb, gr,\n            wa = a, wb = b, wc = c, wd = d, wtx = tx, wty = ty, // world\n            flagged = false, flippedX = false, flippedY = false,\n            vertices = this._vertices;\n        for (row = startRow; row < maxRow; ++row) {\n            for (col = startCol; col < maxCol; ++col) {\n                // No more buffer\n                if (offset + 24 > f32buffer.length) {\n                    cc.renderer._increaseBatchingSize((offset - vertexDataOffset) / 6);\n                    cc.renderer._batchRendering();\n                    vertexDataOffset = 0;\n                    offset = 0;\n                }\n\n                z = colOffset + col;\n                // Skip sprite tiles\n                if (spTiles[z]) {\n                    continue;\n                }\n\n                gid = node.tiles[z];\n                grid = grids[(gid & mask) >>> 0];\n                if (!grid) {\n                    continue;\n                }\n\n                // Vertices\n                switch (layerOrientation) {\n                case cc.TMX_ORIENTATION_ORTHO:\n                    left = col * maptw;\n                    bottom = (rows - row - 1) * mapth;\n                    z = node._vertexZ + cc.renderer.assignedZStep * z / tiles.length;\n                    break;\n                case cc.TMX_ORIENTATION_ISO:\n                    left = maptw / 2 * ( cols + col - row - 1);\n                    bottom = mapth / 2 * ( rows * 2 - col - row - 2);\n                    z = node._vertexZ + cc.renderer.assignedZStep * (node.height - bottom) / node.height;\n                    break;\n                case cc.TMX_ORIENTATION_HEX:\n                    left = col * maptw * 3 / 4;\n                    bottom = (rows - row - 1) * mapth + ((col % 2 === 1) ? (-mapth / 2) : 0);\n                    z = node._vertexZ + cc.renderer.assignedZStep * (node.height - bottom) / node.height;\n                    break;\n                }\n                right = left + tilew;\n                top = bottom + tileh;\n                // TMX_ORIENTATION_ISO trim\n                if (!hasRotation && layerOrientation === cc.TMX_ORIENTATION_ISO) {\n                    gb = mapy + bottom * d;\n                    if (gb > winh + h) {\n                        col += Math.floor((gb - winh) * 2 / h) - 1;\n                        continue;\n                    }\n                    gr = mapx + right * a;\n                    if (gr < -w) {\n                        col += Math.floor((-gr) * 2 / w) - 1;\n                        continue;\n                    }\n                    gl = mapx + left * a;\n                    gt = mapy + top * d;\n                    if (gl > winw || gt < 0) {\n                        col = maxCol;\n                        continue;\n                    }\n                }\n                // Rotation and Flip\n                if (gid > cc.TMX_TILE_DIAGONAL_FLAG) {\n                    flagged = true;\n                    flippedX = (gid & cc.TMX_TILE_HORIZONTAL_FLAG) >>> 0;\n                    flippedY = (gid & cc.TMX_TILE_VERTICAL_FLAG) >>> 0;\n                    // if ((gid & cc.TMX_TILE_DIAGONAL_FLAG) >>> 0) {\n                    //     var flag = (gid & (cc.TMX_TILE_HORIZONTAL_FLAG | cc.TMX_TILE_VERTICAL_FLAG) >>> 0) >>> 0;\n                    //     // handle the 4 diagonally flipped states.\n                    //     var la, lb, lc, ld;\n                    //     if (flag === cc.TMX_TILE_HORIZONTAL_FLAG || flag === (cc.TMX_TILE_VERTICAL_FLAG | cc.TMX_TILE_HORIZONTAL_FLAG) >>> 0) {\n                    //         lb = -(lc = this._sin90);\n                    //         la = ld = this._cos90;\n                    //     }\n                    //     else {\n                    //         lb = -(lc = this._sin270);\n                    //         la = ld = this._cos270;\n                    //     }\n                    //     left += grid.width * scalex / 2;\n                    //     bottom += grid.height * scaley / 2;\n                    //     wa = la * a + lb * c;\n                    //     wb = la * b + lb * d;\n                    //     wc = lc * a + ld * c;\n                    //     wd = lc * b + ld * d;\n                    //     wtx = a * left + c * bottom + tx;\n                    //     wty = d * bottom + ty + b * left;\n                    //     right = right - left;\n                    //     top = top - bottom;\n                    //     left = -right;\n                    //     bottom = -top;\n                    // }\n                }\n\n                vertices[0].x = left * wa + top * wc + wtx; // tl\n                vertices[0].y = left * wb + top * wd + wty;\n                vertices[1].x = left * wa + bottom * wc + wtx; // bl\n                vertices[1].y = left * wb + bottom * wd + wty;\n                vertices[2].x = right * wa + top * wc + wtx; // tr\n                vertices[2].y = right * wb + top * wd + wty;\n                vertices[3].x = right * wa + bottom * wc + wtx; // br\n                vertices[3].y = right * wb + bottom * wd + wty;\n\n                for (i = 0; i < 4; ++i) {\n                    f32buffer[offset] = vertices[i].x;\n                    f32buffer[offset + 1] = vertices[i].y;\n                    f32buffer[offset + 2] = z;\n                    ui32buffer[offset + 3] = this._color[0];\n                    switch (i) {\n                    case 0: // tl\n                        f32buffer[offset + 4] = flippedX ? grid.r : grid.l;\n                        f32buffer[offset + 5] = flippedY ? grid.b : grid.t;\n                        break;\n                    case 1: // bl\n                        f32buffer[offset + 4] = flippedX ? grid.r : grid.l;\n                        f32buffer[offset + 5] = flippedY ? grid.t : grid.b;\n                        break;\n                    case 2: // tr\n                        f32buffer[offset + 4] = flippedX ? grid.l : grid.r;\n                        f32buffer[offset + 5] = flippedY ? grid.b : grid.t;\n                        break;\n                    case 3: // br\n                        f32buffer[offset + 4] = flippedX ? grid.l : grid.r;\n                        f32buffer[offset + 5] = flippedY ? grid.t : grid.b;\n                        break;\n                    }\n\n                    offset += 6;\n                }\n                if (flagged) {\n                    wa = a;\n                    wb = b;\n                    wc = c;\n                    wd = d;\n                    wtx = tx;\n                    wty = ty;\n                    flippedX = false;\n                    flippedY = false;\n                    flagged = false;\n                }\n            }\n            colOffset += cols;\n        }\n        return (offset - vertexDataOffset) / 6;\n    };\n})();\n"]}